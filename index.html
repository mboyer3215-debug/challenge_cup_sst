<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chasse au Tr√©sor SST - Multijoueur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');

        * {
            font-family: 'Poppins', sans-serif;
        }

        @keyframes bounce-in {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            75% { transform: translateX(10px) rotate(5deg); }
        }

        @keyframes unlock {
            0% { transform: translateY(0); }
            50% { transform: translateY(-20px) rotate(20deg); }
            100% { transform: translateY(-40px) rotate(40deg); opacity: 0; }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(93, 92, 222, 0.5); }
            50% { box-shadow: 0 0 40px rgba(93, 92, 222, 0.8), 0 0 60px rgba(93, 92, 222, 0.6); }
        }

        @keyframes progress-fill {
            from { height: 0%; }
            to { height: var(--target-height); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .bounce-in { animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .shake { animation: shake 0.5s ease-in-out; }
        .unlock { animation: unlock 0.8s ease-out forwards; }
        .confetti { animation: confetti-fall 3s linear; }
        .float { animation: float 3s ease-in-out infinite; }
        .glow { animation: glow 2s ease-in-out infinite; }
        .pulse-anim { animation: pulse 1s ease-in-out infinite; }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-morphism {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(93, 92, 222, 0.8),
                         0 0 20px rgba(93, 92, 222, 0.6),
                         0 0 30px rgba(93, 92, 222, 0.4);
        }

        .progress-bar-vertical {
            position: relative;
            width: 100%;
            height: 500px;
            background: linear-gradient(180deg, #e0e0e0 0%, #f5f5f5 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .progress-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            transition: height 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .box-segment {
            width: 100%;
            border-top: 2px solid rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.5s;
        }

        .matching-item {
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .matching-item.selected {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(93, 92, 222, 0.8);
        }

        .matching-item.matched {
            opacity: 0.6;
            pointer-events: none;
        }

        .puzzle-piece {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            text-align: center;
            padding: 10px;
            min-height: 60px;
        }

        .puzzle-piece:hover {
            transform: rotateY(10deg) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .puzzle-piece.correct {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            animation: pulse-success 0.6s;
        }

        @keyframes pulse-success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .draw-canvas {
            border: 3px solid #5D5CDE;
            border-radius: 12px;
            background: white;
            cursor: crosshair;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .sequence-item {
            transition: all 0.3s;
            cursor: pointer;
        }

        .sequence-item:hover {
            transform: translateY(-5px);
        }

        .sequence-item.selected {
            transform: scale(0.95);
            opacity: 0.5;
        }

        .timer-critical {
            animation: pulse-red 0.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { color: #ef4444; transform: scale(1); }
            50% { color: #dc2626; transform: scale(1.1); }
        }

        .ranking-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
        .rank-other { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 dark:from-gray-900 dark:via-purple-900 dark:to-gray-800">
    <!-- Confetti Container -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50"></div>

    <div id="app" class="min-h-screen p-4 md:p-8">

        <!-- √âcran d'authentification par mot de passe -->
        <div id="auth-screen" class="max-w-md mx-auto">
            <div class="text-center mb-8 bounce-in">
                <div class="text-8xl mb-6">üë®‚Äçüè´</div>
                <h1 class="text-4xl md:text-5xl font-bold text-primary mb-4">Acc√®s Superviseur</h1>
                <p class="text-lg text-gray-700 dark:text-gray-300">Chasse au Tr√©sor SST</p>
            </div>

            <div class="glass-morphism rounded-3xl shadow-2xl p-8 bounce-in" style="animation-delay: 0.2s">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">Mot de passe superviseur</h2>

                <form id="auth-form" class="space-y-6">
                    <div>
                        <label for="auth-password" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Mot de passe
                        </label>
                        <input
                            type="password"
                            id="auth-password"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base focus:border-primary focus:outline-none"
                            required
                            autocomplete="off"
                        >
                    </div>

                    <div id="auth-error" class="hidden text-red-600 dark:text-red-400 text-sm font-semibold text-center bg-red-50 dark:bg-red-900/20 p-3 rounded-lg">
                        ‚ùå Mot de passe incorrect
                    </div>

                    <button
                        type="submit"
                        class="w-full bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all"
                    >
                        üîì D√©verrouiller
                    </button>
                </form>

                <div class="mt-6 text-center text-xs text-gray-500 dark:text-gray-400">
                    üîí R√©serv√© au superviseur de formation
                </div>
            </div>
        </div>

        <!-- Page de connexion (Superviseur) -->
        <div id="login-screen" class="hidden max-w-4xl mx-auto">
            <div class="text-center mb-8 bounce-in">
                <h1 class="text-5xl md:text-7xl font-bold neon-text text-primary mb-4">üèÜ Chasse au Tr√©sor SST</h1>
                <p class="text-xl md:text-2xl text-gray-700 dark:text-gray-300 font-semibold">Formation Multijoueur</p>
            </div>

            <div class="max-w-md mx-auto mb-6">
                <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center bounce-in" style="animation-delay: 0.2s">
                    <div class="text-6xl mb-4">üë®‚Äçüè´</div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Superviseur</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">Suivez la progression de tous les groupes en temps r√©el</p>
                    <button id="supervisor-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                        üìä Tableau de Bord
                    </button>
                </div>
            </div>

            <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center bounce-in" style="animation-delay: 0.6s">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">üì± Connexion Mobile</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Scannez ce QR code pour rejoindre depuis votre mobile/tablette</p>
                <div id="qrcode" class="inline-block p-4 bg-white rounded-xl mb-4"></div>
                <p class="text-sm text-gray-500 dark:text-gray-500 mb-2">ou</p>
                <button id="manual-player-access-btn" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-base font-bold rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                    üë• Acc√®s Joueur Direct
                </button>
            </div>
        </div>

        <!-- Page de connexion (Joueur - accessible via QR code) -->
        <div id="player-entry-screen" class="hidden max-w-4xl mx-auto">
            <div class="text-center mb-8 bounce-in">
                <h1 class="text-5xl md:text-7xl font-bold neon-text text-primary mb-4">üèÜ Chasse au Tr√©sor SST</h1>
                <p class="text-xl md:text-2xl text-gray-700 dark:text-gray-300 font-semibold">Formation Multijoueur</p>
            </div>

            <div class="max-w-md mx-auto">
                <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center bounce-in" style="animation-delay: 0.2s">
                    <div class="text-6xl mb-4">üë•</div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Joueur / Groupe</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Rejoignez la chasse au tr√©sor</p>

                    <input type="text" id="team-name-input" placeholder="Nom de votre √©quipe" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-white mb-4 text-base focus:border-primary focus:outline-none" maxlength="20">

                    <button id="player-btn" class="w-full bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                        üöÄ Commencer
                    </button>
                </div>
            </div>
        </div>

        <!-- Tableau de bord Superviseur -->
        <div id="supervisor-screen" class="hidden max-w-full mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-primary neon-text mb-2">üë®‚Äçüè´ Tableau de Bord Superviseur</h1>
                <p class="text-lg text-gray-600 dark:text-gray-400">Progression en temps r√©el</p>
                <div class="mt-4 flex flex-wrap justify-center gap-3">
                    <button id="back-to-login-supervisor" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-all">
                        ‚Üê Retour
                    </button>
                    <button id="stop-all-games-btn" class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-semibold transition-all">
                        ‚è∏Ô∏è Arr√™ter le Jeu
                    </button>
                    <button id="resume-game-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all">
                        ‚ñ∂Ô∏è Reprendre le Jeu
                    </button>
                    <button id="reset-all-btn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all" onclick="resetAllData()">
                        üîÑ R√©initialiser Tout
                    </button>
                    <button id="admin-mode-btn" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all">
                        üîß Mode ADMIN
                    </button>
                </div>
            </div>

            <div class="glass-morphism rounded-3xl shadow-2xl p-6 mb-6">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-primary" id="active-teams-count">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">√âquipes Actives</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-600" id="finished-teams-count">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">√âquipes Termin√©es</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse-anim"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400">Mise √† jour en direct</span>
                    </div>
                </div>
            </div>

            <!-- Barres de progression verticales -->
            <div id="teams-progress-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- Les barres seront g√©n√©r√©es ici -->
            </div>

            <!-- Classement final -->
            <div id="final-ranking" class="hidden mt-8 glass-morphism rounded-3xl shadow-2xl p-8">
                <h2 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-6">üèÜ Classement Final</h2>
                <div id="ranking-list" class="space-y-4">
                    <!-- Le classement sera g√©n√©r√© ici -->
                </div>
            </div>
        </div>

        <!-- √âcran des coffres (Joueur) -->
        <div id="boxes-screen" class="hidden max-w-7xl mx-auto">
            <div class="text-center mb-6">
                <div class="inline-block glass-morphism px-6 py-3 rounded-full mb-4">
                    <span class="text-xl font-bold text-primary" id="team-name-display"></span>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold text-primary neon-text mb-4">üéÅ Les Coffres au Tr√©sor SST</h1>
                <div class="flex justify-center items-center gap-6 flex-wrap">
                    <div class="text-center">
                        <div class="text-4xl font-bold text-primary" id="total-score-display">0</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Points Totaux</div>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl font-bold text-green-600" id="boxes-unlocked">0/8</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Coffres Ouverts</div>
                    </div>
                    <button id="toggle-music-btn" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg font-semibold transition-all shadow-lg">
                        üéµ Musique ON
                    </button>
                </div>
            </div>

            <div id="boxes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                <!-- Les coffres seront g√©n√©r√©s ici -->
            </div>
        </div>

        <!-- √âcran de jeu -->
        <div id="game-screen" class="hidden max-w-6xl mx-auto">
            <!-- En-t√™te avec score et progression -->
            <div class="glass-morphism rounded-2xl shadow-xl p-4 md:p-6 mb-6 bounce-in">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <button id="back-to-boxes" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-all">
                        ‚Üê Retour aux coffres
                    </button>

                    <div class="flex items-center gap-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-primary" id="game-score-display">0</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Points</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-orange-600" id="timer-display">60</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Secondes</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl" id="attempts-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Essais</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Container du jeu actuel -->
            <div id="current-game" class="glass-morphism rounded-3xl shadow-2xl p-6 md:p-8 bounce-in">
                <!-- Le contenu du jeu sera ins√©r√© ici dynamiquement -->
            </div>

            <!-- Boutons de validation -->
            <div id="game-controls" class="mt-6 flex gap-4">
                <button id="validate-btn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xl font-bold py-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
                    ‚úì Valider la R√©ponse
                </button>
                <button id="reset-answer-btn" class="hidden px-6 bg-gradient-to-r from-orange-500 to-red-600 text-white text-xl font-bold py-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
                    üîÑ R√©initialiser
                </button>
            </div>
        </div>

        <!-- √âcran de pause entre √©tapes -->
        <div id="stage-pause-screen" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 md:p-12 bounce-in">
                <div class="text-8xl mb-6">‚è∏Ô∏è</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-6">Pause - √âtape <span id="stage-number">1</span> termin√©e !</h1>
                <p class="text-2xl text-gray-700 dark:text-gray-300 mb-8">Excellente progression ! En attente du formateur...</p>

                <div class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-2xl p-10 mb-8 shadow-2xl">
                    <div class="text-7xl font-bold mb-3" id="stage-score">0</div>
                    <div class="text-3xl font-semibold">Points actuels</div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 mb-8 shadow-lg">
                    <div class="text-5xl mb-4">‚è≥</div>
                    <p class="text-xl text-gray-700 dark:text-gray-300">Le formateur va donner le signal pour continuer...</p>
                    <div class="mt-6 flex items-center justify-center space-x-2">
                        <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0s"></div>
                        <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                    </div>
                </div>

                <div id="stage-stats" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="text-4xl mb-2">üì¶</div>
                        <div class="text-3xl font-bold text-primary" id="stage-boxes-unlocked">0</div>
                        <div class="text-gray-600 dark:text-gray-400">Coffres d√©verrouill√©s</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                        <div class="text-4xl mb-2">üéØ</div>
                        <div class="text-3xl font-bold text-primary" id="stage-boxes-remaining">0</div>
                        <div class="text-gray-600 dark:text-gray-400">Coffres restants</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- √âcran de fin -->
        <div id="end-screen" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 md:p-12 bounce-in">
                <div class="text-8xl mb-6">üèÜ</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-6">Mission Accomplie !</h1>
                <p class="text-2xl text-gray-700 dark:text-gray-300 mb-8">Vous √™tes maintenant un expert SST certifi√© !</p>

                <div class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-2xl p-10 mb-8 shadow-2xl">
                    <div class="text-7xl font-bold mb-3" id="final-score">0</div>
                    <div class="text-3xl font-semibold">Points totaux</div>
                </div>

                <div id="final-stats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Stats seront ajout√©es dynamiquement -->
                </div>

                <button id="restart-btn" class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-3xl font-bold py-8 px-16 rounded-2xl shadow-2xl hover:shadow-3xl transform hover:scale-105 transition-all duration-300 glow">
                    üîÑ Recommencer l'Aventure
                </button>
            </div>
        </div>

        <!-- √âcran ADMIN -->
        <div id="admin-screen" class="hidden max-w-7xl mx-auto">
            <div class="glass-morphism rounded-3xl shadow-2xl p-6 md:p-10">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-primary neon-text">üîß Mode ADMIN</h1>
                    <button id="admin-close-btn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all">
                        ‚úï Fermer
                    </button>
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Colonne gauche : Liste des coffres et jeux -->
                    <div class="md:col-span-1 bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg flex flex-col max-h-[600px]">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">üì¶ Coffres & Jeux</h2>

                        <!-- Barre de recherche -->
                        <div class="mb-4">
                            <input
                                type="text"
                                id="admin-search"
                                placeholder="üîç Rechercher un jeu..."
                                class="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base focus:border-primary focus:outline-none"
                            >
                        </div>

                        <!-- Filtres par type -->
                        <div class="mb-4 flex flex-wrap gap-2">
                            <button class="admin-filter-btn px-3 py-1 text-xs rounded-full bg-primary text-white" data-type="all">
                                Tous
                            </button>
                            <button class="admin-filter-btn px-3 py-1 text-xs rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300" data-type="quiz">
                                QCM
                            </button>
                            <button class="admin-filter-btn px-3 py-1 text-xs rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300" data-type="true-false">
                                V/F
                            </button>
                            <button class="admin-filter-btn px-3 py-1 text-xs rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300" data-type="matching">
                                Appariement
                            </button>
                            <button class="admin-filter-btn px-3 py-1 text-xs rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300" data-type="sequence">
                                S√©quence
                            </button>
                        </div>

                        <!-- Compteur de r√©sultats -->
                        <div class="mb-3 text-sm text-gray-600 dark:text-gray-400">
                            <span id="admin-results-count">0</span> jeu(x) affich√©(s)
                        </div>

                        <!-- Liste scrollable -->
                        <div id="admin-boxes-list" class="space-y-3 overflow-y-auto flex-1">
                            <!-- Liste des coffres sera g√©n√©r√©e ici -->
                        </div>
                    </div>

                    <!-- Colonne droite : Formulaire d'√©dition -->
                    <div class="md:col-span-2 bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
                        <div id="admin-no-selection" class="text-center py-20 text-gray-500 dark:text-gray-400">
                            <div class="text-6xl mb-4">üëà</div>
                            <p class="text-xl">S√©lectionnez un jeu √† modifier</p>
                        </div>

                        <div id="admin-edit-form" class="hidden space-y-6 max-h-[600px] overflow-y-auto pr-4">
                            <h2 id="admin-edit-form-title" class="text-2xl font-bold text-gray-800 dark:text-white sticky top-0 bg-white dark:bg-gray-800 pb-4 z-10">
                                ‚úèÔ∏è √âdition du jeu
                            </h2>

                            <div class="space-y-4">
                                <!-- Type de jeu (lecture seule) -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Type de jeu</label>
                                    <input type="text" id="admin-type" readonly class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white">
                                </div>

                                <!-- Titre -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Titre</label>
                                    <input type="text" id="admin-title" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base">
                                </div>

                                <!-- Question -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Question</label>
                                    <textarea id="admin-question" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base"></textarea>
                                </div>

                                <!-- Options/R√©ponses (dynamique selon le type) -->
                                <div id="admin-options-container">
                                    <!-- Les options seront g√©n√©r√©es dynamiquement -->
                                </div>

                                <!-- R√©ponse correcte -->
                                <div id="admin-correct-answer-container">
                                    <!-- Le champ de r√©ponse correcte sera g√©n√©r√© dynamiquement -->
                                </div>

                                <!-- Explication (pour true-false) -->
                                <div id="admin-explanation-container" class="hidden">
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Explication</label>
                                    <textarea id="admin-explanation" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base"></textarea>
                                </div>

                                <!-- Limite de temps -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Limite de temps (secondes)</label>
                                    <input type="number" id="admin-timeLimit" min="10" max="300" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base">
                                </div>

                                <!-- Points -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Points</label>
                                    <input type="number" id="admin-points" min="10" max="500" step="10" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base">
                                </div>
                            </div>

                            <!-- Boutons d'action -->
                            <div class="flex gap-4 pt-6 border-t border-gray-200 dark:border-gray-700 sticky bottom-0 bg-white dark:bg-gray-800">
                                <button id="admin-save-btn" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all shadow-lg">
                                    üíæ Enregistrer les modifications
                                </button>
                                <button id="admin-cancel-btn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-all">
                                    ‚ùå Annuler
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panneau de contr√¥le du timing global -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">‚è±Ô∏è Contr√¥le du Timing Global</h3>

                    <div class="bg-gradient-to-br from-orange-50 to-yellow-50 dark:from-gray-800 dark:to-gray-700 rounded-2xl p-6 mb-4">
                        <!-- Statistiques actuelles -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-orange-600 dark:text-orange-400" id="admin-avg-time">0</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Temps moyen (sec)</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="admin-min-time">0</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Minimum (sec)</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-red-600 dark:text-red-400" id="admin-max-time">0</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Maximum (sec)</div>
                            </div>
                        </div>

                        <!-- Presets de vitesse -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">Presets de vitesse</label>
                            <div class="grid grid-cols-4 gap-3">
                                <button class="admin-speed-preset px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold transition-all shadow-lg" data-multiplier="0.5">
                                    üî• Ultra Rapide<br><span class="text-xs opacity-80">-50%</span>
                                </button>
                                <button class="admin-speed-preset px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-semibold transition-all shadow-lg" data-multiplier="0.75">
                                    ‚ö° Rapide<br><span class="text-xs opacity-80">-25%</span>
                                </button>
                                <button class="admin-speed-preset px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition-all shadow-lg" data-multiplier="1.25">
                                    üê¢ Lent<br><span class="text-xs opacity-80">+25%</span>
                                </button>
                                <button class="admin-speed-preset px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-all shadow-lg" data-multiplier="1.5">
                                    ü¶• Tr√®s Lent<br><span class="text-xs opacity-80">+50%</span>
                                </button>
                            </div>
                        </div>

                        <!-- Contr√¥le manuel -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">Ajustement personnalis√©</label>
                            <div class="flex gap-3 items-center">
                                <input
                                    type="number"
                                    id="admin-time-multiplier"
                                    min="0.1"
                                    max="3"
                                    step="0.1"
                                    value="1.0"
                                    class="w-32 px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base font-bold text-center"
                                >
                                <span class="text-gray-600 dark:text-gray-400">√ó multiplicateur</span>
                                <button id="admin-apply-multiplier" class="flex-1 px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all">
                                    Appliquer √† tous les jeux
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                                üí° Exemple : 0.5 = diviser par 2 (plus rapide), 2.0 = doubler (plus lent)
                            </p>
                        </div>

                        <!-- D√©finir un temps fixe -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mt-3">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">Temps fixe pour tous</label>
                            <div class="flex gap-3 items-center">
                                <input
                                    type="number"
                                    id="admin-fixed-time"
                                    min="10"
                                    max="300"
                                    step="5"
                                    value="30"
                                    class="w-32 px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white text-base font-bold text-center"
                                >
                                <span class="text-gray-600 dark:text-gray-400">secondes</span>
                                <button id="admin-apply-fixed-time" class="flex-1 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-all">
                                    D√©finir ce temps pour tous
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons de gestion globale -->
                <div class="flex gap-4 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <button id="admin-export-btn" class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all">
                        üì• Exporter toutes les questions (JSON)
                    </button>
                    <button id="admin-import-btn" class="flex-1 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all">
                        üì§ Importer des questions (JSON)
                    </button>
                </div>
                <input type="file" id="admin-import-file" accept=".json" class="hidden">
            </div>
        </div>
    </div>

<script>
 
// Configuration du th√®me sombre
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
    if (event.matches) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
});

// ==================== AUTHENTIFICATION ====================

// Hash SHA-256 simple (compatible navigateur)
async function hashPassword(password) {
    const msgBuffer = new TextEncoder().encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}

// Hash du mot de passe correct (MibQuizSST)
const CORRECT_PASSWORD_HASH = 'd765abcf8ac3fd0f0a6628252442e86958246badd5e320ffe2f731e540c7cc3b';

// Variable globale pour l'authentification (en m√©moire uniquement)
let isUserAuthenticated = false;

// V√©rifier si l'utilisateur est d√©j√† authentifi√©
function checkAuthentication() {
    // V√©rifier d'abord si c'est un acc√®s joueur via QR code
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');

    if (mode === 'player') {
        // Acc√®s joueur direct via QR code - pas besoin de mot de passe
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('player-entry-screen').classList.remove('hidden');
        return true;
    }

    if (isUserAuthenticated) {
        // L'utilisateur superviseur est d√©j√† authentifi√©
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        return true;
    } else {
        // L'utilisateur doit s'authentifier (superviseur)
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        return false;
    }
}

// G√©rer le formulaire d'authentification
document.getElementById('auth-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const passwordInput = document.getElementById('auth-password');
    const errorDiv = document.getElementById('auth-error');
    const password = passwordInput.value;

    // V√©rifier le mot de passe
    const hashedInput = await hashPassword(password);

    if (hashedInput === CORRECT_PASSWORD_HASH) {
        // Mot de passe correct !
        isUserAuthenticated = true;

        // Animation de succ√®s
        errorDiv.classList.add('hidden');
        passwordInput.classList.remove('border-red-500');
        passwordInput.classList.add('border-green-500');

        // Transition vers l'√©cran de connexion
        setTimeout(() => {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }, 300);
    } else {
        // Mot de passe incorrect
        errorDiv.classList.remove('hidden');
        passwordInput.classList.add('border-red-500');
        passwordInput.value = '';
        passwordInput.focus();

        // Shake animation
        passwordInput.classList.add('shake');
        setTimeout(() => {
            passwordInput.classList.remove('shake');
        }, 500);
    }
});

// V√©rifier l'authentification au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
    checkAuthentication();
});

// ==================== CONFIGURATION FIREBASE ====================

const firebaseConfig = {
  apiKey: "AIzaSyAZLBDZIaPp3GrXuVz4fPiK91JhLEqXPs0",
  authDomain: "jeu-sst-v1-291025.firebaseapp.com",
  databaseURL: "https://jeu-sst-v1-291025-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jeu-sst-v1-291025",
  storageBucket: "jeu-sst-v1-291025.firebasestorage.app",
  messagingSenderId: "57462613537",
  appId: "1:57462613537:web:6178195b2f4f08fbaa2560"
};

// Variables Firebase
let database = null;
// Session ID global partag√© par toutes les √©quipes d'une m√™me formation
// Utilis√© pour coordonner les √©tapes entre √©quipes
let sessionId = 'formation_' + new Date().toISOString().split('T')[0]; // Format: formation_2025-01-15

// Initialiser Firebase (apr√®s le chargement de la page)
function initializeFirebase() {
    try {
        if (typeof firebase === 'undefined') {
            console.error('‚ùå Firebase SDK non charg√©. V√©rifiez votre connexion internet.');
            console.error('‚ö†Ô∏è Le syst√®me d\'√©tapes ne fonctionnera pas sans Firebase !');

            // Afficher un avertissement √† l'utilisateur
            setTimeout(() => {
                showCustomAlert('‚ö†Ô∏è ATTENTION: Firebase n\'est pas disponible. Le syst√®me d\'√©tapes multijoueur ne fonctionnera pas. Utilisez le mode local uniquement.');
            }, 2000);

            return false;
        }

        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log('‚úÖ Firebase initialis√© avec succ√®s');
        console.log('üÜî Session de formation:', sessionId);
        console.log('üîó Database URL:', firebaseConfig.databaseURL);

        // Test de connexion
        database.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                console.log('üåê Connect√© √† Firebase en temps r√©el');
            } else {
                console.log('üì° D√©connect√© de Firebase');
            }
        });

        return true;
    } catch (error) {
        console.error('‚ùå Erreur d\'initialisation Firebase:', error);
        console.error('‚ö†Ô∏è Le syst√®me d\'√©tapes ne fonctionnera pas sans Firebase !');

        setTimeout(() => {
            showCustomAlert('‚ö†Ô∏è ERREUR: Impossible de se connecter √† Firebase. Le syst√®me d\'√©tapes multijoueur ne fonctionnera pas.');
        }, 2000);

        return false;
    }
}

// ==================== SYST√àME MULTIJOUEUR ====================

// √âtat global du mode
let appMode = 'login'; // 'login', 'supervisor', 'player'
let currentTeamName = '';

// Stockage des √©quipes (pour le superviseur)
let teams = {};

// SYST√àME D'√âTAPES (4 √©tapes de 2 coffres chacune)
let currentStage = 1; // √âtape actuelle (1 √† 4)
let gamePaused = false; // Le jeu est-il en pause ?
let stageWinners = {
    stage1: null,
    stage2: null,
    stage3: null,
    stage4: null
};

// Fonction pour calculer l'√©tape en fonction des coffres d√©verrouill√©s
function getStageFromBoxes(boxesUnlocked) {
    if (boxesUnlocked >= 8) return 4;
    if (boxesUnlocked >= 6) return 3;
    if (boxesUnlocked >= 4) return 2;
    if (boxesUnlocked >= 2) return 1;
    return 0; // Pas encore d'√©tape compl√©t√©e
}

// Audio Context pour les sons
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// ==================== SONS AM√âLIOR√âS ====================

function playSound(type, frequency = null) {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    switch(type) {
        case 'success':
            // Son de r√©ussite enjou√© (mont√©e joyeuse)
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
            oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.6);
            break;
        case 'bravo':
            // Son de bravo triomphant (fanfare courte)
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.08);
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.16);
            oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime + 0.24);
            oscillator.frequency.setValueAtTime(1318.51, audioContext.currentTime + 0.32);
            gainNode.gain.setValueAtTime(0.35, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.8);
            break;
        case 'error':
            // Son d'erreur descendant
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(100, audioContext.currentTime + 0.2);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.4);
            break;
        case 'wrong':
            // Son d'√©chec (plus doux que error)
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(250, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.15);
            gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
            break;
        case 'tick':
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.05);
            break;
        case 'unlock':
            // Son de d√©verrouillage majestueux
            oscillator.type = 'triangle';
            const baseFreq = frequency || 400;
            oscillator.frequency.setValueAtTime(baseFreq, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(baseFreq * 1.25, audioContext.currentTime + 0.15);
            oscillator.frequency.setValueAtTime(baseFreq * 1.5, audioContext.currentTime + 0.3);
            oscillator.frequency.setValueAtTime(baseFreq * 2, audioContext.currentTime + 0.45);
            gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.8);
            break;
        case 'complete':
            // Son de victoire finale √©pique
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.12);
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.24);
            oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime + 0.36);
            oscillator.frequency.setValueAtTime(1318.51, audioContext.currentTime + 0.48);
            gainNode.gain.setValueAtTime(0.35, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 1);
            break;
        case 'countdown':
            // Son de compte √† rebours (urgent)
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
            break;
    }
}

// Fr√©quences pour chaque coffre (pour des sons uniques)
const boxSoundFrequencies = [300, 350, 400, 450, 500, 550, 600, 650];

// ==================== MUSIQUE DE FOND ====================

let backgroundMusicIntervalId = null;
let musicGainNode = null;
let isMusicPlaying = false;

// M√©lodie d'ambiance agr√©able et motivante (notes en Hz)
const backgroundMelody = [
    { freq: 523.25, duration: 0.3 }, // C5
    { freq: 587.33, duration: 0.3 }, // D5
    { freq: 659.25, duration: 0.3 }, // E5
    { freq: 587.33, duration: 0.3 }, // D5
    { freq: 523.25, duration: 0.3 }, // C5
    { freq: 440.00, duration: 0.3 }, // A4
    { freq: 493.88, duration: 0.3 }, // B4
    { freq: 523.25, duration: 0.6 }, // C5
    { pause: 0.4 },
    { freq: 659.25, duration: 0.3 }, // E5
    { freq: 698.46, duration: 0.3 }, // F5
    { freq: 783.99, duration: 0.3 }, // G5
    { freq: 698.46, duration: 0.3 }, // F5
    { freq: 659.25, duration: 0.3 }, // E5
    { freq: 587.33, duration: 0.3 }, // D5
    { freq: 523.25, duration: 0.6 }, // C5
    { pause: 0.4 }
];

let currentNoteIndex = 0;

function playBackgroundMusic() {
    if (!isMusicPlaying) return;

    const note = backgroundMelody[currentNoteIndex];

    if (note.pause) {
        // Pause entre les notes
        setTimeout(() => {
            currentNoteIndex = (currentNoteIndex + 1) % backgroundMelody.length;
            playBackgroundMusic();
        }, note.pause * 1000);
    } else {
        // Jouer une note
        const oscillator = audioContext.createOscillator();
        musicGainNode = audioContext.createGain();

        oscillator.connect(musicGainNode);
        musicGainNode.connect(audioContext.destination);

        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime);

        // Volume tr√®s doux pour la musique de fond
        musicGainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
        musicGainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.duration);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + note.duration);

        setTimeout(() => {
            currentNoteIndex = (currentNoteIndex + 1) % backgroundMelody.length;
            playBackgroundMusic();
        }, note.duration * 1000);
    }
}

function startBackgroundMusic() {
    if (!isMusicPlaying) {
        isMusicPlaying = true;
        currentNoteIndex = 0;
        playBackgroundMusic();
    }
}

function stopBackgroundMusic() {
    isMusicPlaying = false;
    if (backgroundMusicIntervalId) {
        clearInterval(backgroundMusicIntervalId);
        backgroundMusicIntervalId = null;
    }
}

// ==================== ILLUSTRATIONS SVG PROC√âDURES SST ====================

// Illustration RCP - Position des mains pour massage cardiaque
function getRCPHandsSVG() {
    return `
        <svg viewBox="0 0 300 400" class="w-full h-auto max-w-md mx-auto">
            <!-- Corps de la victime -->
            <ellipse cx="150" cy="180" rx="90" ry="140" fill="#FFE4C4" stroke="#8B4513" stroke-width="2"/>
            <!-- T√™te -->
            <circle cx="150" cy="60" r="35" fill="#FFD7A6" stroke="#8B4513" stroke-width="2"/>
            <!-- Cou -->
            <rect x="135" y="90" width="30" height="20" fill="#FFE4C4"/>
            <!-- Sternum (zone de compression) -->
            <rect x="120" y="150" width="60" height="80" fill="#FF6B6B" opacity="0.3" stroke="#FF0000" stroke-width="2" stroke-dasharray="5,5"/>
            <text x="150" y="195" text-anchor="middle" fill="#FF0000" font-size="14" font-weight="bold">STERNUM</text>
            <!-- Main 1 (en bas) -->
            <rect x="110" y="175" width="80" height="25" rx="3" fill="#87CEEB" stroke="#4682B4" stroke-width="2"/>
            <text x="150" y="192" text-anchor="middle" fill="#000" font-size="12" font-weight="bold">MAIN 1</text>
            <!-- Main 2 (au dessus) -->
            <rect x="110" y="145" width="80" height="25" rx="3" fill="#98D8E8" stroke="#4682B4" stroke-width="2"/>
            <text x="150" y="162" text-anchor="middle" fill="#000" font-size="12" font-weight="bold">MAIN 2</text>
            <!-- Fl√®ches de compression -->
            <path d="M 150 130 L 150 145" stroke="#FF0000" stroke-width="3" marker-end="url(#arrowhead)"/>
            <path d="M 170 130 L 170 145" stroke="#FF0000" stroke-width="3" marker-end="url(#arrowhead)"/>
            <path d="M 130 130 L 130 145" stroke="#FF0000" stroke-width="3" marker-end="url(#arrowhead)"/>
            <text x="150" y="120" text-anchor="middle" fill="#FF0000" font-size="16" font-weight="bold">‚Üì 5-6 cm ‚Üì</text>
            <!-- L√©gende -->
            <text x="150" y="340" text-anchor="middle" fill="#333" font-size="14" font-weight="bold">Position des mains au centre du thorax</text>
            <text x="150" y="360" text-anchor="middle" fill="#666" font-size="12">Bras tendus, 100-120 compressions/min</text>
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <polygon points="0 0, 10 5, 0 10" fill="#FF0000"/>
                </marker>
            </defs>
        </svg>
    `;
}

// Illustration PLS - Position Lat√©rale de S√©curit√©
function getPLSSVG() {
    return `
        <svg viewBox="0 0 400 250" class="w-full h-auto max-w-lg mx-auto">
            <!-- Sol -->
            <rect x="0" y="200" width="400" height="50" fill="#D2B48C" opacity="0.3"/>
            <!-- Corps en PLS -->
            <ellipse cx="200" cy="160" rx="110" ry="35" fill="#FFE4C4" stroke="#8B4513" stroke-width="2" transform="rotate(-10 200 160)"/>
            <!-- T√™te -->
            <circle cx="150" cy="130" r="30" fill="#FFD7A6" stroke="#8B4513" stroke-width="2"/>
            <!-- Bras du dessus (pli√©) -->
            <path d="M 230 150 Q 250 120 240 100" stroke="#FFE4C4" stroke-width="20" fill="none" stroke-linecap="round"/>
            <!-- Main sous la joue -->
            <ellipse cx="145" cy="125" rx="15" ry="20" fill="#FFDAB9" stroke="#8B4513" stroke-width="1"/>
            <!-- Jambe du dessus (pli√©e √† 90¬∞) -->
            <path d="M 220 180 L 220 220 L 270 220" stroke="#87CEEB" stroke-width="25" fill="none" stroke-linecap="round"/>
            <!-- Jambe du dessous (tendue) -->
            <path d="M 200 180 L 200 230" stroke="#6A9FB5" stroke-width="22" fill="none" stroke-linecap="round"/>
            <!-- Fl√®ches et annotations -->
            <text x="145" y="110" text-anchor="middle" fill="#FF0000" font-size="12" font-weight="bold">Main sous joue</text>
            <path d="M 145 115 L 145 122" stroke="#FF0000" stroke-width="2" marker-end="url(#arrowred)"/>
            <text x="280" y="210" text-anchor="start" fill="#0066CC" font-size="12" font-weight="bold">Jambe √† 90¬∞</text>
            <path d="M 270 215 L 250 220" stroke="#0066CC" stroke-width="2" marker-end="url(#arrowblue)"/>
            <!-- Titre -->
            <text x="200" y="30" text-anchor="middle" fill="#333" font-size="18" font-weight="bold">Position Lat√©rale de S√©curit√© (PLS)</text>
            <text x="200" y="50" text-anchor="middle" fill="#666" font-size="12">Victime inconsciente qui respire</text>
            <defs>
                <marker id="arrowred" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <polygon points="0 0, 10 5, 0 10" fill="#FF0000"/>
                </marker>
                <marker id="arrowblue" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <polygon points="0 0, 10 5, 0 10" fill="#0066CC"/>
                </marker>
            </defs>
        </svg>
    `;
}

// Illustration Heimlich - Compressions abdominales
function getHeimlichSVG() {
    return `
        <svg viewBox="0 0 300 400" class="w-full h-auto max-w-md mx-auto">
            <!-- Victime (vue de dos) -->
            <ellipse cx="150" cy="200" rx="70" ry="120" fill="#FFE4C4" stroke="#8B4513" stroke-width="2"/>
            <!-- T√™te -->
            <circle cx="150" cy="80" r="30" fill="#8B4513"/>
            <!-- Cou -->
            <rect x="135" y="105" width="30" height="20" fill="#FFE4C4"/>
            <!-- √âpaules -->
            <ellipse cx="150" cy="140" rx="85" ry="25" fill="#87CEEB"/>
            <!-- Bras du sauveteur -->
            <path d="M 70 180 Q 110 190 130 210" stroke="#98D8E8" stroke-width="22" fill="none" stroke-linecap="round"/>
            <path d="M 230 180 Q 190 190 170 210" stroke="#98D8E8" stroke-width="22" fill="none" stroke-linecap="round"/>
            <!-- Mains enlac√©es -->
            <circle cx="150" cy="220" r="25" fill="#FFDAB9" stroke="#8B4513" stroke-width="2"/>
            <text x="150" y="227" text-anchor="middle" fill="#000" font-size="12" font-weight="bold">POING</text>
            <!-- Zone de compression -->
            <ellipse cx="150" cy="220" rx="50" ry="35" fill="none" stroke="#FF0000" stroke-width="3" stroke-dasharray="5,5"/>
            <text x="150" y="260" text-anchor="middle" fill="#FF0000" font-size="11" font-weight="bold">Entre nombril et sternum</text>
            <!-- Fl√®che de compression -->
            <path d="M 150 185 L 150 195" stroke="#FF0000" stroke-width="4" marker-end="url(#arrowhead2)"/>
            <text x="150" y="175" text-anchor="middle" fill="#FF0000" font-size="14" font-weight="bold">‚Üë TIRER VERS SOI ‚Üë</text>
            <!-- Nombril (rep√®re) -->
            <circle cx="150" cy="250" r="5" fill="#8B4513"/>
            <text x="180" y="255" fill="#666" font-size="10">Nombril</text>
            <!-- Titre -->
            <text x="150" y="30" text-anchor="middle" fill="#333" font-size="16" font-weight="bold">M√©thode de Heimlich</text>
            <text x="150" y="50" text-anchor="middle" fill="#666" font-size="11">Compressions abdominales (obstruction totale)</text>
            <!-- Instructions -->
            <text x="150" y="340" text-anchor="middle" fill="#333" font-size="11">1. Poing entre nombril et sternum</text>
            <text x="150" y="360" text-anchor="middle" fill="#333" font-size="11">2. Tirer franchement vers soi et vers le haut</text>
            <text x="150" y="380" text-anchor="middle" fill="#333" font-size="11">3. R√©p√©ter jusqu'√† expulsion du corps √©tranger</text>
            <defs>
                <marker id="arrowhead2" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <polygon points="0 0, 10 5, 0 10" fill="#FF0000"/>
                </marker>
            </defs>
        </svg>
    `;
}

// Illustration compression h√©morragie
function getCompressionSVG() {
    return `
        <svg viewBox="0 0 300 350" class="w-full h-auto max-w-md mx-auto">
            <!-- Bras bless√© -->
            <rect x="80" y="150" width="140" height="50" rx="25" fill="#FFE4C4" stroke="#8B4513" stroke-width="2"/>
            <!-- Plaie / h√©morragie -->
            <ellipse cx="150" cy="175" rx="30" ry="20" fill="#8B0000" opacity="0.7"/>
            <circle cx="140" cy="170" r="8" fill="#FF0000" opacity="0.8"/>
            <circle cx="160" cy="180" r="6" fill="#FF0000" opacity="0.8"/>
            <circle cx="150" cy="185" r="5" fill="#8B0000" opacity="0.9"/>
            <!-- Sang qui coule -->
            <path d="M 145 190 Q 140 210 138 230" stroke="#8B0000" stroke-width="4" opacity="0.6"/>
            <path d="M 155 192 Q 158 210 160 230" stroke="#8B0000" stroke-width="3" opacity="0.6"/>
            <!-- Main avec gant (compression) -->
            <ellipse cx="150" cy="175" rx="45" ry="35" fill="#87CEEB" opacity="0.9" stroke="#4682B4" stroke-width="2"/>
            <text x="150" y="180" text-anchor="middle" fill="#FFF" font-size="13" font-weight="bold">MAIN GANT√âE</text>
            <!-- Gant (d√©tail) -->
            <rect x="130" y="90" width="40" height="50" rx="5" fill="#87CEEB" stroke="#4682B4" stroke-width="2"/>
            <text x="150" y="120" text-anchor="middle" fill="#000" font-size="10" font-weight="bold">Gant</text>
            <path d="M 150 140 L 150 155" stroke="#4682B4" stroke-width="2" stroke-dasharray="3,3"/>
            <!-- Fl√®ches de pression -->
            <path d="M 120 175 L 130 175" stroke="#FF0000" stroke-width="3" marker-end="url(#arrowhead3)"/>
            <path d="M 180 175 L 170 175" stroke="#FF0000" stroke-width="3" marker-end="url(#arrowhead3)"/>
            <text x="90" y="180" fill="#FF0000" font-size="14" font-weight="bold">‚Üí</text>
            <text x="205" y="180" fill="#FF0000" font-size="14" font-weight="bold">‚Üê</text>
            <text x="150" y="250" text-anchor="middle" fill="#FF0000" font-size="13" font-weight="bold">COMPRESSION DIRECTE</text>
            <!-- Titre -->
            <text x="150" y="30" text-anchor="middle" fill="#333" font-size="16" font-weight="bold">Arr√™t d'une h√©morragie externe</text>
            <text x="150" y="50" text-anchor="middle" fill="#666" font-size="11">Compression directe avec protection</text>
            <!-- Instructions -->
            <text x="150" y="290" text-anchor="middle" fill="#333" font-size="11">1. Prot√©ger ses mains (gants, sac plastique...)</text>
            <text x="150" y="310" text-anchor="middle" fill="#333" font-size="11">2. Comprimer fermement sur la plaie</text>
            <text x="150" y="330" text-anchor="middle" fill="#333" font-size="11">3. Maintenir jusqu'√† l'arriv√©e des secours</text>
            <defs>
                <marker id="arrowhead3" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <polygon points="0 0, 10 5, 0 10" fill="#FF0000"/>
                </marker>
            </defs>
        </svg>
    `;
}

// Illustration Lib√©ration des Voies A√©riennes (LVA)
function getLVASVG() {
    return `
        <svg viewBox="0 0 350 300" class="w-full h-auto max-w-lg mx-auto">
            <!-- T√™te de profil -->
            <ellipse cx="180" cy="120" rx="50" ry="60" fill="#FFD7A6" stroke="#8B4513" stroke-width="2"/>
            <!-- Nez -->
            <path d="M 220 110 L 235 120 L 225 125" fill="#FFB380" stroke="#8B4513" stroke-width="1"/>
            <!-- Bouche -->
            <ellipse cx="215" cy="140" rx="8" ry="5" fill="#FF6B8A"/>
            <!-- Menton -->
            <ellipse cx="200" cy="165" rx="25" ry="20" fill="#FFD7A6" stroke="#8B4513" stroke-width="2"/>
            <!-- Cou -->
            <rect x="160" y="175" width="35" height="50" fill="#FFE4C4" stroke="#8B4513" stroke-width="1"/>
            <!-- Main sous le menton -->
            <ellipse cx="215" cy="165" rx="25" ry="18" fill="#FFDAB9" stroke="#8B4513" stroke-width="2" transform="rotate(25 215 165)"/>
            <text x="250" y="170" fill="#0066CC" font-size="11" font-weight="bold">Main sous menton</text>
            <!-- Main sur le front -->
            <ellipse cx="160" cy="95" rx="28" ry="20" fill="#FFDAB9" stroke="#8B4513" stroke-width="2" transform="rotate(-15 160 95)"/>
            <text x="90" y="90" fill="#0066CC" font-size="11" font-weight="bold">Main sur front ‚Üí</text>
            <!-- Voies a√©riennes (sch√©ma interne) -->
            <path d="M 210 145 Q 200 160 195 180 L 195 220" stroke="#FF6B6B" stroke-width="4" fill="none" opacity="0.6"/>
            <text x="210" y="200" fill="#FF0000" font-size="10" font-weight="bold">Voies a√©riennes</text>
            <text x="210" y="215" fill="#FF0000" font-size="10" font-weight="bold">d√©gag√©es ‚úì</text>
            <!-- Fl√®ches de basculement -->
            <path d="M 180 80 Q 190 75 200 80" stroke="#FF0000" stroke-width="3" fill="none" marker-end="url(#arrowhead4)"/>
            <text x="180" y="65" fill="#FF0000" font-size="12" font-weight="bold">BASCULER</text>
            <path d="M 230 155 Q 235 150 240 155" stroke="#0066CC" stroke-width="3" fill="none" marker-end="url(#arrowblue2)"/>
            <text x="245" y="150" fill="#0066CC" font-size="12" font-weight="bold">SOULEVER</text>
            <!-- Titre -->
            <text x="175" y="30" text-anchor="middle" fill="#333" font-size="16" font-weight="bold">Lib√©ration des Voies A√©riennes (LVA)</text>
            <text x="175" y="50" text-anchor="middle" fill="#666" font-size="11">Basculer la t√™te en arri√®re pour d√©gager les voies a√©riennes</text>
            <!-- Instructions -->
            <text x="175" y="270" text-anchor="middle" fill="#333" font-size="11" font-weight="bold">Une main sur le front + Une main sous le menton</text>
            <defs>
                <marker id="arrowhead4" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <polygon points="0 0, 10 5, 0 10" fill="#FF0000"/>
                </marker>
                <marker id="arrowblue2" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <polygon points="0 0, 10 5, 0 10" fill="#0066CC"/>
                </marker>
            </defs>
        </svg>
    `;
}

// Illustration Triangle de signalisation
function getTriangleSVG() {
    return `
        <svg viewBox="0 0 300 350" class="w-full h-auto max-w-sm mx-auto">
            <!-- Route -->
            <rect x="0" y="250" width="300" height="100" fill="#555"/>
            <rect x="140" y="250" width="20" height="100" fill="#FFF" opacity="0.8"/>
            <rect x="140" y="270" width="20" height="20" fill="none"/>
            <rect x="140" y="310" width="20" height="20" fill="none"/>
            <!-- Distance 30m -->
            <line x1="150" y1="240" x2="250" y2="240" stroke="#FFD700" stroke-width="3" stroke-dasharray="5,5"/>
            <text x="200" y="235" text-anchor="middle" fill="#FFD700" font-size="14" font-weight="bold">‚â• 30 m√®tres</text>
            <!-- Triangle de signalisation -->
            <path d="M 250 200 L 220 260 L 280 260 Z" fill="none" stroke="#FF0000" stroke-width="6"/>
            <path d="M 250 210 L 230 250 L 270 250 Z" fill="#FF0000" opacity="0.3"/>
            <!-- Reflets -->
            <circle cx="240" cy="235" r="4" fill="#FFF" opacity="0.8"/>
            <circle cx="260" cy="235" r="4" fill="#FFF" opacity="0.8"/>
            <circle cx="250" cy="250" r="4" fill="#FFF" opacity="0.8"/>
            <!-- V√©hicule en panne -->
            <rect x="120" y="260" width="60" height="35" rx="5" fill="#4A90E2"/>
            <rect x="125" y="265" width="15" height="12" fill="#87CEEB"/>
            <rect x="145" y="265" width="15" height="12" fill="#87CEEB"/>
            <circle cx="135" cy="295" r="8" fill="#333"/>
            <circle cx="165" cy="295" r="8" fill="#333"/>
            <text x="150" y="315" text-anchor="middle" fill="#FFF" font-size="10" font-weight="bold">V√©hicule</text>
            <!-- Personne avec gilet -->
            <circle cx="90" cy="270" r="8" fill="#FFD7A6"/>
            <rect x="82" y="278" width="16" height="25" rx="2" fill="#FFD700"/>
            <line x1="78" y1="285" x2="102" y2="285" stroke="#FFD700" stroke-width="8"/>
            <text x="90" y="320" text-anchor="middle" fill="#FFF" font-size="9">Gilet HV</text>
            <!-- Titre -->
            <text x="150" y="30" text-anchor="middle" fill="#333" font-size="16" font-weight="bold">Protection sur la route</text>
            <text x="150" y="50" text-anchor="middle" fill="#666" font-size="11">Triangle √† 30m minimum en amont</text>
            <!-- Instructions -->
            <text x="150" y="360" text-anchor="middle" fill="#333" font-size="10">‚úì Gilet haute visibilit√©   ‚úì Triangle √† 30m   ‚úì Feux de d√©tresse</text>
        </svg>
    `;
}

// ==================== IC√îNES SVG DES COFFRES ====================

function getTreasureChestSVG(color, isLocked) {
    const gradientId = `chest-gradient-${Math.random().toString(36).substr(2, 9)}`;
    return `
        <svg viewBox="0 0 100 100" class="w-full h-full">
            <defs>
                <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:${color.from};stop-opacity:1" />
                    <stop offset="100%" style="stop-color:${color.to};stop-opacity:1" />
                </linearGradient>
            </defs>
            <!-- Corps du coffre -->
            <rect x="15" y="45" width="70" height="40" rx="5" fill="url(#${gradientId})" stroke="#8B4513" stroke-width="2"/>
            <!-- Couvercle du coffre ${isLocked ? '(ferm√©)' : '(ouvert)'}-->
            ${isLocked ? `
                <path d="M 15 45 Q 15 35, 20 30 L 80 30 Q 85 35, 85 45 Z" fill="url(#${gradientId})" stroke="#8B4513" stroke-width="2"/>
                <rect x="15" y="43" width="70" height="4" fill="#654321"/>
                <!-- Serrure -->
                <circle cx="50" cy="55" r="8" fill="#FFD700" stroke="#DAA520" stroke-width="1.5"/>
                <rect x="48" y="55" width="4" height="12" fill="#DAA520" rx="1"/>
                <!-- Fermoir -->
                <rect x="20" y="53" width="60" height="3" fill="#8B4513" opacity="0.6"/>
            ` : `
                <path d="M 15 25 Q 15 15, 20 10 L 80 10 Q 85 15, 85 25 L 85 45 L 15 45 Z" fill="url(#${gradientId})" stroke="#8B4513" stroke-width="2"/>
                <rect x="15" y="23" width="70" height="4" fill="#654321"/>
                <!-- Int√©rieur visible -->
                <rect x="20" y="45" width="60" height="5" fill="#FFE4B5"/>
                <!-- √âclat lumineux (tr√©sor) -->
                <circle cx="50" cy="50" r="3" fill="#FFD700" opacity="0.8"/>
                <path d="M 50 47 L 52 50 L 50 53 L 48 50 Z" fill="#FFF" opacity="0.6"/>
            `}
            <!-- D√©tails d√©coratifs -->
            <rect x="25" y="60" width="50" height="2" fill="#654321" opacity="0.5"/>
            <rect x="30" y="70" width="40" height="2" fill="#654321" opacity="0.5"/>
        </svg>
    `;
}

function getSafeSVG(color, isLocked) {
    const gradientId = `safe-gradient-${Math.random().toString(36).substr(2, 9)}`;
    return `
        <svg viewBox="0 0 100 100" class="w-full h-full">
            <defs>
                <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:${color.from};stop-opacity:1" />
                    <stop offset="100%" style="stop-color:${color.to};stop-opacity:1" />
                </linearGradient>
                <radialGradient id="${gradientId}-radial">
                    <stop offset="0%" style="stop-color:#C0C0C0;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#606060;stop-opacity:1" />
                </radialGradient>
            </defs>
            <!-- Corps du coffre-fort -->
            <rect x="20" y="25" width="60" height="55" rx="3" fill="url(#${gradientId})" stroke="#333" stroke-width="2"/>
            <!-- Cadre de porte -->
            <rect x="25" y="30" width="50" height="45" rx="2" fill="none" stroke="#666" stroke-width="1.5"/>
            <!-- Molette centrale -->
            <circle cx="50" cy="52" r="15" fill="url(#${gradientId}-radial)" stroke="#333" stroke-width="2"/>
            <circle cx="50" cy="52" r="12" fill="none" stroke="#999" stroke-width="1"/>
            <circle cx="50" cy="52" r="3" fill="#FFD700"/>
            <!-- Graduations de la molette -->
            ${[0, 30, 60, 90, 120, 150, 180, 210, 240, 270, 300, 330].map(angle => {
                const rad = (angle * Math.PI) / 180;
                const x1 = 50 + Math.cos(rad) * 10;
                const y1 = 52 + Math.sin(rad) * 10;
                const x2 = 50 + Math.cos(rad) * 12;
                const y2 = 52 + Math.sin(rad) * 12;
                return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#666" stroke-width="1"/>`;
            }).join('')}
            <!-- Poign√©e -->
            ${isLocked ? `
                <rect x="68" y="50" width="8" height="4" rx="2" fill="#C0C0C0" stroke="#666" stroke-width="1"/>
            ` : `
                <rect x="68" y="48" width="4" height="8" rx="2" fill="#C0C0C0" stroke="#666" stroke-width="1"/>
            `}
            <!-- Charni√®res -->
            <circle cx="23" cy="35" r="2" fill="#666"/>
            <circle cx="23" cy="70" r="2" fill="#666"/>
            <!-- Indicateur d√©verrouill√© -->
            ${!isLocked ? `<circle cx="50" cy="30" r="3" fill="#00FF00" opacity="0.8"/>` : ''}
        </svg>
    `;
}

// ==================== CONFETTIS ====================

function createConfetti() {
    const container = document.getElementById('confetti-container');
    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffd700', '#ff69b4', '#32CD32', '#FF6347'];
    const shapes = ['‚óè', '‚ñ†', '‚ñ≤', '‚òÖ', '‚ô¶', '‚ú®', 'üéâ', 'üéä', '‚≠ê', 'üí´'];

    // Confettis normaux
    for (let i = 0; i < 120; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti absolute text-2xl pointer-events-none';
            confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.top = '-20px';
            confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 0.3 + 's';
            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
            confetti.style.opacity = Math.random() * 0.5 + 0.5;
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            container.appendChild(confetti);

            setTimeout(() => confetti.remove(), 5000);
        }, i * 25);
    }

    // Feux d'artifice (particules qui explosent)
    for (let i = 0; i < 3; i++) {
        setTimeout(() => {
            createFirework();
        }, i * 400);
    }
}

function createFirework() {
    const container = document.getElementById('confetti-container');
    const centerX = Math.random() * 80 + 10; // Entre 10% et 90%
    const centerY = Math.random() * 50 + 10; // Entre 10% et 60%
    const colors = ['#FFD700', '#FF6347', '#32CD32', '#1E90FF', '#FF69B4', '#FFA500'];
    const color = colors[Math.floor(Math.random() * colors.length)];

    // Cr√©er 20 particules qui explosent depuis le centre
    for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.className = 'absolute pointer-events-none';
        particle.style.width = '8px';
        particle.style.height = '8px';
        particle.style.borderRadius = '50%';
        particle.style.backgroundColor = color;
        particle.style.left = centerX + '%';
        particle.style.top = centerY + '%';
        particle.style.boxShadow = `0 0 10px ${color}`;

        const angle = (Math.PI * 2 * i) / 20;
        const velocity = 100 + Math.random() * 50;
        const dx = Math.cos(angle) * velocity;
        const dy = Math.sin(angle) * velocity;

        container.appendChild(particle);

        let posX = 0;
        let posY = 0;
        let opacity = 1;
        const animation = setInterval(() => {
            posX += dx * 0.05;
            posY += dy * 0.05 + 2; // Gravit√©
            opacity -= 0.02;

            particle.style.transform = `translate(${posX}px, ${posY}px)`;
            particle.style.opacity = opacity;

            if (opacity <= 0) {
                clearInterval(animation);
                particle.remove();
            }
        }, 16);
    }
}

// Effet de particules lors de l'ouverture d'un coffre
function createChestOpenEffect(element) {
    const rect = element.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;

    const colors = ['#FFD700', '#FFA500', '#FFFF00'];

    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const particle = document.createElement('div');
            particle.className = 'absolute pointer-events-none text-2xl';
            particle.textContent = '‚ú®';
            particle.style.left = centerX + 'px';
            particle.style.top = centerY + 'px';
            particle.style.color = colors[Math.floor(Math.random() * colors.length)];
            particle.style.zIndex = '9999';
            document.body.appendChild(particle);

            const angle = Math.random() * Math.PI * 2;
            const velocity = 50 + Math.random() * 100;
            const dx = Math.cos(angle) * velocity;
            const dy = Math.sin(angle) * velocity - 50; // Vers le haut initialement

            let posX = 0;
            let posY = 0;
            let opacity = 1;
            let rotation = 0;

            const animation = setInterval(() => {
                posX += dx * 0.05;
                posY += dy * 0.05;
                dy += 3; // Gravit√©
                opacity -= 0.015;
                rotation += 10;

                particle.style.transform = `translate(${posX}px, ${posY}px) rotate(${rotation}deg)`;
                particle.style.opacity = opacity;

                if (opacity <= 0) {
                    clearInterval(animation);
                    particle.remove();
                }
            }, 16);
        }, i * 20);
    }

    playSound('success');
}

// ==================== DONN√âES DU JEU ====================

const boxesData = [
    {
        title: 'DC1 - Prot√©ger',
        subtitle: 'Situer son r√¥le de SST',
        icon: 'üõ°Ô∏è',
        color: 'from-blue-500 to-blue-700',
        games: [
            // Jeu 1 avec 8 variations
            [
                {
                    type: 'quiz',
                    title: 'DC1.1 - Cadre juridique du SST',
                    question: 'Quel est le cadre juridique qui d√©finit le r√¥le du Sauveteur Secouriste du Travail en France ?',
                    options: [
                        'Le Code du Travail (Article R4224-15)',
                        'Le Code Civil',
                        'Le Code de la Sant√© Publique',
                        'Le R√®glement Int√©rieur de l\'entreprise'
                    ],
                    correctAnswer: 0,
                    timeLimit: 60,
                    points: 100
                },
                {
                    type: 'quiz',
                    title: 'DC1.1 - R√¥le du SST',
                    question: 'Quel est le r√¥le principal d\'un SST sur son lieu de travail ?',
                    options: [
                        'Remplacer les services d\'urgence',
                        'Porter les premiers secours et pr√©venir les risques',
                        'Soigner toutes les blessures',
                        'Evacuer les victimes'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 100
                },
                {
                    type: 'quiz-multi',
                    title: 'DC1.1 - Missions du SST',
                    question: 'Quelles sont les missions d\'un SST ? (Plusieurs r√©ponses)',
                    options: [
                        'Prot√©ger',
                        'Examiner',
                        'Prescrire des m√©dicaments',
                        'Faire alerter',
                        'Secourir',
                        'Transporter la victime'
                    ],
                    correctAnswers: [0, 1, 3, 4],
                    timeLimit: 70,
                    points: 120
                },
                {
                    type: 'quiz',
                    title: 'DC1.1 - Formation SST',
                    question: 'Quelle est la dur√©e de validit√© d\'un certificat SST ?',
                    options: [
                        '1 an',
                        '2 ans',
                        '3 ans',
                        '5 ans'
                    ],
                    correctAnswer: 1,
                    timeLimit: 50,
                    points: 100
                },
                {
                    type: 'quiz',
                    title: 'DC1.1 - Nombre de SST',
                    question: 'Combien de SST minimum doit-on avoir dans une entreprise de moins de 20 salari√©s ?',
                    options: [
                        'Aucun',
                        '1 SST',
                        '2 SST',
                        '5% de l\'effectif'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'quiz-multi',
                    title: 'DC1.1 - Obligations du SST',
                    question: 'Quelles sont les obligations du SST ? (Plusieurs r√©ponses)',
                    options: [
                        'Intervenir imm√©diatement en cas d\'accident',
                        'Se recycler tous les 2 ans',
                        'Remplacer le m√©decin du travail',
                        'Conna√Ætre les risques de l\'entreprise',
                        'Prodiguer les premiers secours'
                    ],
                    correctAnswers: [0, 1, 3, 4],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'DC1.1 - Responsabilit√©',
                    question: 'Un SST peut-il √™tre poursuivi pour non-assistance √† personne en danger ?',
                    options: [
                        'Non, jamais',
                        'Oui, comme tout citoyen',
                        'Seulement durant ses heures de travail',
                        'Seulement s\'il est dipl√¥m√©'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 110
                },
                {
                    type: 'quiz',
                    title: 'DC1.1 - Pr√©vention',
                    question: 'En plus des secours, quel est l\'autre r√¥le majeur du SST ?',
                    options: [
                        'Nettoyer les lieux de l\'accident',
                        'Participer √† la pr√©vention des risques',
                        'Former les autres salari√©s',
                        'G√©rer la trousse de secours'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'true-false',
                    title: 'DC1.1 - Vrai ou Faux',
                    question: 'Un SST peut administrer des m√©dicaments √† une victime.',
                    options: ['Vrai', 'Faux'],
                    correctAnswer: 1,
                    explanation: 'FAUX - Un SST ne peut jamais administrer de m√©dicaments. C\'est un acte m√©dical r√©serv√© aux professionnels de sant√©.',
                    timeLimit: 45,
                    points: 90
                },
                {
                    type: 'true-false',
                    title: 'DC1.1 - Vrai ou Faux',
                    question: 'Le certificat SST doit √™tre recycl√© tous les 2 ans.',
                    options: ['Vrai', 'Faux'],
                    correctAnswer: 0,
                    explanation: 'VRAI - Le recyclage SST doit avoir lieu tous les 24 mois pour maintenir la validit√© du certificat.',
                    timeLimit: 45,
                    points: 90
                }
            ],
            // Nouveaux jeux Vrai/Faux
            {
                type: 'true-false',
                title: 'DC1.1 - Vrai ou Faux',
                question: 'Le SST doit toujours rester sur les lieux jusqu\'√† l\'arriv√©e des secours sp√©cialis√©s.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Le SST doit rester avec la victime et maintenir les gestes de secours jusqu\'√† la prise en charge par les secours sp√©cialis√©s.',
                timeLimit: 45,
                points: 90
            },
            {
                type: 'true-false',
                title: 'DC1.1 - Vrai ou Faux',
                question: 'Le SST peut utiliser n\'importe quel mat√©riel m√©dical disponible dans l\'entreprise.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - Le SST ne peut utiliser que le mat√©riel pour lequel il est form√© (DAE, trousse de secours basique). Il ne peut pas utiliser de mat√©riel m√©dical sp√©cialis√©.',
                timeLimit: 50,
                points: 95
            },
            // Jeu 2 avec 6 variations
            [
                {
                    type: 'matching',
                    title: 'DC1.2 - D√©limiter son champ d\'intervention',
                    question: 'Associez chaque action avec le bon intervenant :',
                    pairs: [
                        { left: 'Porter les premiers secours', right: 'SST' },
                        { left: 'Prescrire un traitement m√©dical', right: 'M√©decin' },
                        { left: 'Prot√©ger et alerter', right: 'SST' },
                        { left: 'Transporter la victime √† l\'h√¥pital', right: 'Secours sp√©cialis√©s' }
                    ],
                    timeLimit: 90,
                    points: 120
                },
                {
                    type: 'quiz',
                    title: 'DC1.2 - Limite d\'intervention du SST',
                    question: 'Quelle est la limite d\'intervention du SST ?',
                    options: [
                        'Jusqu\'√† l\'arriv√©e des secours sp√©cialis√©s',
                        'Jusqu\'√† la gu√©rison compl√®te',
                        'Pendant 24 heures',
                        'Il n\'y a pas de limite'
                    ],
                    correctAnswer: 0,
                    timeLimit: 70,
                    points: 110
                },
                {
                    type: 'matching',
                    title: 'DC1.2 - R√¥les et responsabilit√©s',
                    question: 'Associez chaque intervenant √† sa responsabilit√© :',
                    pairs: [
                        { left: 'R√©animation cardio-pulmonaire', right: 'SST' },
                        { left: 'Diagnostic m√©dical', right: 'M√©decin' },
                        { left: 'Transport m√©dicalis√©', right: 'SMUR' },
                        { left: 'Mise en s√©curit√©', right: 'SST' }
                    ],
                    timeLimit: 85,
                    points: 120
                },
                {
                    type: 'quiz',
                    title: 'DC1.2 - Mat√©riel SST',
                    question: 'Le SST peut-il utiliser un d√©fibrillateur automatis√© externe (DAE) ?',
                    options: [
                        'Non, il faut une formation sp√©cifique',
                        'Oui, tout citoyen peut l\'utiliser',
                        'Seulement les pompiers',
                        'Uniquement sur prescription m√©dicale'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 100
                },
                {
                    type: 'sequence',
                    title: 'DC1.2 - Cha√Æne de secours',
                    question: 'Remettez dans l\'ordre les √©tapes de la cha√Æne de secours :',
                    items: [
                        'Prot√©ger',
                        'Examiner',
                        'Faire alerter / Alerter',
                        'Secourir'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 65,
                    points: 120
                },
                {
                    type: 'puzzle-text',
                    title: 'DC1.2 - Conduites √† tenir',
                    question: 'Reconstituez les 4 grandes actions du SST dans le bon ordre :',
                    pieces: [
                        '1. Prot√©ger',
                        '2. Examiner',
                        '3. Faire alerter ou alerter',
                        '4. Secourir'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 70,
                    points: 120
                }
            ]
        ]
    },
    {
        title: 'DC1 - Prot√©ger',
        subtitle: 'Prot√©ger de fa√ßon adapt√©e',
        icon: '‚ö†Ô∏è',
        color: 'from-red-500 to-red-700',
        games: [
            // Jeu 1 avec 6 variations
            [
                {
                    type: 'sequence',
                    title: 'Partie 2 - Reconna√Ætre les dangers',
                    question: 'Remettez dans l\'ordre les √©tapes pour reconna√Ætre les dangers persistants :',
                    items: [
                        'Observer la situation',
                        'Identifier les dangers',
                        'Rep√©rer les personnes expos√©es',
                        'Imaginer les accidents possibles'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 2 - Dangers persistants',
                    question: 'Quels sont les dangers persistants qui n√©cessitent une protection ? (Plusieurs r√©ponses)',
                    options: [
                        'Risque √©lectrique',
                        'Risque d\'incendie ou d\'explosion',
                        'Risque d\'√©crasement',
                        'Victime qui tousse',
                        'Atmosph√®re toxique',
                        'Risque routier'
                    ],
                    correctAnswers: [0, 1, 2, 4, 5],
                    timeLimit: 80,
                    points: 140
                },
                {
                    type: 'quiz',
                    title: 'Partie 2 - Protection √©lectrique',
                    question: 'Face √† un danger √©lectrique, que devez-vous faire EN PREMIER ?',
                    options: [
                        'Tirer la victime par les v√™tements',
                        'Couper le courant',
                        'Appeler les pompiers',
                        'Faire un massage cardiaque'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'matching',
                    title: 'Partie 2 - Types de dangers',
                    question: 'Associez chaque danger √† sa cat√©gorie :',
                    pairs: [
                        { left: 'C√¢ble √©lectrique d√©nud√©', right: 'Risque √©lectrique' },
                        { left: 'Fuite de gaz', right: 'Risque d\'explosion' },
                        { left: 'V√©hicule en marche', right: 'Risque d\'√©crasement' },
                        { left: 'Fum√©e dense', right: 'Atmosph√®re toxique' }
                    ],
                    timeLimit: 90,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 2 - P√©rim√®tre de s√©curit√©',
                    question: 'Pourquoi faut-il d√©limiter un p√©rim√®tre de s√©curit√© ?',
                    options: [
                        'Pour emp√™cher les curieux',
                        'Pour √©viter le sur-accident',
                        'Pour impressionner les secours',
                        'Pour isoler la victime'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 100
                },
                {
                    type: 'quiz-illustrated',
                    illustrationFunction: 'getTriangleSVG',
                    title: 'Partie 2 - Sch√©ma de protection',
                    question: '√Ä quelle distance minimum doit-on placer le triangle de pr√©signalisation en cas d\'accident ?',
                    options: [
                        '10 m√®tres',
                        '20 m√®tres',
                        '30 m√®tres',
                        '50 m√®tres'
                    ],
                    correctAnswer: 2,
                    timeLimit: 70,
                    points: 110
                }
            ],
            // Nouveaux jeux Vrai/Faux - Prot√©ger
            {
                type: 'true-false',
                title: 'Partie 2 - Vrai ou Faux',
                question: 'On peut d√©placer une victime dans tous les cas pour la mettre en s√©curit√©.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - On ne d√©place une victime que si un danger vital, imm√©diat et impossible √† supprimer menace. Le d√©placement peut aggraver les l√©sions.',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 2 - Vrai ou Faux',
                question: 'Le triangle de signalisation doit √™tre plac√© √† au moins 30 m√®tres en amont de l\'accident.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Le triangle de pr√©signalisation doit √™tre plac√© √† minimum 30 m√®tres (distance de visibilit√©) pour permettre aux autres v√©hicules de ralentir √† temps.',
                timeLimit: 45,
                points: 90
            },
            {
                type: 'true-false',
                title: 'Partie 2 - Vrai ou Faux',
                question: 'La protection du sauveteur passe avant celle de la victime.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Le sauveteur doit d\'abord assurer sa propre s√©curit√©. Un sauveteur bless√© ne peut plus porter secours et devient une victime suppl√©mentaire.',
                timeLimit: 50,
                points: 95
            },
            // Jeu 2 avec 5 variations
            [
                {
                    type: 'quiz-multi',
                    title: 'Partie 2 - Actions de protection',
                    question: 'Quelles actions permettent de prot√©ger ? (Plusieurs r√©ponses)',
                    options: [
                        'Couper le courant',
                        'Baliser la zone',
                        'D√©placer la victime imm√©diatement',
                        'Fermer l\'arriv√©e de gaz',
                        'Faire √©vacuer la zone',
                        'Donner √† boire √† la victime'
                    ],
                    correctAnswers: [0, 1, 3, 4],
                    timeLimit: 85,
                    points: 140
                },
                {
                    type: 'sequence',
                    title: 'Partie 2 - Prot√©ger sur la route',
                    question: 'Ordre des actions pour prot√©ger sur un accident de la route :',
                    items: [
                        'Allumer les feux de d√©tresse',
                        'Mettre le gilet haute visibilit√©',
                        'Placer le triangle 30m en amont',
                        'Faire √©vacuer les victimes valides'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 2 - D√©gagement d\'urgence',
                    question: 'Quand peut-on d√©placer une victime ?',
                    options: [
                        'Toujours, pour la mettre √† l\'aise',
                        'Jamais, il faut attendre les secours',
                        'Uniquement si un danger vital imm√©diat et impossible √† supprimer menace',
                        'D√®s qu\'elle saigne'
                    ],
                    correctAnswer: 2,
                    timeLimit: 70,
                    points: 120
                },
                {
                    type: 'matching',
                    title: 'Partie 2 - Moyens de protection',
                    question: 'Associez chaque danger √† son moyen de protection :',
                    pairs: [
                        { left: 'Incendie', right: 'Extincteur / √âvacuation' },
                        { left: '√âlectricit√©', right: 'Coupure du courant' },
                        { left: 'Gaz', right: 'Fermeture vanne + a√©ration' },
                        { left: 'Accident route', right: 'Triangle + balisage' }
                    ],
                    timeLimit: 90,
                    points: 130
                },
                {
                    type: 'puzzle-text',
                    title: 'Partie 2 - Ordre de priorit√©',
                    question: 'Reconstituez l\'ordre de priorit√© dans la protection :',
                    pieces: [
                        '1. Se prot√©ger soi-m√™me',
                        '2. Prot√©ger les autres',
                        '3. Prot√©ger la victime',
                        '4. Supprimer ou isoler le danger'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                }
            ]
        ]
    },
    {
        title: 'DC2 - Examiner',
        subtitle: 'Examiner la victime',
        icon: 'üîç',
        color: 'from-green-500 to-green-700',
        games: [
            // Jeu 1 avec 6 variations
            [
                {
                    type: 'sequence',
                    title: 'Partie 2.1 - Ordre d\'examen',
                    question: 'Dans quel ordre examinez-vous une victime ?',
                    items: [
                        'V√©rifier la conscience',
                        'V√©rifier la respiration',
                        'Rechercher une h√©morragie',
                        'Rechercher d\'autres signes'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 70,
                    points: 120
                },
                {
                    type: 'matching',
                    title: 'Partie 2.1 - Signes et sympt√¥mes',
                    question: 'Associez chaque signe avec sa cat√©gorie :',
                    pairs: [
                        { left: 'Victime ne r√©pond pas', right: 'Inconscience' },
                        { left: 'Ventre ou thorax qui se soul√®ve', right: 'Respiration pr√©sente' },
                        { left: 'Saignement abondant', right: 'H√©morragie externe' },
                        { left: 'Br√ªlure, plaie, douleur', right: 'Autres signes' }
                    ],
                    timeLimit: 85,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 2.1 - Conscience',
                    question: 'Comment v√©rifier la conscience d\'une victime ?',
                    options: [
                        'Lui poser une question simple et secouer doucement les √©paules',
                        'La gifler',
                        'Lui verser de l\'eau froide',
                        'Attendre qu\'elle se r√©veille'
                    ],
                    correctAnswer: 0,
                    timeLimit: 60,
                    points: 100
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 2.1 - Respiration',
                    question: 'Comment v√©rifier si une victime respire ? (Plusieurs m√©thodes)',
                    options: [
                        'Voir si le ventre/thorax se soul√®ve',
                        'Sentir le souffle sur la joue',
                        '√âcouter les bruits respiratoires',
                        'Prendre le pouls',
                        'Regarder la couleur des l√®vres',
                        'Mettre un miroir sous le nez'
                    ],
                    correctAnswers: [0, 1, 2],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 2.1 - H√©morragie',
                    question: 'Qu\'est-ce qu\'une h√©morragie externe ?',
                    options: [
                        'Un saignement visible qui ne s\'arr√™te pas',
                        'Un h√©matome',
                        'Une √©gratignure',
                        'Un saignement de nez'
                    ],
                    correctAnswer: 0,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'quiz-illustrated',
                    illustrationFunction: 'getLVASVG',
                    title: 'Partie 2.1 - Position LVA',
                    question: 'Comment lib√®re-t-on les voies a√©riennes avant de v√©rifier la respiration ?',
                    options: [
                        'Une main sur le front, l\'autre sous le menton, et basculer la t√™te en arri√®re',
                        'Tourner la t√™te sur le c√¥t√©',
                        'Soulever les √©paules',
                        'Mettre un oreiller sous la t√™te'
                    ],
                    correctAnswer: 0,
                    timeLimit: 70,
                    points: 110
                }
            ],
            // Nouveaux jeux Vrai/Faux - Examiner
            {
                type: 'true-false',
                title: 'Partie 2.1 - Vrai ou Faux',
                question: 'Pour v√©rifier la respiration, il suffit de prendre le pouls de la victime.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - La prise de pouls n\'est pas fiable pour v√©rifier la respiration. Il faut utiliser la m√©thode VES (Voir, √âcouter, Sentir) pendant 10 secondes.',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 2.1 - Vrai ou Faux',
                question: 'Une victime inconsciente qui respire doit √™tre mise en Position Lat√©rale de S√©curit√© (PLS).',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - La PLS permet d\'√©viter l\'obstruction des voies a√©riennes par la langue ou les liquides (vomissements, sang) chez une victime inconsciente qui respire.',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 2.1 - Vrai ou Faux',
                question: 'L\'examen de la victime doit toujours commencer par la recherche d\'une h√©morragie.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - L\'examen commence toujours par la v√©rification de la conscience, puis de la respiration, et ensuite la recherche d\'une h√©morragie externe.',
                timeLimit: 50,
                points: 95
            },
            // Jeu 2 avec 5 variations
            [
                {
                    type: 'sequence',
                    title: 'Partie 2.1 - Bilan vital',
                    question: 'Ordre des v√©rifications pour le bilan vital :',
                    items: [
                        'Parler √† la victime',
                        'Lib√©rer les voies a√©riennes',
                        'V√©rifier la respiration 10 secondes',
                        'Rechercher une h√©morragie visible'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 70,
                    points: 120
                },
                {
                    type: 'quiz',
                    title: 'Partie 2.1 - Signes de d√©tresse',
                    question: 'Quel signe indique une d√©tresse vitale imm√©diate ?',
                    options: [
                        'Une petite plaie au doigt',
                        'L\'absence de respiration',
                        'Une douleur au genou',
                        'Une l√©g√®re br√ªlure'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'matching',
                    title: 'Partie 2.1 - √âtat de conscience',
                    question: 'Associez chaque r√©ponse √† l\'√©tat de conscience :',
                    pairs: [
                        { left: 'R√©pond √† la question', right: 'Consciente' },
                        { left: 'Ouvre les yeux au bruit', right: 'Semi-consciente' },
                        { left: 'Aucune r√©action', right: 'Inconsciente' },
                        { left: 'Parle de mani√®re confuse', right: 'Consciente alt√©r√©e' }
                    ],
                    timeLimit: 85,
                    points: 130
                },
                {
                    type: 'puzzle-text',
                    title: 'Partie 2.1 - M√©thode Ver √âcouter Sentir',
                    question: 'Reconstituez la m√©thode VES (Voir √âcouter Sentir) :',
                    pieces: [
                        '1. Basculer doucement la t√™te en arri√®re',
                        '2. VOIR le ventre/thorax se soulever',
                        '3. √âCOUTER les bruits respiratoires',
                        '4. SENTIR le souffle sur la joue'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 2.1 - Autres signes',
                    question: 'Quels autres signes devez-vous rechercher ? (Plusieurs r√©ponses)',
                    options: [
                        'Plaies',
                        'Br√ªlures',
                        'D√©formations',
                        'Couleur des cheveux',
                        'Douleurs',
                        'Taille de la victime'
                    ],
                    correctAnswers: [0, 1, 2, 4],
                    timeLimit: 70,
                    points: 130
                }
            ]
        ]
    },
    {
        title: 'DC2 - Alerter',
        subtitle: 'Faire alerter ou alerter',
        icon: 'üìû',
        color: 'from-yellow-500 to-orange-600',
        games: [
            // Jeu 1 avec 7 variations
            [
                {
                    type: 'puzzle-text',
                    title: 'Partie 6 - Message d\'alerte',
                    question: 'Reconstituez le message d\'alerte dans le bon ordre :',
                    pieces: [
                        '1. Num√©ro de t√©l√©phone',
                        '2. Lieu pr√©cis de l\'accident',
                        '3. Nature de l\'accident',
                        '4. Nombre de victimes',
                        '5. √âtat de chaque victime',
                        '6. Gestes effectu√©s'
                    ],
                    correctOrder: [0, 1, 2, 3, 4, 5],
                    timeLimit: 80,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 6 - Num√©ros d\'urgence',
                    question: 'Quel num√©ro d\'urgence devez-vous appeler pour un accident du travail avec victime grave ?',
                    options: [
                        '15 - SAMU (urgence m√©dicale)',
                        '17 - Police',
                        '112 - Num√©ro europ√©en',
                        'Le num√©ro interne de l\'entreprise uniquement'
                    ],
                    correctAnswer: 0,
                    timeLimit: 50,
                    points: 100
                },
                {
                    type: 'matching',
                    title: 'Partie 6 - Num√©ros d\'urgence',
                    question: 'Associez chaque num√©ro √† son service :',
                    pairs: [
                        { left: '15', right: 'SAMU' },
                        { left: '18', right: 'Pompiers' },
                        { left: '112', right: 'Num√©ro europ√©en' },
                        { left: '114', right: 'Sourds et malentendants' }
                    ],
                    timeLimit: 75,
                    points: 120
                },
                {
                    type: 'quiz',
                    title: 'Partie 6 - Qui alerte ?',
                    question: 'Si vous √™tes seul avec une victime en arr√™t cardiaque, que faites-vous ?',
                    options: [
                        'Vous restez avec la victime sans alerter',
                        'Vous alertez les secours AVANT de commencer la r√©animation',
                        'Vous attendez de l\'aide',
                        'Vous partez chercher un d√©fibrillateur'
                    ],
                    correctAnswer: 1,
                    timeLimit: 65,
                    points: 110
                },
                {
                    type: 'sequence',
                    title: 'Partie 6 - Contenu de l\'alerte',
                    question: 'Ordre des informations √† donner aux secours :',
                    items: [
                        'Lieu exact et acc√®s',
                        'Nature de l\'accident',
                        'Nombre et √©tat des victimes',
                        'Gestes d√©j√† effectu√©s'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 70,
                    points: 120
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 6 - Informations importantes',
                    question: 'Que devez-vous pr√©ciser lors de l\'alerte ? (Plusieurs r√©ponses)',
                    options: [
                        'L\'adresse exacte',
                        'Votre nom',
                        'L\'√©tat de la victime',
                        'La m√©t√©o',
                        'Les gestes effectu√©s',
                        'Votre √¢ge'
                    ],
                    correctAnswers: [0, 1, 2, 4],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 6 - Fin de l\'appel',
                    question: 'Qui raccroche en premier lors d\'un appel aux secours ?',
                    options: [
                        'Vous, d√®s que vous avez tout dit',
                        'Le r√©gulateur des secours',
                        'Peu importe',
                        'Personne, on laisse la ligne ouverte'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 100
                }
            ],
            // Nouveaux jeux Vrai/Faux - Alerter
            {
                type: 'true-false',
                title: 'Partie 6 - Vrai ou Faux',
                question: 'Le num√©ro 112 fonctionne dans tous les pays de l\'Union Europ√©enne.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Le 112 est le num√©ro d\'urgence europ√©en unique. Il est gratuit et accessible partout dans l\'UE, m√™me sans r√©seau de votre op√©rateur.',
                timeLimit: 45,
                points: 90
            },
            {
                type: 'true-false',
                title: 'Partie 6 - Vrai ou Faux',
                question: 'On peut raccrocher d√®s que l\'on a donn√© l\'adresse et le nombre de victimes.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - Il faut toujours attendre que le r√©gulateur vous dise de raccrocher. Il peut avoir besoin d\'informations compl√©mentaires ou vous donner des consignes.',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 6 - Vrai ou Faux',
                question: 'Si on est seul face √† une victime en arr√™t cardiaque, il faut d\'abord commencer la r√©animation avant d\'alerter.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - L\'alerte est prioritaire en cas d\'arr√™t cardiaque. Il faut d\'abord alerter (ou faire alerter) pour que les secours arrivent le plus vite possible, puis commencer la r√©animation.',
                timeLimit: 55,
                points: 100
            },
            // Jeu 2 avec 5 variations
            [
                {
                    type: 'quiz',
                    title: 'Partie 6 - Moyens d\'alerte',
                    question: 'Quel est le meilleur moyen pour alerter les secours ?',
                    options: [
                        'Envoyer un SMS',
                        'T√©l√©phoner',
                        'Envoyer quelqu\'un pr√©venir',
                        'Crier'
                    ],
                    correctAnswer: 1,
                    timeLimit: 50,
                    points: 100
                },
                {
                    type: 'sequence',
                    title: 'Partie 6 - Faire alerter',
                    question: 'Si vous faites alerter par un t√©moin, dans quel ordre proc√©der :',
                    items: [
                        'D√©signer une personne pr√©cise',
                        'Lui dire quel num√©ro appeler',
                        'Lui dire quoi dire',
                        'Lui demander de revenir vous informer'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'matching',
                    title: 'Partie 6 - Situations et num√©ros',
                    question: 'Associez chaque situation au num√©ro appropri√© :',
                    pairs: [
                        { left: 'Malaise cardiaque', right: '15 - SAMU' },
                        { left: 'Incendie', right: '18 - Pompiers' },
                        { left: 'Agression', right: '17 - Police' },
                        { left: 'En Europe (voyage)', right: '112' }
                    ],
                    timeLimit: 85,
                    points: 130
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 6 - R√®gles de l\'alerte',
                    question: 'Quelles sont les r√®gles √† respecter lors de l\'alerte ? (Plusieurs r√©ponses)',
                    options: [
                        'Rester calme',
                        'Parler vite pour gagner du temps',
                        'R√©pondre aux questions',
                        'Raccrocher en premier',
                        'Donner des informations pr√©cises',
                        'Inventer si on ne sait pas'
                    ],
                    correctAnswers: [0, 2, 4],
                    timeLimit: 75,
                    points: 130
                }
            ]
        ]
    },
    {
        title: 'DC2 - Secourir',
        subtitle: 'H√©morragie externe',
        icon: 'ü©∏',
        color: 'from-red-600 to-pink-700',
        games: [
            // Jeu 1 avec 6 variations
            [
                {
                    type: 'sequence',
                    title: 'Partie 7.1 - Arr√™ter une h√©morragie',
                    question: 'Remettez dans l\'ordre les √©tapes pour arr√™ter une h√©morragie externe :',
                    items: [
                        'Allonger la victime',
                        'Comprimer directement sur la plaie',
                        'Faire alerter les secours',
                        'Surveiller la victime'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 70,
                    points: 120
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.1 - Compression directe',
                    question: 'Avec quoi effectuez-vous la compression directe en priorit√© ?',
                    options: [
                        'Avec un garrot',
                        'Avec vos mains prot√©g√©es',
                        'Avec un pansement compressif',
                        'En sur√©levant simplement le membre'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 110
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.1 - Protection',
                    question: 'Pourquoi faut-il se prot√©ger avant de comprimer une plaie ?',
                    options: [
                        'Pour ne pas salir ses mains',
                        'Pour se prot√©ger du sang (risque infectieux)',
                        'Ce n\'est pas obligatoire',
                        'Pour ne pas faire mal √† la victime'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 100
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 7.1 - Mat√©riel de compression',
                    question: 'Avec quoi peut-on comprimer une plaie ? (Plusieurs r√©ponses)',
                    options: [
                        'Main prot√©g√©e par un gant',
                        'Compresse propre',
                        'Linge propre',
                        'Main nue si rien d\'autre',
                        'Un mouchoir sale',
                        'Un tissu propre'
                    ],
                    correctAnswers: [0, 1, 2, 3, 5],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.1 - Dur√©e de compression',
                    question: 'Combien de temps faut-il maintenir la compression ?',
                    options: [
                        '1 minute',
                        '5 minutes',
                        'Jusqu\'√† l\'arriv√©e des secours',
                        '10 secondes'
                    ],
                    correctAnswer: 2,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'quiz-illustrated',
                    illustrationFunction: 'getCompressionSVG',
                    title: 'Partie 7.1 - Geste de compression',
                    question: 'Pourquoi faut-il prot√©ger ses mains avant de comprimer une plaie qui saigne ?',
                    options: [
                        'Pour ne pas salir ses mains',
                        'Pour se prot√©ger du risque infectieux (sang)',
                        'Ce n\'est pas n√©cessaire',
                        'Pour ne pas faire mal √† la victime'
                    ],
                    correctAnswer: 1,
                    timeLimit: 70,
                    points: 110
                }
            ],
            // Nouveaux jeux Vrai/Faux - H√©morragie
            {
                type: 'true-false',
                title: 'Partie 7.1 - Vrai ou Faux',
                question: 'Il faut toujours utiliser un garrot en cas d\'h√©morragie importante.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - Le garrot n\'est utilis√© qu\'en dernier recours si la compression directe est impossible ou inefficace (membre arrach√©, √©crasement, plusieurs victimes). La compression directe est la technique de premier choix.',
                timeLimit: 55,
                points: 100
            },
            {
                type: 'true-false',
                title: 'Partie 7.1 - Vrai ou Faux',
                question: 'On peut rel√¢cher la compression pour v√©rifier si le saignement s\'est arr√™t√©.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - Il ne faut JAMAIS rel√¢cher la compression. Elle doit √™tre maintenue jusqu\'√† l\'arriv√©e des secours sp√©cialis√©s qui prendront le relais.',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 7.1 - Vrai ou Faux',
                question: 'Une h√©morragie externe est toujours visible √† l\'≈ìil nu.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Une h√©morragie externe est par d√©finition un saignement abondant visible qui ne s\'arr√™te pas spontan√©ment. Une h√©morragie interne, elle, n\'est pas visible.',
                timeLimit: 45,
                points: 90
            },
            // Jeu 2 avec 5 variations
            [
                {
                    type: 'matching',
                    title: 'Partie 7.1 - Types d\'h√©morragies',
                    question: 'Associez chaque saignement √† sa cat√©gorie :',
                    pairs: [
                        { left: 'Saignement abondant qui ne s\'arr√™te pas', right: 'H√©morragie' },
                        { left: 'Petit saignement qui s\'arr√™te seul', right: 'Plaie simple' },
                        { left: 'Sang qui coule en nappe', right: 'H√©morragie veineuse' },
                        { left: 'Sang qui jaillit par jets', right: 'H√©morragie art√©rielle' }
                    ],
                    timeLimit: 90,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.1 - Position de la victime',
                    question: 'Quelle position adopter pour une victime qui saigne abondamment ?',
                    options: [
                        'Debout',
                        'Allong√©e',
                        'Assise',
                        'En position lat√©rale de s√©curit√©'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'sequence',
                    title: 'Partie 7.1 - Relais de compression',
                    question: 'Si vous devez relayer la compression, dans quel ordre :',
                    items: [
                        'Pr√©parer le relais (gants, compresse)',
                        'Positionner ses mains √† c√¥t√© des v√¥tres',
                        'Le relais appuie, vous retirez vos mains',
                        'V√©rifier que la compression est efficace'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 7.1 - Surveillance',
                    question: 'Que devez-vous surveiller chez une victime qui saigne ? (Plusieurs r√©ponses)',
                    options: [
                        'La conscience',
                        'La respiration',
                        'L\'efficacit√© de la compression',
                        'Sa temp√©rature',
                        'L\'apparition de p√¢leur/sueurs',
                        'Son humeur'
                    ],
                    correctAnswers: [0, 1, 2, 4],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'puzzle-text',
                    title: 'Partie 7.1 - Conduite √† tenir compl√®te',
                    question: 'Reconstituez la conduite √† tenir face √† une h√©morragie :',
                    pieces: [
                        '1. Allonger la victime',
                        '2. Comprimer la plaie',
                        '3. Faire alerter le 15',
                        '4. Surveiller en attendant les secours'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                }
            ]
        ]
    },
    {
        title: 'DC2 - Secourir',
        subtitle: 'Obstruction des voies a√©riennes',
        icon: 'üòÆ',
        color: 'from-purple-500 to-purple-700',
        games: [
            // Jeu 1 avec 6 variations
            [
                {
                    type: 'matching',
                    title: 'Partie 7.2 - Obstruction partielle vs totale',
                    question: 'Associez les signes avec le type d\'obstruction :',
                    pairs: [
                        { left: 'La victime peut parler', right: 'Obstruction partielle' },
                        { left: 'La victime ne peut plus parler ni tousser', right: 'Obstruction totale' },
                        { left: 'La victime tousse vigoureusement', right: 'Obstruction partielle' },
                        { left: 'Impossibilit√© de respirer', right: 'Obstruction totale' }
                    ],
                    timeLimit: 85,
                    points: 130
                },
                {
                    type: 'sequence',
                    title: 'Partie 7.2 - Obstruction totale',
                    question: 'Ordre des gestes en cas d\'obstruction totale (adulte) :',
                    items: [
                        'Donner 5 claques dans le dos',
                        'Si inefficace : 5 compressions abdominales',
                        'Alterner claques/compressions',
                        'Si inconscient : RCP'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.2 - Obstruction partielle',
                    question: 'Que faire en cas d\'obstruction partielle ?',
                    options: [
                        'Donner des claques dans le dos',
                        'Faire des compressions abdominales',
                        'Encourager la victime √† tousser',
                        'Mettre les doigts dans la bouche'
                    ],
                    correctAnswer: 2,
                    timeLimit: 60,
                    points: 110
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.2 - Claques dans le dos',
                    question: 'O√π donner les claques dans le dos ?',
                    options: [
                        'En bas du dos',
                        'Entre les deux omoplates',
                        'Sur la nuque',
                        'Sur le c√¥t√©'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.2 - Compressions abdominales',
                    question: 'O√π placer le poing pour les compressions abdominales (m√©thode de Heimlich) ?',
                    options: [
                        'Sur le sternum',
                        'Sur le nombril',
                        'Entre le nombril et l\'extr√©mit√© inf√©rieure du sternum',
                        'Sur les c√¥tes'
                    ],
                    correctAnswer: 2,
                    timeLimit: 65,
                    points: 110
                },
                {
                    type: 'quiz-illustrated',
                    illustrationFunction: 'getHeimlichSVG',
                    title: 'Partie 7.2 - Position des mains',
                    question: 'O√π doit-on placer le poing pour effectuer les compressions abdominales (m√©thode de Heimlich) ?',
                    options: [
                        'Sur le sternum',
                        'Entre le nombril et le sternum',
                        'Sur le nombril',
                        'En bas du dos'
                    ],
                    correctAnswer: 1,
                    timeLimit: 70,
                    points: 110
                }
            ],
            // Nouveaux jeux Vrai/Faux - Obstruction
            {
                type: 'true-false',
                title: 'Partie 7.2 - Vrai ou Faux',
                question: 'On doit encourager la victime √† tousser si elle pr√©sente une obstruction partielle.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Si la victime peut encore tousser, parler ou respirer (obstruction partielle), il faut l\'encourager √† tousser vigoureusement car c\'est le moyen le plus efficace pour expulser le corps √©tranger.',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 7.2 - Vrai ou Faux',
                question: 'Les compressions abdominales (Heimlich) peuvent √™tre utilis√©es sur une femme enceinte.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - Sur une femme enceinte ou une personne ob√®se, on r√©alise des compressions thoraciques √† la place des compressions abdominales pour √©viter de comprimer l\'abdomen.',
                timeLimit: 55,
                points: 100
            },
            {
                type: 'true-false',
                title: 'Partie 7.2 - Vrai ou Faux',
                question: 'Si la victime devient inconsciente suite √† une obstruction totale, on doit commencer la RCP.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Si la victime perd conscience, on l\'installe au sol et on commence imm√©diatement la r√©animation cardio-pulmonaire (RCP) avec 30 compressions thoraciques.',
                timeLimit: 55,
                points: 100
            },
            // Jeu 2 avec 5 variations
            [
                {
                    type: 'quiz-multi',
                    title: 'Partie 7.2 - Signes d\'obstruction totale',
                    question: 'Quels sont les signes d\'une obstruction totale ? (Plusieurs r√©ponses)',
                    options: [
                        'Impossibilit√© de parler',
                        'Toux vigoureuse',
                        'Impossibilit√© de tousser',
                        'Geste de la main √† la gorge',
                        'Parle normalement',
                        'Cyanose (bleuissement)'
                    ],
                    correctAnswers: [0, 2, 3, 5],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.2 - Nourrisson',
                    question: 'Pour un nourrisson en obstruction totale, que faire au lieu des compressions abdominales ?',
                    options: [
                        'Compressions thoraciques',
                        'Rien, attendre les secours',
                        'Secouer le b√©b√©',
                        'Mettre le doigt dans la bouche'
                    ],
                    correctAnswer: 0,
                    timeLimit: 60,
                    points: 110
                },
                {
                    type: 'sequence',
                    title: 'Partie 7.2 - Si victime inconsciente',
                    question: 'Si la victime devient inconsciente pendant la d√©sobstruction :',
                    items: [
                        'Allonger la victime sur le dos',
                        'Faire alerter le 15',
                        'D√©buter imm√©diatement la RCP',
                        'V√©rifier la bouche entre les cycles'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'matching',
                    title: 'Partie 7.2 - Techniques selon l\'√¢ge',
                    question: 'Associez la technique √† la cat√©gorie de victime :',
                    pairs: [
                        { left: 'Claques dans le dos + Heimlich', right: 'Adulte' },
                        { left: 'Claques dans le dos + compressions thoraciques', right: 'Nourrisson' },
                        { left: 'M√™me technique que l\'adulte', right: 'Enfant' },
                        { left: 'Adapt√©e √† la taille', right: 'Femme enceinte' }
                    ],
                    timeLimit: 90,
                    points: 130
                },
                {
                    type: 'puzzle-text',
                    title: 'Partie 7.2 - Proc√©dure compl√®te',
                    question: 'Ordre de la proc√©dure en cas d\'obstruction totale :',
                    pieces: [
                        '1. Encourager √† tousser (si partielle)',
                        '2. 5 claques dans le dos',
                        '3. 5 compressions abdominales',
                        '4. Alterner jusqu\'√† d√©sobstruction ou perte de conscience'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 80,
                    points: 130
                }
            ]
        ]
    },
    {
        title: 'DC2 - Secourir',
        subtitle: 'PLS et Arr√™t cardiaque',
        icon: 'üíì',
        color: 'from-pink-500 to-red-600',
        games: [
            // Jeu 1 avec 7 variations
            [
                {
                    type: 'quiz',
                    title: 'Partie 7.3 - Position Lat√©rale de S√©curit√©',
                    question: 'Quand met-on une victime en Position Lat√©rale de S√©curit√© (PLS) ?',
                    options: [
                        'Victime consciente avec douleur',
                        'Victime inconsciente qui respire',
                        'Victime en arr√™t cardiaque',
                        'Victime avec h√©morragie'
                    ],
                    correctAnswer: 1,
                    timeLimit: 50,
                    points: 100
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 7.4 - Arr√™t cardiaque',
                    question: 'Quels sont les signes d\'un arr√™t cardiaque ? (Plusieurs r√©ponses)',
                    options: [
                        'Victime inconsciente',
                        'Victime ne respire pas',
                        'Victime respire normalement',
                        'Absence de r√©action',
                        'Victime parle'
                    ],
                    correctAnswers: [0, 1, 3],
                    timeLimit: 70,
                    points: 130
                },
                {
                    type: 'sequence',
                    title: 'Partie 7.4 - R√©animation cardio-pulmonaire',
                    question: 'Ordre des √©tapes de la RCP :',
                    items: [
                        'Placer les mains au centre du thorax',
                        '30 compressions thoraciques',
                        '2 insufflations',
                        'Poursuivre les cycles 30/2'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 70,
                    points: 120
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.4 - Fr√©quence des compressions',
                    question: '√Ä quelle fr√©quence doivent √™tre r√©alis√©es les compressions thoraciques ?',
                    options: [
                        '60 par minute',
                        '100 √† 120 par minute',
                        '150 par minute',
                        '30 par minute'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 110
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.4 - Profondeur des compressions',
                    question: 'Quelle doit √™tre la profondeur des compressions thoraciques chez l\'adulte ?',
                    options: [
                        '2 cm',
                        '5 √† 6 cm',
                        '10 cm',
                        '1 cm'
                    ],
                    correctAnswer: 1,
                    timeLimit: 55,
                    points: 100
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.3 - Pourquoi la PLS ?',
                    question: 'Pourquoi met-on une victime inconsciente qui respire en PLS ?',
                    options: [
                        'Pour qu\'elle soit plus confortable',
                        'Pour lib√©rer les voies a√©riennes et √©viter l\'obstruction',
                        'Pour prendre le pouls',
                        'Ce n\'est pas n√©cessaire'
                    ],
                    correctAnswer: 1,
                    timeLimit: 65,
                    points: 110
                },
                {
                    type: 'quiz-illustrated',
                    illustrationFunction: 'getRCPHandsSVG',
                    title: 'Partie 7.4 - Position des mains RCP',
                    question: 'Quelle est la profondeur des compressions thoraciques lors de la RCP chez l\'adulte ?',
                    options: [
                        '2-3 cm',
                        '5-6 cm',
                        '10 cm',
                        '1 cm'
                    ],
                    correctAnswer: 1,
                    timeLimit: 70,
                    points: 110
                }
            ],
            // Nouveaux jeux Vrai/Faux - PLS et RCP
            {
                type: 'true-false',
                title: 'Partie 7.3/7.4 - Vrai ou Faux',
                question: 'La fr√©quence des compressions thoraciques doit √™tre de 100 √† 120 compressions par minute.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Le rythme optimal des compressions thoraciques est de 100 √† 120 par minute, soit environ 2 compressions par seconde (rythme de "Staying Alive").',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 7.4 - Vrai ou Faux',
                question: 'On doit arr√™ter la RCP d√®s qu\'on a pos√© le d√©fibrillateur (DAE).',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - On continue la RCP pendant que le DAE s\'installe et analyse. On ne s\'arr√™te que lorsque le DAE demande de ne pas toucher la victime.',
                timeLimit: 55,
                points: 100
            },
            {
                type: 'true-false',
                title: 'Partie 7.3 - Vrai ou Faux',
                question: 'Une victime en PLS doit √™tre surveill√©e en permanence jusqu\'√† l\'arriv√©e des secours.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - La victime en PLS doit √™tre surveill√©e en permanence car son √©tat peut √©voluer (arr√™t de la respiration, vomissements, etc.).',
                timeLimit: 50,
                points: 95
            },
            // Jeu 2 avec 6 variations
            [
                {
                    type: 'matching',
                    title: 'Partie 7.4 - Gestes et situations',
                    question: 'Associez chaque geste √† la situation appropri√©e :',
                    pairs: [
                        { left: 'PLS', right: 'Inconscient qui respire' },
                        { left: 'RCP', right: 'Arr√™t cardiaque' },
                        { left: 'Lib√©ration Voies A√©riennes', right: 'V√©rifier la respiration' },
                        { left: 'DAE', right: 'Arr√™t cardiaque' }
                    ],
                    timeLimit: 85,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.4 - D√©fibrillateur (DAE)',
                    question: 'Quand utiliser le d√©fibrillateur automatis√© externe (DAE) ?',
                    options: [
                        'Sur toute victime inconsciente',
                        'Uniquement sur une victime en arr√™t cardiaque',
                        'Sur une victime qui respire mal',
                        'Jamais, c\'est r√©serv√© aux m√©decins'
                    ],
                    correctAnswer: 1,
                    timeLimit: 65,
                    points: 110
                },
                {
                    type: 'sequence',
                    title: 'Partie 7.4 - Utilisation du DAE',
                    question: 'Ordre d\'utilisation du d√©fibrillateur :',
                    items: [
                        'Mettre en marche le DAE',
                        'Coller les √©lectrodes sur la peau nue',
                        'Laisser le DAE analyser',
                        'Si choc conseill√© : s\'√©carter et appuyer sur le bouton'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz-illustrated',
                    illustrationFunction: 'getPLSSVG',
                    title: 'Partie 7.3 - Position Lat√©rale de S√©curit√©',
                    question: 'Quelle est l\'angle de la jambe du dessus dans la Position Lat√©rale de S√©curit√© (PLS) ?',
                    options: [
                        'Jambe tendue',
                        'Jambe pli√©e √† 45¬∞',
                        'Jambe pli√©e √† 90¬∞',
                        'Jambe crois√©e'
                    ],
                    correctAnswer: 2,
                    timeLimit: 70,
                    points: 110
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 7.3 - Surveillance en PLS',
                    question: 'Que devez-vous surveiller chez une victime en PLS ? (Plusieurs r√©ponses)',
                    options: [
                        'La respiration',
                        'La conscience',
                        'Qu\'elle ne vomisse pas',
                        'Ses cheveux',
                        'La couleur de sa peau',
                        'Ses chaussures'
                    ],
                    correctAnswers: [0, 1, 2, 4],
                    timeLimit: 70,
                    points: 130
                },
                {
                    type: 'puzzle-text',
                    title: 'Partie 7.3 - √âtapes de la PLS',
                    question: 'Reconstituez les √©tapes de mise en PLS :',
                    pieces: [
                        '1. Allonger la victime sur le dos',
                        '2. Pr√©parer le retournement (bras, jambe)',
                        '3. Retourner la victime sur le c√¥t√©',
                        '4. Stabiliser et basculer la t√™te en arri√®re'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 7.4 - Arr√™t de la RCP',
                    question: 'Quand peut-on arr√™ter la r√©animation cardio-pulmonaire ?',
                    options: [
                        'Apr√®s 5 minutes',
                        'Quand on est fatigu√©',
                        'Quand les secours prennent le relais ou si la victime r√©agit',
                        'Jamais'
                    ],
                    correctAnswer: 2,
                    timeLimit: 65,
                    points: 110
                }
            ]
        ]
    },
    {
        title: 'DC2 - Secourir',
        subtitle: 'Situations sp√©cifiques',
        icon: 'üè•',
        color: 'from-indigo-500 to-blue-700',
        games: [
            // Jeu 1 avec 7 variations
            [
                {
                    type: 'matching',
                    title: 'Partie 8 - Malaises et traumatismes',
                    question: 'Associez chaque situation avec la conduite √† tenir :',
                    pairs: [
                        { left: 'Malaise cardiaque', right: 'Position confortable + alerter' },
                        { left: 'Br√ªlure', right: 'Refroidir 5 min minimum' },
                        { left: 'Traumatisme cervical', right: 'Ne pas mobiliser' },
                        { left: 'Plaie grave', right: 'Prot√©ger sans retirer corps √©tranger' }
                    ],
                    timeLimit: 90,
                    points: 140
                },
                {
                    type: 'quiz-illustrated',
                    illustrationFunction: 'getRCPHandsSVG',
                    title: 'Partie 8 - Position RCP',
                    question: 'O√π doit-on placer les mains lors d\'une r√©animation cardio-pulmonaire (RCP) ?',
                    options: [
                        'Au centre du thorax (sternum)',
                        'Sur les c√¥tes',
                        'Sur le ventre',
                        'Sur le cou'
                    ],
                    correctAnswer: 0,
                    timeLimit: 70,
                    points: 110
                },
                {
                    type: 'quiz',
                    title: 'Partie 8 - Br√ªlures',
                    question: 'Combien de temps faut-il refroidir une br√ªlure √† l\'eau temp√©r√©e ?',
                    options: [
                        '30 secondes',
                        '5 minutes minimum',
                        '1 minute',
                        'Jusqu\'√† ce que √ßa ne fasse plus mal'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 100
                },
                {
                    type: 'quiz',
                    title: 'Partie 8 - Malaise',
                    question: 'Quelle position donner √† une victime consciente qui fait un malaise ?',
                    options: [
                        'Debout',
                        'Position confortable choisie par la victime',
                        'Allong√©e sur le ventre',
                        'Position assise forc√©e'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 100
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 8 - Signes de malaise grave',
                    question: 'Quels sont les signes d\'un malaise grave ? (Plusieurs r√©ponses)',
                    options: [
                        'Douleur thoracique',
                        'Difficult√© √† parler',
                        'L√©ger mal de t√™te',
                        'Perte de connaissance',
                        'Sueurs abondantes',
                        'Petite fatigue'
                    ],
                    correctAnswers: [0, 1, 3, 4],
                    timeLimit: 75,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 8 - Plaie avec corps √©tranger',
                    question: 'Que faire face √† une plaie avec un corps √©tranger (couteau, morceau de verre...) ?',
                    options: [
                        'Retirer le corps √©tranger',
                        'Ne jamais retirer le corps √©tranger',
                        'Le bouger pour voir',
                        'Appuyer dessus'
                    ],
                    correctAnswer: 1,
                    timeLimit: 60,
                    points: 110
                },
                {
                    type: 'sequence',
                    title: 'Partie 8 - Traumatisme de membre',
                    question: 'Conduite √† tenir face √† un traumatisme de membre :',
                    items: [
                        '√âviter de mobiliser le membre',
                        'Alerter les secours',
                        'Surveiller la victime',
                        'Maintenir le membre dans la position trouv√©e'
                    ],
                    correctOrder: [0, 3, 1, 2],
                    timeLimit: 75,
                    points: 130
                }
            ],
            // Nouveaux jeux Vrai/Faux - Situations sp√©cifiques
            {
                type: 'true-false',
                title: 'Partie 8 - Vrai ou Faux',
                question: 'Une br√ªlure doit √™tre refroidie √† l\'eau froide pendant au moins 5 minutes.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Le refroidissement √† l\'eau temp√©r√©e (15-25¬∞C) doit durer au moins 5 minutes pour limiter l\'extension de la br√ªlure et soulager la douleur.',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 8 - Vrai ou Faux',
                question: 'On doit retirer un corps √©tranger plant√© dans une plaie pour mieux la soigner.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 1,
                explanation: 'FAUX - Il ne faut JAMAIS retirer un corps √©tranger d\'une plaie. Cela pourrait provoquer une h√©morragie importante ou aggraver les l√©sions. Seul un m√©decin peut le faire.',
                timeLimit: 50,
                points: 95
            },
            {
                type: 'true-false',
                title: 'Partie 8 - Vrai ou Faux',
                question: 'En cas de traumatisme du dos ou de la nuque, il faut √©viter tout d√©placement de la victime.',
                options: ['Vrai', 'Faux'],
                correctAnswer: 0,
                explanation: 'VRAI - Un traumatisme de la colonne vert√©brale peut √™tre aggrav√© par tout mouvement. Il faut maintenir la victime dans la position trouv√©e et attendre les secours sp√©cialis√©s.',
                timeLimit: 55,
                points: 100
            },
            // Jeu 2 avec 6 variations
            [
                {
                    type: 'matching',
                    title: 'Partie 8 - Types de plaies',
                    question: 'Associez chaque type de plaie √† sa d√©finition :',
                    pairs: [
                        { left: 'Plaie simple', right: 'Petite, propre, ne saigne pas' },
                        { left: 'Plaie grave', right: 'Large, profonde, avec corps √©tranger' },
                        { left: 'Br√ªlure 1er degr√©', right: 'Rougeur sans cloque' },
                        { left: 'Br√ªlure 2e degr√©', right: 'Avec cloques' }
                    ],
                    timeLimit: 90,
                    points: 130
                },
                {
                    type: 'quiz',
                    title: 'Partie 8 - Fracture',
                    question: 'Comment savoir si un membre est fractur√© ?',
                    options: [
                        'La victime ressent une douleur vive et ne peut pas bouger le membre',
                        'Le membre est chaud',
                        'La peau change de couleur',
                        'On ne peut jamais savoir'
                    ],
                    correctAnswer: 0,
                    timeLimit: 65,
                    points: 110
                },
                {
                    type: 'quiz-multi',
                    title: 'Partie 8 - Br√ªlure grave',
                    question: 'Quels crit√®res font qu\'une br√ªlure est grave ? (Plusieurs r√©ponses)',
                    options: [
                        '√âtendue importante',
                        'Localisation (visage, mains, organes g√©nitaux)',
                        'Profondeur (3e degr√©)',
                        'Petite rougeur',
                        'Victime est un enfant ou personne √¢g√©e',
                        'Br√ªlure chimique ou √©lectrique'
                    ],
                    correctAnswers: [0, 1, 2, 4, 5],
                    timeLimit: 80,
                    points: 140
                },
                {
                    type: 'sequence',
                    title: 'Partie 8 - Plaie simple',
                    question: 'Conduite √† tenir face √† une plaie simple :',
                    items: [
                        'Se laver les mains',
                        'Nettoyer la plaie √† l\'eau et au savon',
                        'Rincer abondamment',
                        'Prot√©ger par un pansement'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 70,
                    points: 120
                },
                {
                    type: 'quiz-illustrated',
                    illustrationFunction: 'getCompressionSVG',
                    title: 'Partie 8 - Compression h√©morragie',
                    question: 'Combien de temps faut-il maintenir la compression sur une plaie qui saigne ?',
                    options: [
                        '1 minute',
                        '5 minutes',
                        'Jusqu\'√† l\'arriv√©e des secours',
                        '10 secondes'
                    ],
                    correctAnswer: 2,
                    timeLimit: 70,
                    points: 110
                },
                {
                    type: 'puzzle-text',
                    title: 'Partie 8 - Conduite g√©n√©rale',
                    question: 'Ordre g√©n√©ral de prise en charge d\'une victime :',
                    pieces: [
                        '1. Prot√©ger',
                        '2. Examiner',
                        '3. Alerter',
                        '4. Secourir et surveiller'
                    ],
                    correctOrder: [0, 1, 2, 3],
                    timeLimit: 70,
                    points: 120
                }
            ]
        ]
    }
];

// ==================== √âTAT DU JEU ====================

const gameState = {
    currentBoxIndex: -1,
    currentGameIndex: 0,
    currentVariationIndex: 0, // Index de la variation actuelle (pour recharger la m√™me apr√®s reset)
    totalScore: 0,
    gameScore: 0,
    attempts: 3,
    maxAttempts: 3,
    timeLeft: 60,
    timerInterval: null,
    boxesUnlocked: 0,
    pauseLifted: false, // Indique si le formateur a lev√© la pause
    stats: {
        gamesWon: 0,
        gamesLost: 0,
        totalTime: 0,
        startTime: null,
        endTime: null
    },
    currentAnswer: null
};

// ==================== COMMUNICATION MULTIJOUEUR FIREBASE ====================

// Envoyer une mise √† jour via Firebase
function broadcastUpdate() {
    // PROTECTION ANTI-NaN : V√©rifier et corriger les valeurs avant l'envoi
    if (isNaN(gameState.totalScore) || gameState.totalScore === undefined || gameState.totalScore === null) {
        console.error('‚ö†Ô∏è ERREUR CRITIQUE: totalScore est invalide avant broadcastUpdate, correction √† 0');
        gameState.totalScore = 0;
    }
    if (isNaN(gameState.boxesUnlocked) || gameState.boxesUnlocked === undefined || gameState.boxesUnlocked === null) {
        console.error('‚ö†Ô∏è ERREUR CRITIQUE: boxesUnlocked est invalide avant broadcastUpdate, correction √† 0');
        gameState.boxesUnlocked = 0;
    }

    // Calculer l'√©tape actuelle de l'√©quipe
    const teamStage = getStageFromBoxes(gameState.boxesUnlocked);

    const update = {
        type: 'team_update',
        sessionId: sessionId,
        teamName: currentTeamName,
        boxesUnlocked: gameState.boxesUnlocked,
        totalScore: gameState.totalScore,
        currentStage: teamStage,
        pauseLifted: gameState.pauseLifted, // Indique si la pause a √©t√© lev√©e
        isFinished: gameState.boxesUnlocked >= boxesData.length,
        finishTime: gameState.stats.endTime || null,
        stats: {
            gamesWon: gameState.stats.gamesWon || 0,
            gamesLost: gameState.stats.gamesLost || 0,
            totalTime: gameState.stats.totalTime || 0,
            startTime: gameState.stats.startTime || null,
            endTime: gameState.stats.endTime || null
        },
        lastUpdate: Date.now()
    };

    // DEBUG: Afficher ce qu'on envoie √† Firebase
    console.log('üì§ Envoi √† Firebase:', update);

    // Enregistrer dans Firebase Realtime Database
    database.ref('teams/' + sessionId).set(update).catch(error => {
        console.error('‚ùå Erreur Firebase:', error);
    });
}

// √âcouter les changements d'√©quipes (pour le superviseur)
function startListeningToTeams() {
    database.ref('teams').on('value', (snapshot) => {
        if (appMode === 'supervisor') {
            teams = snapshot.val() || {};
            updateSupervisorDisplay();
        }
    });
}

// √âcouter les commandes du superviseur (pour les joueurs)
function startListeningToCommands() {
    database.ref('commands').on('value', (snapshot) => {
        if (appMode !== 'player') return;

        const command = snapshot.val();
        if (!command) return;

        if (command.type === 'stop_all_games' && command.timestamp > (Date.now() - 5000)) {
            stopTimer();
            showCustomAlert('‚è∏Ô∏è Le superviseur a arr√™t√© le jeu !');
        }

        if (command.type === 'reset_all' && command.timestamp > (Date.now() - 5000)) {
            resetGameState();
            showCustomAlert('üîÑ Le superviseur a r√©initialis√© le jeu !');
            setTimeout(() => {
                showScreen('player-entry-screen');
                document.getElementById('team-name-input').value = '';
            }, 2000);
        }

        // Commande de reprise
        if (command.type === 'resume_game' && command.timestamp > (Date.now() - 5000)) {
            console.log('‚ñ∂Ô∏è Commande resume_game re√ßue !');

            // Si on est sur l'√©cran de pause, retourner √† l'√©cran des coffres
            const pauseScreen = document.getElementById('stage-pause-screen');
            if (pauseScreen && !pauseScreen.classList.contains('hidden')) {
                console.log('‚úÖ Reprise depuis l\'√©cran de pause');
                gameState.pauseLifted = true; // Lever la pause
                showScreen('boxes-screen');
                renderBoxes();
                showCustomAlert('‚ñ∂Ô∏è Le formateur a repris le jeu ! Vous pouvez continuer.');
            }
        }
    });
}

// √âcouter les changements d'√©tat des √©tapes (pour les joueurs)
function startListeningToStages() {
    if (!sessionId || !database) {
        console.warn('‚ö†Ô∏è startListeningToStages: sessionId ou database manquant');
        return;
    }

    const stagesPath = `sessions/${sessionId}/stages`;
    console.log(`üëÇ √âcoute des changements Firebase sur: ${stagesPath}`);

    database.ref(stagesPath).on('value', (snapshot) => {
        if (appMode !== 'player') {
            console.log('‚è≠Ô∏è Mode non-joueur, ignor√©');
            return;
        }

        const stages = snapshot.val();
        console.log('üì° Mise √† jour Firebase re√ßue - √©tapes:', stages);

        const wasPaused = gamePaused;

        // Si pas de donn√©es, d√©bloquer le jeu
        if (!stages) {
            console.log('üì≠ Aucune donn√©e d\'√©tape dans Firebase');
            if (gamePaused) {
                gamePaused = false;
                currentStage = 0;
                console.log('üîì Aucune √©tape en pause - jeu d√©bloqu√©');
                // Rafra√Æchir l'affichage des coffres
                renderBoxes();
            }
            return;
        }

        // V√©rifier si le jeu est en pause sur l'une des √©tapes
        let foundPause = false;
        for (let i = 1; i <= 4; i++) {
            const stage = stages[`stage${i}`];
            if (stage && stage.paused) {
                foundPause = true;
                console.log(`üîç √âtape ${i} trouv√©e en pause:`, stage);
                // Le jeu est en pause pour cette √©tape
                if (!gamePaused || currentStage !== i) {
                    gamePaused = true;
                    currentStage = i;
                    console.log(`‚è∏Ô∏è Activation de la pause pour l'√©tape ${i}`);
                    showStagePauseScreen(i, stage);
                }
                return;
            }
        }

        // Aucune √©tape en pause
        if (!foundPause && gamePaused) {
            gamePaused = false;
            currentStage = 0;
            console.log('‚ñ∂Ô∏è Jeu repris via Firebase - d√©blocage des coffres');

            // Si on √©tait sur l'√©cran de pause, retourner √† l'√©cran des coffres
            const pauseScreen = document.getElementById('stage-pause-screen');
            if (pauseScreen && !pauseScreen.classList.contains('hidden')) {
                console.log('üîÑ Retour √† l\'√©cran des coffres depuis l\'√©cran de pause');
                showScreen('boxes-screen');
            }

            // Rafra√Æchir l'affichage des coffres pour d√©bloquer les suivants
            console.log('üîÑ Rafra√Æchissement des coffres');
            renderBoxes();
        } else if (!foundPause) {
            console.log('‚úÖ Aucune √©tape en pause actuellement');
        }
    });
}

// Envoyer une commande depuis le superviseur
function sendCommand(commandType) {
    database.ref('commands').set({
        type: commandType,
        timestamp: Date.now()
    });
}

// Charger les √©quipes depuis Firebase
function loadTeamsFromFirebase() {
    database.ref('teams').once('value', (snapshot) => {
        teams = snapshot.val() || {};
        updateSupervisorDisplay();
    });
}

// ==================== INITIALISATION ====================

// G√©n√©rer le QR Code
function generateQRCode() {
    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = ''; // Clear existing

    // Cr√©er l'URL avec le param√®tre mode=player pour l'acc√®s joueur
    let baseUrl = window.location.href;

    // Si on est en local (file://), utiliser l'URL de votre GitHub Pages
    if (baseUrl.startsWith('file://')) {
        baseUrl = 'https://mboyer3215-debug.github.io/challenge_cup_sst/';
    }

    const url = new URL(baseUrl);
    url.searchParams.set('mode', 'player');

    new QRCode(qrContainer, {
        text: url.toString(),
        width: 200,
        height: 200,
        colorDark: '#5D5CDE',
        colorLight: '#ffffff',
    });
}

// Initialisation au chargement
window.addEventListener('DOMContentLoaded', () => {
    // Initialiser Firebase en premier
    initializeFirebase();

    generateQRCode();

    // V√©rifier l'authentification et afficher l'√©cran appropri√©
    checkAuthentication();

    // Bouton Superviseur
    document.getElementById('supervisor-btn').addEventListener('click', () => {
        playSound('tick');
        appMode = 'supervisor';

        showScreen('supervisor-screen');
        loadTeamsFromFirebase();

        // √âcouter les changements en temps r√©el
        startListeningToTeams();
    });

    // Bouton Acc√®s Joueur Direct (pour test en local)
    document.getElementById('manual-player-access-btn').addEventListener('click', () => {
        playSound('tick');
        showScreen('player-entry-screen');
    });

    // Bouton Joueur
    document.getElementById('player-btn').addEventListener('click', () => {
        const teamName = document.getElementById('team-name-input').value.trim();
        if (!teamName) {
            showCustomAlert('‚ö†Ô∏è Veuillez entrer un nom d\'√©quipe !');
            return;
        }

        playSound('tick');
        currentTeamName = teamName;
        appMode = 'player';

        // DEBUG: V√©rifier gameState AVANT reset
        console.log('üîç AVANT resetGameState():', {
            totalScore: gameState.totalScore,
            boxesUnlocked: gameState.boxesUnlocked
        });

        // R√©initialiser compl√®tement le gameState pour une nouvelle partie
        resetGameState();
        gameState.stats.startTime = Date.now();

        // D√©marrer la musique de fond
        startBackgroundMusic();

        // PROTECTION CRITIQUE: Forcer les valeurs √† 0 si NaN
        if (isNaN(gameState.totalScore)) {
            console.error('‚ùå CORRUPTION D√âTECT√âE: totalScore est NaN apr√®s resetGameState()!');
            gameState.totalScore = 0;
        }
        if (isNaN(gameState.boxesUnlocked)) {
            console.error('‚ùå CORRUPTION D√âTECT√âE: boxesUnlocked est NaN apr√®s resetGameState()!');
            gameState.boxesUnlocked = 0;
        }

        // DEBUG: Afficher l'√©tat apr√®s reset
        console.log('‚úÖ APR√àS resetGameState() dans player-btn:', {
            totalScore: gameState.totalScore,
            boxesUnlocked: gameState.boxesUnlocked,
            sessionId: sessionId,
            teamName: currentTeamName
        });

        // √âcouter les commandes du superviseur
        startListeningToCommands();

        showScreen('boxes-screen');
        document.getElementById('team-name-display').textContent = currentTeamName;
        renderBoxes();

        // DEBUG: V√©rifier gameState JUSTE AVANT broadcastUpdate
        console.log('üöÄ JUSTE AVANT broadcastUpdate():', {
            totalScore: gameState.totalScore,
            boxesUnlocked: gameState.boxesUnlocked
        });

        broadcastUpdate();
    });

    // Bouton retour superviseur
    document.getElementById('back-to-login-supervisor').addEventListener('click', () => {
        playSound('tick');
        showScreen('login-screen');
        appMode = 'login';
    });

    // Bouton retour aux coffres
    document.getElementById('back-to-boxes').addEventListener('click', () => {
        stopTimer();
        playSound('tick');
        showScreen('boxes-screen');
        // Recharger l'affichage des coffres avec le score actuel
        updateBoxesDisplay();
    });

    // Bouton recommencer
    document.getElementById('restart-btn').addEventListener('click', () => {
        playSound('tick');
        resetGameState();
        showScreen('boxes-screen');
        renderBoxes();
        broadcastUpdate();
    });

    // Bouton Arr√™ter le jeu (Superviseur)
    document.getElementById('stop-all-games-btn').addEventListener('click', () => {
        showConfirmDialog(
            '‚è∏Ô∏è Voulez-vous vraiment arr√™ter tous les jeux en cours ?',
            () => {
                playSound('tick');
                // Envoyer une commande Firebase √† tous les joueurs
                sendCommand('stop_all_games');
                showCustomAlert('‚è∏Ô∏è Signal d\'arr√™t envoy√© √† toutes les √©quipes !');
            }
        );
    });

    // Bouton Reprendre le jeu (Superviseur)
    document.getElementById('resume-game-btn').addEventListener('click', () => {
        playSound('tick');
        console.log('‚ñ∂Ô∏è Envoi de la commande resume_game');
        sendCommand('resume_game');
        showCustomAlert('‚ñ∂Ô∏è Signal de reprise envoy√© √† toutes les √©quipes !');
    });

    // Fonction globale de r√©initialisation (appel√©e par onclick)
    window.resetAllData = function() {
        console.log('üîÑ resetAllData() appel√©e');

        showConfirmDialog(
            'üîÑ Voulez-vous vraiment r√©initialiser toutes les donn√©es ? Cette action est irr√©versible !',
            () => {
                console.log('‚úÖ Confirmation de r√©initialisation');
                playSound('tick');

                // Effacer toutes les donn√©es Firebase
                if (database) {
                    database.ref('teams').remove()
                        .then(() => console.log('‚úÖ √âquipes supprim√©es de Firebase'))
                        .catch(err => console.error('‚ùå Erreur suppression √©quipes:', err));

                    database.ref('sessions').remove()
                        .then(() => console.log('‚úÖ Sessions supprim√©es de Firebase'))
                        .catch(err => console.error('‚ùå Erreur suppression sessions:', err));
                }

                // R√©initialiser l'objet teams
                teams = {};

                // Envoyer une commande √† tous les joueurs pour r√©initialiser
                sendCommand('reset_all');

                // Mettre √† jour l'affichage
                updateSupervisorDisplay();
                const finalRanking = document.getElementById('final-ranking');
                if (finalRanking) {
                    finalRanking.classList.add('hidden');
                }

                showCustomAlert('üîÑ Toutes les donn√©es ont √©t√© r√©initialis√©es !');
            }
        );
    };

    // Bouton pour activer/d√©sactiver la musique
    document.getElementById('toggle-music-btn').addEventListener('click', () => {
        const btn = document.getElementById('toggle-music-btn');
        if (isMusicPlaying) {
            stopBackgroundMusic();
            btn.textContent = 'üéµ Musique OFF';
            btn.classList.remove('from-purple-500', 'to-pink-500', 'hover:from-purple-600', 'hover:to-pink-600');
            btn.classList.add('from-gray-400', 'to-gray-500', 'hover:from-gray-500', 'hover:to-gray-600');
        } else {
            startBackgroundMusic();
            btn.textContent = 'üéµ Musique ON';
            btn.classList.remove('from-gray-400', 'to-gray-500', 'hover:from-gray-500', 'hover:to-gray-600');
            btn.classList.add('from-purple-500', 'to-pink-500', 'hover:from-purple-600', 'hover:to-pink-600');
        }
    });

    // ==================== MODE ADMIN ====================

    let adminCurrentBox = null;
    let adminCurrentGameIndex = null;
    let adminCurrentVariation = null;

    // Bouton pour ouvrir le mode ADMIN
    document.getElementById('admin-mode-btn').addEventListener('click', () => {
        playSound('tick');
        showAdminScreen();
    });

    // Bouton pour fermer le mode ADMIN
    document.getElementById('admin-close-btn').addEventListener('click', () => {
        playSound('tick');
        showScreen('supervisor-screen');
        adminCurrentBox = null;
        adminCurrentGameIndex = null;
        adminCurrentVariation = null;
    });

    // Afficher l'√©cran ADMIN
    function showAdminScreen() {
        const screens = ['login-screen', 'player-entry-screen', 'supervisor-screen', 'boxes-screen', 'game-screen', 'end-screen', 'admin-screen'];
        screens.forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById('admin-screen').classList.remove('hidden');

        // R√©initialiser les filtres
        adminSearchQuery = '';
        adminTypeFilter = 'all';
        document.getElementById('admin-search').value = '';

        // R√©initialiser l'√©tat des boutons de filtre
        document.querySelectorAll('.admin-filter-btn').forEach(b => {
            b.classList.remove('bg-primary', 'text-white');
            b.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        });
        // Activer le bouton "Tous"
        const allBtn = document.querySelector('.admin-filter-btn[data-type="all"]');
        if (allBtn) {
            allBtn.classList.add('bg-primary', 'text-white');
            allBtn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        }

        // G√©n√©rer la liste des coffres et jeux
        renderAdminBoxesList();

        // Mettre √† jour les statistiques de timing
        updateTimingStats();
    }

    // Variables de filtrage
    let adminSearchQuery = '';
    let adminTypeFilter = 'all';

    // Afficher la liste des coffres et jeux dans l'admin
    function renderAdminBoxesList() {
        const container = document.getElementById('admin-boxes-list');
        container.innerHTML = '';

        let totalGamesDisplayed = 0;

        const gameTypeLabels = {
            'quiz': '‚ùì QCM',
            'quiz-multi': '‚òëÔ∏è Multi',
            'true-false': '‚úì‚úó Vrai/Faux',
            'quiz-illustrated': 'üñºÔ∏è Illustr√©',
            'matching': 'üîó Appariement',
            'sequence': 'üìä S√©quence',
            'puzzle-text': 'üß© Puzzle',
            'draw': '‚úèÔ∏è Dessin'
        };

        boxesData.forEach((box, boxIndex) => {
            const boxDiv = document.createElement('div');
            boxDiv.className = 'border-2 border-gray-300 dark:border-gray-600 rounded-xl p-4 mb-3';

            let boxHTML = `
                <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center">
                        <div class="text-2xl mr-2">${box.icon || box.emoji || 'üì¶'}</div>
                        <div class="font-bold text-gray-800 dark:text-white text-sm">${box.title || box.name || 'Coffre'}</div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400" id="box-${boxIndex}-count">0 jeu(x)</div>
                </div>
                <div class="space-y-1" id="box-${boxIndex}-games">
            `;

            let boxGamesCount = 0;

            // Les games peuvent √™tre un tableau de tableaux (variations) ou un tableau simple
            box.games.forEach((gameOrVariations, gameIndex) => {
                // Si c'est un tableau de variations, cr√©er un bouton pour CHAQUE variation
                const gamesArray = Array.isArray(gameOrVariations) ? gameOrVariations : [gameOrVariations];

                gamesArray.forEach((game, variationIndex) => {
                    if (!game || !game.type) return; // Ignorer les jeux invalides

                    // Filtre par type
                    if (adminTypeFilter !== 'all') {
                        // Normaliser les types pour la comparaison
                        const gameTypeNormalized = game.type.toLowerCase();
                        const filterTypeNormalized = adminTypeFilter.toLowerCase();

                        // V√©rifier si le type correspond
                        if (gameTypeNormalized !== filterTypeNormalized) {
                            // V√©rifier aussi les variantes (quiz-multi = quiz, quiz-illustrated = quiz)
                            const gameTypeBase = gameTypeNormalized.replace(/-illustrated|-multi/g, '');
                            const filterTypeBase = filterTypeNormalized.replace(/-illustrated|-multi/g, '');
                            if (gameTypeBase !== filterTypeBase) {
                                return; // Ne pas afficher ce jeu
                            }
                        }
                    }

                    // Filtre par recherche
                    if (adminSearchQuery) {
                        const searchLower = adminSearchQuery.toLowerCase();
                        const title = (game.title || '').toLowerCase();
                        const question = (game.question || '').toLowerCase();
                        const type = (game.type || '').toLowerCase();

                        if (!title.includes(searchLower) &&
                            !question.includes(searchLower) &&
                            !type.includes(searchLower)) {
                            return; // Ne pas afficher ce jeu
                        }
                    }

                    const gameLabel = gameTypeLabels[game.type] || game.type || '‚ùì';
                    const gameTitle = game.title || game.question || 'Sans titre';

                    // Tronquer le titre si trop long
                    const displayTitle = gameTitle.length > 45 ? gameTitle.substring(0, 42) + '...' : gameTitle;

                    // Badge pour indiquer la variation (1/4, 2/4, etc.)
                    const variationBadge = gamesArray.length > 1 ?
                        `<span class="ml-1 px-1.5 py-0.5 bg-purple-500 text-white text-[10px] rounded-full">${variationIndex + 1}/${gamesArray.length}</span>` : '';

                    boxHTML += `
                        <button
                            class="admin-game-btn w-full text-left px-3 py-2 bg-gray-50 dark:bg-gray-700 hover:bg-primary hover:text-white dark:hover:bg-primary rounded-lg transition-all text-xs group"
                            data-box="${boxIndex}"
                            data-game="${gameIndex}"
                            data-variation="${variationIndex}"
                            title="${gameTitle} ${gamesArray.length > 1 ? '(Variation ' + (variationIndex + 1) + '/' + gamesArray.length + ')' : ''}"
                        >
                            <div class="flex items-start gap-2">
                                <span class="text-sm flex-shrink-0">${gameLabel}</span>
                                <span class="flex-1 line-clamp-2">${displayTitle}</span>
                                ${variationBadge}
                            </div>
                        </button>
                    `;
                    boxGamesCount++;
                    totalGamesDisplayed++;
                });
            });

            boxHTML += '</div>';
            boxDiv.innerHTML = boxHTML;

            // N'afficher le coffre que s'il contient des jeux filtr√©s
            if (boxGamesCount > 0) {
                container.appendChild(boxDiv);
                // Mettre √† jour le compteur du coffre
                setTimeout(() => {
                    const countElement = document.getElementById(`box-${boxIndex}-count`);
                    if (countElement) {
                        countElement.textContent = `${boxGamesCount} jeu(x)`;
                    }
                }, 0);
            }
        });

        // Mettre √† jour le compteur global
        document.getElementById('admin-results-count').textContent = totalGamesDisplayed;

        // Message si aucun r√©sultat
        if (totalGamesDisplayed === 0) {
            container.innerHTML = `
                <div class="text-center py-10 text-gray-400 dark:text-gray-500">
                    <div class="text-4xl mb-3">üîç</div>
                    <p>Aucun jeu trouv√©</p>
                </div>
            `;
        }

        // Ajouter les √©v√©nements sur les boutons de jeu
        document.querySelectorAll('.admin-game-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const boxIndex = parseInt(btn.dataset.box);
                const gameIndex = parseInt(btn.dataset.game);
                const variationIndex = parseInt(btn.dataset.variation || 0);
                loadGameInEditor(boxIndex, gameIndex, variationIndex);
            });
        });
    }

    // Barre de recherche
    document.getElementById('admin-search').addEventListener('input', (e) => {
        adminSearchQuery = e.target.value;
        renderAdminBoxesList();
    });

    // Filtres par type
    document.querySelectorAll('.admin-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Retirer l'√©tat actif de tous les boutons
            document.querySelectorAll('.admin-filter-btn').forEach(b => {
                b.classList.remove('bg-primary', 'text-white');
                b.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });

            // Activer le bouton cliqu√©
            btn.classList.add('bg-primary', 'text-white');
            btn.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');

            // Appliquer le filtre
            adminTypeFilter = btn.dataset.type;
            renderAdminBoxesList();
        });
    });

    // Charger un jeu dans l'√©diteur
    function loadGameInEditor(boxIndex, gameIndex, variationIndex = 0) {
        adminCurrentBox = boxIndex;
        adminCurrentGameIndex = gameIndex;
        adminCurrentVariation = variationIndex;

        const gameOrVariations = boxesData[boxIndex].games[gameIndex];

        // Si c'est un tableau de variations, on √©dite la variation sp√©cifi√©e
        const game = Array.isArray(gameOrVariations) ? gameOrVariations[variationIndex] : gameOrVariations;

        if (!game || !game.type) {
            showCustomAlert('‚ùå Erreur : Jeu invalide');
            return;
        }

        // Afficher le formulaire d'√©dition
        document.getElementById('admin-no-selection').classList.add('hidden');
        document.getElementById('admin-edit-form').classList.remove('hidden');

        // Mettre √† jour le titre avec l'information de variation
        const totalVariations = Array.isArray(gameOrVariations) ? gameOrVariations.length : 1;
        const variationBadge = totalVariations > 1
            ? ` <span class="ml-2 px-3 py-1 bg-purple-500 text-white text-sm rounded-full">Variante ${variationIndex + 1}/${totalVariations}</span>`
            : '';
        document.getElementById('admin-edit-form-title').innerHTML = `‚úèÔ∏è √âdition du jeu${variationBadge}`;

        // Remplir les champs de base
        document.getElementById('admin-type').value = game.type || '';
        document.getElementById('admin-title').value = game.title || '';
        document.getElementById('admin-question').value = game.question || '';
        document.getElementById('admin-timeLimit').value = game.timeLimit || 60;
        document.getElementById('admin-points').value = game.points || 100;

        // G√©rer l'explication (pour true-false)
        const explanationContainer = document.getElementById('admin-explanation-container');
        if (game.type === 'true-false' && game.explanation) {
            explanationContainer.classList.remove('hidden');
            document.getElementById('admin-explanation').value = game.explanation;
        } else {
            explanationContainer.classList.add('hidden');
        }

        // G√©n√©rer les champs d'options selon le type de jeu
        renderAdminOptionsFields(game);
        renderAdminCorrectAnswerField(game);
    }

    // G√©n√©rer les champs d'options selon le type de jeu
    function renderAdminOptionsFields(game) {
        const container = document.getElementById('admin-options-container');
        container.innerHTML = '';

        if (game.type === 'quiz' || game.type === 'quiz-multi' || game.type === 'true-false' || game.type === 'quiz-illustrated') {
            container.innerHTML = '<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Options de r√©ponse</label>';

            game.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'flex items-center gap-2 mb-2';
                optionDiv.innerHTML = `
                    <span class="text-gray-600 dark:text-gray-400 font-semibold w-8">${index + 1}.</span>
                    <input
                        type="text"
                        class="admin-option-input flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base"
                        data-index="${index}"
                        value="${option}"
                    >
                `;
                container.appendChild(optionDiv);
            });
        } else if (game.type === 'matching') {
            container.innerHTML = '<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">Paires √† associer</label>';

            game.pairs.forEach((pair, index) => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'grid grid-cols-2 gap-2 mb-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                pairDiv.innerHTML = `
                    <div>
                        <label class="text-xs text-gray-600 dark:text-gray-400">Gauche ${index + 1}</label>
                        <input
                            type="text"
                            class="admin-pair-left w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base"
                            data-index="${index}"
                            value="${pair.left}"
                        >
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 dark:text-gray-400">Droite ${index + 1}</label>
                        <input
                            type="text"
                            class="admin-pair-right w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base"
                            data-index="${index}"
                            value="${pair.right}"
                        >
                    </div>
                `;
                container.appendChild(pairDiv);
            });
        } else if (game.type === 'sequence') {
            container.innerHTML = '<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">√âtapes dans le bon ordre</label>';

            game.items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center gap-2 mb-2';
                itemDiv.innerHTML = `
                    <span class="text-gray-600 dark:text-gray-400 font-semibold w-8">${index + 1}.</span>
                    <input
                        type="text"
                        class="admin-sequence-input flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base"
                        data-index="${index}"
                        value="${item}"
                    >
                `;
                container.appendChild(itemDiv);
            });
        } else if (game.type === 'puzzle-text') {
            container.innerHTML = `
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Texte du puzzle</label>
                <textarea id="admin-puzzle-text" rows="4" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base">${game.text || ''}</textarea>
            `;
        }
    }

    // G√©n√©rer le champ de r√©ponse correcte
    function renderAdminCorrectAnswerField(game) {
        const container = document.getElementById('admin-correct-answer-container');
        container.innerHTML = '';

        if (game.type === 'quiz' || game.type === 'true-false' || game.type === 'quiz-illustrated') {
            container.innerHTML = `
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Index de la r√©ponse correcte (0 = premi√®re option)</label>
                <input
                    type="number"
                    id="admin-correctAnswer"
                    min="0"
                    max="${game.options.length - 1}"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base"
                    value="${game.correctAnswer}"
                >
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">La bonne r√©ponse est actuellement : "${game.options[game.correctAnswer]}"</p>
            `;
        } else if (game.type === 'quiz-multi') {
            const correctAnswersArray = Array.isArray(game.correctAnswer) ? game.correctAnswer : [];
            container.innerHTML = `
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Indices des r√©ponses correctes (s√©par√©s par des virgules)</label>
                <input
                    type="text"
                    id="admin-correctAnswer"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base"
                    value="${correctAnswersArray.join(',')}"
                    placeholder="Ex: 0,2,3"
                >
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Les bonnes r√©ponses sont : ${correctAnswersArray.map(i => game.options[i]).join(', ')}</p>
            `;
        }
    }

    // Bouton Enregistrer
    document.getElementById('admin-save-btn').addEventListener('click', () => {
        if (adminCurrentBox === null || adminCurrentGameIndex === null) return;

        const gameOrVariations = boxesData[adminCurrentBox].games[adminCurrentGameIndex];

        // Si c'est un tableau de variations, on √©dite la variation sp√©cifi√©e
        const variationIndex = adminCurrentVariation || 0;
        const game = Array.isArray(gameOrVariations) ? gameOrVariations[variationIndex] : gameOrVariations;

        if (!game) {
            showCustomAlert('‚ùå Erreur : Impossible de sauvegarder');
            return;
        }

        // R√©cup√©rer les valeurs modifi√©es
        game.title = document.getElementById('admin-title').value;
        game.question = document.getElementById('admin-question').value;
        game.timeLimit = parseInt(document.getElementById('admin-timeLimit').value);
        game.points = parseInt(document.getElementById('admin-points').value);

        // Mettre √† jour l'explication si c'est un true-false
        if (game.type === 'true-false') {
            game.explanation = document.getElementById('admin-explanation').value;
        }

        // Mettre √† jour les options selon le type
        if (game.type === 'quiz' || game.type === 'quiz-multi' || game.type === 'true-false' || game.type === 'quiz-illustrated') {
            const optionInputs = document.querySelectorAll('.admin-option-input');
            game.options = Array.from(optionInputs).map(input => input.value);

            // Mettre √† jour la r√©ponse correcte
            if (game.type === 'quiz-multi') {
                const correctAnswerStr = document.getElementById('admin-correctAnswer').value;
                game.correctAnswer = correctAnswerStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            } else {
                game.correctAnswer = parseInt(document.getElementById('admin-correctAnswer').value);
            }
        } else if (game.type === 'matching') {
            const leftInputs = document.querySelectorAll('.admin-pair-left');
            const rightInputs = document.querySelectorAll('.admin-pair-right');
            game.pairs = Array.from(leftInputs).map((leftInput, index) => ({
                left: leftInput.value,
                right: rightInputs[index].value
            }));
        } else if (game.type === 'sequence') {
            const sequenceInputs = document.querySelectorAll('.admin-sequence-input');
            game.items = Array.from(sequenceInputs).map(input => input.value);
        } else if (game.type === 'puzzle-text') {
            game.text = document.getElementById('admin-puzzle-text').value;
        }

        playSound('success');
        showCustomAlert('‚úÖ Modifications enregistr√©es avec succ√®s !');

        // Recharger la liste pour refl√©ter les changements
        renderAdminBoxesList();
    });

    // Bouton Annuler
    document.getElementById('admin-cancel-btn').addEventListener('click', () => {
        playSound('tick');
        document.getElementById('admin-no-selection').classList.remove('hidden');
        document.getElementById('admin-edit-form').classList.add('hidden');
        adminCurrentBox = null;
        adminCurrentGameIndex = null;
        adminCurrentVariation = null;
    });

    // Bouton Exporter
    document.getElementById('admin-export-btn').addEventListener('click', () => {
        const dataStr = JSON.stringify(boxesData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'sst-questions-backup.json';
        link.click();
        URL.revokeObjectURL(url);

        playSound('success');
        showCustomAlert('üì• Questions export√©es avec succ√®s !');
    });

    // Bouton Importer
    document.getElementById('admin-import-btn').addEventListener('click', () => {
        document.getElementById('admin-import-file').click();
    });

    document.getElementById('admin-import-file').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);

                // Valider que c'est bien un tableau de coffres
                if (!Array.isArray(importedData)) {
                    throw new Error('Le fichier JSON doit contenir un tableau de coffres');
                }

                showConfirmDialog(
                    'üì§ Voulez-vous vraiment importer ces questions ? Cela remplacera TOUTES les questions actuelles !',
                    () => {
                        // Remplacer boxesData
                        boxesData.length = 0;
                        boxesData.push(...importedData);

                        playSound('success');
                        showCustomAlert('‚úÖ Questions import√©es avec succ√®s !');
                        renderAdminBoxesList();
                        updateTimingStats();

                        // R√©initialiser l'input file
                        document.getElementById('admin-import-file').value = '';
                    }
                );
            } catch (error) {
                showCustomAlert('‚ùå Erreur lors de l\'import : ' + error.message);
            }
        };
        reader.readAsText(file);
    });

    // ==================== CONTR√îLE DU TIMING GLOBAL ====================

    // Calculer et afficher les statistiques de timing
    function updateTimingStats() {
        let allTimes = [];

        boxesData.forEach(box => {
            box.games.forEach(gameOrVariations => {
                const game = Array.isArray(gameOrVariations) ? gameOrVariations[0] : gameOrVariations;
                if (game && game.timeLimit) {
                    allTimes.push(game.timeLimit);
                }
            });
        });

        if (allTimes.length === 0) {
            document.getElementById('admin-avg-time').textContent = '0';
            document.getElementById('admin-min-time').textContent = '0';
            document.getElementById('admin-max-time').textContent = '0';
            return;
        }

        const avg = Math.round(allTimes.reduce((a, b) => a + b, 0) / allTimes.length);
        const min = Math.min(...allTimes);
        const max = Math.max(...allTimes);

        document.getElementById('admin-avg-time').textContent = avg;
        document.getElementById('admin-min-time').textContent = min;
        document.getElementById('admin-max-time').textContent = max;
    }

    // Appliquer un multiplicateur √† tous les temps
    function applyTimeMultiplier(multiplier) {
        let count = 0;

        boxesData.forEach(box => {
            box.games.forEach(gameOrVariations => {
                if (Array.isArray(gameOrVariations)) {
                    // C'est un tableau de variations
                    gameOrVariations.forEach(game => {
                        if (game && game.timeLimit) {
                            game.timeLimit = Math.max(10, Math.round(game.timeLimit * multiplier));
                            count++;
                        }
                    });
                } else {
                    // C'est un jeu simple
                    const game = gameOrVariations;
                    if (game && game.timeLimit) {
                        game.timeLimit = Math.max(10, Math.round(game.timeLimit * multiplier));
                        count++;
                    }
                }
            });
        });

        return count;
    }

    // D√©finir un temps fixe pour tous
    function applyFixedTime(time) {
        let count = 0;

        boxesData.forEach(box => {
            box.games.forEach(gameOrVariations => {
                if (Array.isArray(gameOrVariations)) {
                    gameOrVariations.forEach(game => {
                        if (game && game.timeLimit !== undefined) {
                            game.timeLimit = time;
                            count++;
                        }
                    });
                } else {
                    const game = gameOrVariations;
                    if (game && game.timeLimit !== undefined) {
                        game.timeLimit = time;
                        count++;
                    }
                }
            });
        });

        return count;
    }

    // Boutons presets de vitesse
    document.querySelectorAll('.admin-speed-preset').forEach(btn => {
        btn.addEventListener('click', () => {
            const multiplier = parseFloat(btn.dataset.multiplier);

            showConfirmDialog(
                `‚è±Ô∏è Voulez-vous vraiment modifier TOUS les temps avec un multiplicateur de ${multiplier}x ?`,
                () => {
                    const count = applyTimeMultiplier(multiplier);
                    updateTimingStats();
                    playSound('success');
                    showCustomAlert(`‚úÖ ${count} jeux ont √©t√© mis √† jour !`);
                }
            );
        });
    });

    // Bouton appliquer multiplicateur personnalis√©
    document.getElementById('admin-apply-multiplier').addEventListener('click', () => {
        const multiplier = parseFloat(document.getElementById('admin-time-multiplier').value);

        if (isNaN(multiplier) || multiplier <= 0) {
            showCustomAlert('‚ùå Veuillez entrer un multiplicateur valide (sup√©rieur √† 0)');
            return;
        }

        showConfirmDialog(
            `‚è±Ô∏è Voulez-vous vraiment modifier TOUS les temps avec un multiplicateur de ${multiplier}x ?`,
            () => {
                const count = applyTimeMultiplier(multiplier);
                updateTimingStats();
                playSound('success');
                showCustomAlert(`‚úÖ ${count} jeux ont √©t√© mis √† jour !`);
            }
        );
    });

    // Bouton appliquer temps fixe
    document.getElementById('admin-apply-fixed-time').addEventListener('click', () => {
        const time = parseInt(document.getElementById('admin-fixed-time').value);

        if (isNaN(time) || time < 10 || time > 300) {
            showCustomAlert('‚ùå Veuillez entrer un temps valide (entre 10 et 300 secondes)');
            return;
        }

        showConfirmDialog(
            `‚è±Ô∏è Voulez-vous vraiment d√©finir ${time} secondes pour TOUS les jeux ?`,
            () => {
                const count = applyFixedTime(time);
                updateTimingStats();
                playSound('success');
                showCustomAlert(`‚úÖ ${count} jeux ont √©t√© mis √† jour √† ${time}s !`);
            }
        );
    });

    // Mettre √† jour les stats √† l'ouverture de l'√©cran ADMIN
    // (on modifie la fonction showAdminScreen existante pour ajouter updateTimingStats)
});

// Afficher un √©cran
function showScreen(screenId) {
    const screens = ['login-screen', 'player-entry-screen', 'supervisor-screen', 'boxes-screen', 'game-screen', 'end-screen', 'stage-pause-screen', 'admin-screen'];
    screens.forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    document.getElementById(screenId).classList.remove('hidden');
}

// R√©initialiser l'√©tat du jeu
function resetGameState() {
    gameState.currentBoxIndex = -1;
    gameState.currentGameIndex = 0;
    gameState.totalScore = 0;
    gameState.gameScore = 0;
    gameState.attempts = 3;
    gameState.boxesUnlocked = 0;
    gameState.pauseLifted = false;
    gameState.stats = { gamesWon: 0, gamesLost: 0, totalTime: 0, startTime: Date.now(), endTime: null };
    gameState.currentAnswer = null;

    // DEBUG: V√©rifier que les valeurs sont correctes
    console.log('üîÑ resetGameState() appel√©:', {
        totalScore: gameState.totalScore,
        boxesUnlocked: gameState.boxesUnlocked
    });
}

// Fonction de protection pour √©viter les valeurs NaN
function safeUpdateDisplay() {
    // S'assurer que les valeurs ne sont jamais NaN ou undefined
    if (isNaN(gameState.totalScore) || gameState.totalScore === undefined) {
        console.error('‚ö†Ô∏è ERREUR: totalScore est NaN ou undefined, r√©initialisation √† 0');
        gameState.totalScore = 0;
    }
    if (isNaN(gameState.boxesUnlocked) || gameState.boxesUnlocked === undefined) {
        console.error('‚ö†Ô∏è ERREUR: boxesUnlocked est NaN ou undefined, r√©initialisation √† 0');
        gameState.boxesUnlocked = 0;
    }

    updateBoxesDisplay();
}

// ==================== SUPERVISEUR ====================

function updateSupervisorDisplay() {
    const container = document.getElementById('teams-progress-container');
    const teamsArray = Object.values(teams);

    // Compter les √©quipes actives et termin√©es
    const activeTeams = teamsArray.filter(t => !t.isFinished).length;
    const finishedTeams = teamsArray.filter(t => t.isFinished).length;

    document.getElementById('active-teams-count').textContent = activeTeams;
    document.getElementById('finished-teams-count').textContent = finishedTeams;

    // Mettre √† jour les barres de progression
    container.innerHTML = '';

    // Trier par ordre d'arriv√©e (ceux qui ont fini, par temps)
    const sortedTeams = teamsArray.sort((a, b) => {
        if (a.isFinished && !b.isFinished) return -1;
        if (!a.isFinished && b.isFinished) return 1;
        if (a.isFinished && b.isFinished) {
            return (a.finishTime || 0) - (b.finishTime || 0);
        }
        // Pour ceux en cours, trier par progression
        return b.boxesUnlocked - a.boxesUnlocked;
    });

    sortedTeams.forEach((team, index) => {
        const teamDiv = document.createElement('div');
        teamDiv.className = 'bounce-in';

        const progressPercent = (team.boxesUnlocked / boxesData.length) * 100;

        // Ordre d'arriv√©e (seulement pour ceux qui ont fini)
        let rankBadge = '';
        if (team.isFinished) {
            const finishedTeams = sortedTeams.filter(t => t.isFinished);
            const rankPosition = finishedTeams.indexOf(team) + 1;

            if (rankPosition === 1) {
                rankBadge = `
                    <div class="absolute -top-4 -right-4 z-10">
                        <div class="relative">
                            <div class="absolute inset-0 bg-yellow-400 rounded-full animate-ping"></div>
                            <div class="relative flex items-center justify-center w-20 h-20 bg-gradient-to-br from-yellow-400 via-yellow-500 to-orange-500 rounded-full shadow-2xl border-4 border-white pulse glow">
                                <span class="text-5xl font-black text-white drop-shadow-lg">1</span>
                            </div>
                        </div>
                        <div class="text-center mt-1 text-xs font-bold text-yellow-600 dark:text-yellow-400 animate-pulse">üèÜ VAINQUEUR</div>
                    </div>
                `;
            } else if (rankPosition === 2) {
                rankBadge = `
                    <div class="absolute -top-4 -right-4 z-10">
                        <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-br from-gray-300 via-gray-400 to-gray-500 rounded-full shadow-xl border-4 border-white">
                            <span class="text-4xl font-black text-white drop-shadow-lg">2</span>
                        </div>
                        <div class="text-center mt-1 text-xs font-bold text-gray-600 dark:text-gray-400">ü•à 2√®me</div>
                    </div>
                `;
            } else if (rankPosition === 3) {
                rankBadge = `
                    <div class="absolute -top-4 -right-4 z-10">
                        <div class="flex items-center justify-center w-14 h-14 bg-gradient-to-br from-orange-300 via-orange-400 to-orange-600 rounded-full shadow-xl border-4 border-white">
                            <span class="text-3xl font-black text-white drop-shadow-lg">3</span>
                        </div>
                        <div class="text-center mt-1 text-xs font-bold text-orange-600 dark:text-orange-400">ü•â 3√®me</div>
                    </div>
                `;
            } else {
                rankBadge = `
                    <div class="absolute -top-3 -right-3 z-10">
                        <div class="flex items-center justify-center w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full shadow-lg border-3 border-white">
                            <span class="text-2xl font-bold text-white">${rankPosition}</span>
                        </div>
                    </div>
                `;
            }
        }

        // G√©n√©rer les segments de coffres
        let segmentsHTML = '';
        for (let i = 0; i < team.boxesUnlocked; i++) {
            const box = boxesData[i];
            const segmentHeight = 100 / boxesData.length;
            segmentsHTML += `
                <div class="box-segment bg-gradient-to-r ${box.color}" style="height: ${segmentHeight}%">
                    ${box.icon}
                </div>
            `;
        }

        // V√©rifier si l'√©quipe est en pause (multiples de 2 coffres et pas termin√© ET pause pas lev√©e)
        const isPaused = !team.isFinished && team.boxesUnlocked % 2 === 0 && team.boxesUnlocked > 0 && team.boxesUnlocked < boxesData.length && !team.pauseLifted;

        teamDiv.innerHTML = `
            <div class="glass-morphism rounded-2xl p-4 shadow-xl relative">
                ${rankBadge}
                <div class="text-center mb-3">
                    <div class="text-lg font-bold text-gray-800 dark:text-white">${team.teamName}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">${team.totalScore} pts</div>
                    ${team.isFinished ? '<div class="text-xs text-green-600 font-semibold">‚úì Termin√©</div>' : ''}
                    ${isPaused ? '<div class="text-xs text-orange-600 dark:text-orange-400 font-semibold animate-pulse">‚è∏Ô∏è En pause (√âtape ' + (team.boxesUnlocked / 2) + ')</div>' : ''}
                </div>

                <div class="progress-bar-vertical">
                    <div class="progress-fill" style="height: ${progressPercent}%">
                        ${segmentsHTML}
                    </div>
                </div>

                <div class="text-center mt-3 text-sm font-semibold text-gray-700 dark:text-gray-300">
                    ${team.boxesUnlocked} / ${boxesData.length}
                </div>
            </div>
        `;

        container.appendChild(teamDiv);
    });

    // Afficher le classement final si toutes les √©quipes ont termin√©
    if (finishedTeams > 0 && finishedTeams === teamsArray.length && teamsArray.length > 0) {
        showFinalRanking();
    }
}

// Variable pour √©viter plusieurs listeners
let stagePauseListenerActive = false;

// V√©rifier si le jeu est en pause sur une √©tape
function checkPausedStages() {
    if (!sessionId || !database) {
        console.warn('‚ö†Ô∏è checkPausedStages: sessionId ou database manquant');
        return;
    }

    // √âviter de cr√©er plusieurs listeners
    if (!stagePauseListenerActive) {
        stagePauseListenerActive = true;
        console.log('üéØ D√©marrage du listener Firebase pour les √©tapes en pause');

        database.ref(`sessions/${sessionId}/stages`).on('value', (snapshot) => {
            updatePauseButton(snapshot.val());
        });

        // BACKUP: V√©rification p√©riodique toutes les 3 secondes
        // (au cas o√π le listener Firebase ne se d√©clenche pas)
        setInterval(() => {
            if (appMode === 'supervisor') {
                database.ref(`sessions/${sessionId}/stages`).once('value', (snapshot) => {
                    updatePauseButton(snapshot.val());
                });
            }
        }, 3000);
    }
}

// Fonction pour mettre √† jour le bouton de pause
function updatePauseButton(stages) {
    const resumeBtn = document.getElementById('resume-game-btn');
    const stageDisplay = document.getElementById('current-stage-display');
    const stageNumberDisplay = document.getElementById('paused-stage-number');

    console.log('üîç Superviseur - V√©rification des √©tapes en pause:', stages);

    if (!stages) {
        // Aucune √©tape en pause
        console.log('üì≠ Aucune √©tape trouv√©e');
        if (resumeBtn) resumeBtn.classList.add('hidden');
        if (stageDisplay) stageDisplay.classList.add('hidden');
        return;
    }

    // V√©rifier s'il y a une √©tape en pause
    for (let i = 1; i <= 4; i++) {
        const stage = stages[`stage${i}`];
        if (stage && stage.paused === true) {
            // Le jeu est en pause sur cette √©tape
            console.log(`‚è∏Ô∏è Superviseur - √âtape ${i} en pause d√©tect√©e, affichage du bouton reprendre`);
            if (resumeBtn) resumeBtn.classList.remove('hidden');
            if (stageDisplay) stageDisplay.classList.remove('hidden');
            if (stageNumberDisplay) stageNumberDisplay.textContent = i;
            return;
        }
    }

    // Aucune √©tape en pause
    console.log('‚úÖ Aucune √©tape en pause trouv√©e');
    if (resumeBtn) resumeBtn.classList.add('hidden');
    if (stageDisplay) stageDisplay.classList.add('hidden');
}

function showFinalRanking() {
    const rankingDiv = document.getElementById('final-ranking');
    const rankingList = document.getElementById('ranking-list');

    rankingDiv.classList.remove('hidden');

    // Trier les √©quipes par score d√©croissant, puis par temps
    const sortedTeams = Object.values(teams).sort((a, b) => {
        if (b.totalScore !== a.totalScore) {
            return b.totalScore - a.totalScore;
        }
        return (a.finishTime || Infinity) - (b.finishTime || Infinity);
    });

    rankingList.innerHTML = '';

    sortedTeams.forEach((team, index) => {
        const rank = index + 1;
        const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;

        const duration = team.finishTime && team.stats.startTime ?
            Math.round((team.finishTime - team.stats.startTime) / 1000) : 0;

        const rankItem = document.createElement('div');
        rankItem.className = 'glass-morphism rounded-2xl p-6 flex items-center gap-6 bounce-in';
        rankItem.style.animationDelay = `${index * 0.1}s`;

        rankItem.innerHTML = `
            <div class="ranking-badge ${rankClass}">
                ${medal}
            </div>
            <div class="flex-1">
                <div class="text-2xl font-bold text-gray-800 dark:text-white">${team.teamName}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    ${team.totalScore} points ‚Ä¢ ${duration}s ‚Ä¢ ${team.stats.gamesWon}/${team.stats.gamesWon + team.stats.gamesLost} r√©ussis
                </div>
            </div>
            <div class="text-3xl">${rank === 1 ? 'üéâ' : rank === 2 ? 'üëè' : rank === 3 ? 'üëç' : '‚ú®'}</div>
        `;

        rankingList.appendChild(rankItem);
    });
}

// ==================== JOUEUR - COFFRES ====================

function renderBoxes() {
    const container = document.getElementById('boxes-container');
    container.innerHTML = '';

    boxesData.forEach((box, index) => {
        const isUnlocked = gameState.boxesUnlocked > index;
        const isCurrent = gameState.boxesUnlocked === index;

        const boxElement = document.createElement('div');
        boxElement.className = `${isUnlocked ? 'unlocked-box' : 'locked-box'} cursor-pointer transition-all duration-500 bounce-in`;
        boxElement.style.animationDelay = `${index * 0.1}s`;

        // Utiliser un coffre-fort pour les coffres pairs, un coffre au tr√©sor pour les impairs
        const chestType = index % 2 === 0 ? 'safe' : 'treasure';
        const colorObj = {
            from: box.color.includes('blue') ? '#3b82f6' :
                  box.color.includes('red') ? '#ef4444' :
                  box.color.includes('green') ? '#10b981' :
                  box.color.includes('yellow') ? '#f59e0b' :
                  box.color.includes('purple') ? '#a855f7' :
                  box.color.includes('pink') ? '#ec4899' :
                  box.color.includes('indigo') ? '#6366f1' : '#3b82f6',
            to: box.color.includes('blue') ? '#1d4ed8' :
                box.color.includes('red') ? '#b91c1c' :
                box.color.includes('green') ? '#047857' :
                box.color.includes('orange') ? '#c2410c' :
                box.color.includes('purple') ? '#7c3aed' :
                box.color.includes('pink') ? '#be123c' :
                box.color.includes('indigo') ? '#4338ca' : '#1d4ed8'
        };

        const svgIcon = chestType === 'safe' ? getSafeSVG(colorObj, !isUnlocked) : getTreasureChestSVG(colorObj, !isUnlocked);

        boxElement.innerHTML = `
            <div class="relative p-6 rounded-2xl bg-gradient-to-br ${box.color} shadow-2xl transform hover:scale-105 transition-all duration-300 ${isCurrent ? 'ring-4 ring-yellow-400 ring-opacity-75 animate-pulse' : ''}">
                <div class="text-center mb-4">
                    <div class="w-32 h-32 mx-auto mb-3 ${!isUnlocked && !isCurrent ? 'opacity-50 grayscale' : ''} ${isCurrent ? 'float' : ''}">
                        ${svgIcon}
                    </div>
                </div>
                <h3 class="text-xl font-bold text-white text-center mb-2">${box.title}</h3>
                <p class="text-sm text-white text-opacity-90 text-center mb-4">${box.subtitle}</p>
                ${isUnlocked ? '<div class="text-center text-white font-bold text-lg">‚úì D√âVERROUILL√â</div>' :
                 isCurrent ? '<div class="text-center text-white font-bold text-lg animate-pulse glow">üéØ CLIQUE ICI !</div>' :
                 '<div class="text-center text-white text-opacity-70">üîí Verrouill√©</div>'}
            </div>
        `;

        if (isCurrent || isUnlocked) {
            boxElement.addEventListener('click', () => {
                // V√©rifier si on est en pause AVANT de permettre de jouer
                const isPausedNow = gameState.boxesUnlocked % 2 === 0 && gameState.boxesUnlocked > 0 && gameState.boxesUnlocked < boxesData.length && !gameState.pauseLifted;

                if (isPausedNow && index === gameState.boxesUnlocked) {
                    // On est en pause et on essaie de cliquer sur le coffre suivant
                    console.log('üö´ Clic bloqu√© - En pause √† l\'√©tape', gameState.boxesUnlocked / 2);
                    playSound('wrong');
                    showCustomAlert('‚è∏Ô∏è Le jeu est en pause ! Attendez que le formateur reprenne le jeu.');
                    // Afficher l'√©cran de pause au cas o√π l'utilisateur serait revenu aux coffres manuellement
                    const stageNumber = gameState.boxesUnlocked / 2;
                    showStagePauseScreen(stageNumber);
                    return;
                }

                playSound('tick');
                createChestOpenEffect(boxElement); // Effet de particules !
                gameState.currentBoxIndex = index;
                gameState.currentGameIndex = 0;
                gameState.gameScore = 0;
                loadBoxGame();
            });
        }

        container.appendChild(boxElement);
    });

    updateBoxesDisplay();
}

function updateBoxesDisplay() {
    // Protections contre NaN
    const safeScore = isNaN(gameState.totalScore) ? 0 : gameState.totalScore;
    const safeBoxes = isNaN(gameState.boxesUnlocked) ? 0 : gameState.boxesUnlocked;

    console.log('üìä updateBoxesDisplay():', {
        totalScore: gameState.totalScore,
        boxesUnlocked: gameState.boxesUnlocked,
        safeScore: safeScore,
        safeBoxes: safeBoxes
    });

    document.getElementById('total-score-display').textContent = safeScore;
    document.getElementById('boxes-unlocked').textContent = `${safeBoxes}/${boxesData.length}`;
}

// ==================== CHARGER UN JEU ====================

function loadBoxGame() {
    const box = boxesData[gameState.currentBoxIndex];

    // S√©lectionner al√©atoirement un jeu parmi les variations disponibles
    const gameVariations = box.games[gameState.currentGameIndex];
    if (!gameVariations) {
        unlockBox();
        return;
    }

    // Si c'est un tableau de variations, en choisir une au hasard
    let game, variationIndex;
    if (Array.isArray(gameVariations)) {
        variationIndex = Math.floor(Math.random() * gameVariations.length);
        game = gameVariations[variationIndex];
    } else {
        variationIndex = 0;
        game = gameVariations;
    }

    // Stocker l'index de la variation pour pouvoir la recharger apr√®s reset
    gameState.currentVariationIndex = variationIndex;

    gameState.attempts = gameState.maxAttempts;
    gameState.timeLeft = game.timeLimit;
    gameState.currentAnswer = null;

    showScreen('game-screen');
    updateGameDisplay();

    const container = document.getElementById('current-game');
    container.className = 'glass-morphism rounded-3xl shadow-2xl p-6 md:p-8 bounce-in';

    document.getElementById('reset-answer-btn').classList.add('hidden');

    switch(game.type) {
        case 'quiz':
            renderQuiz(game, container);
            break;
        case 'true-false':
            renderTrueFalse(game, container);
            break;
        case 'quiz-illustrated':
            renderQuizIllustrated(game, container);
            break;
        case 'quiz-multi':
            renderQuizMulti(game, container);
            break;
        case 'matching':
            renderMatching(game, container);
            break;
        case 'sequence':
            renderSequence(game, container);
            break;
        case 'puzzle-text':
            renderPuzzleText(game, container);
            break;
        case 'draw':
            renderDraw(game, container);
            break;
        case 'image-puzzle':
            renderImagePuzzle(game, container);
            break;
        case 'video-quiz':
            renderVideoQuiz(game, container);
            break;
        case 'image-quiz':
            renderImageQuiz(game, container);
            break;
    }

    startTimer();
}

// ==================== RENDU DES JEUX ====================

// QUIZ SIMPLE
function renderQuiz(game, container) {
    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-6">${game.question}</h2>
        </div>
        <div id="quiz-options" class="space-y-4">
            ${game.options.map((option, index) => `
                <button class="quiz-option w-full text-left p-5 md:p-6 rounded-2xl border-3 border-gray-300 dark:border-gray-600 hover:border-primary hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 hover:text-white transition-all duration-300 text-base md:text-lg font-semibold text-gray-700 dark:text-gray-300 shadow-lg" data-index="${index}">
                    <span class="inline-block w-8 h-8 rounded-full bg-primary text-white text-center leading-8 mr-3 font-bold">${String.fromCharCode(65 + index)}</span>
                    ${option}
                </button>
            `).join('')}
        </div>
    `;

    document.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => {
            playSound('tick');
            gameState.currentAnswer = parseInt(btn.dataset.index);

            document.querySelectorAll('.quiz-option').forEach(b => {
                b.classList.remove('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white', 'scale-105', 'shadow-2xl');
                b.classList.add('border-gray-300', 'dark:border-gray-600');
            });

            btn.classList.remove('border-gray-300', 'dark:border-gray-600');
            btn.classList.add('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white', 'scale-105', 'shadow-2xl');

            document.getElementById('reset-answer-btn').classList.remove('hidden');
        });
    });

    setupValidation(() => {
        if (gameState.currentAnswer === null) {
            showCustomAlert('‚ö†Ô∏è Veuillez s√©lectionner une r√©ponse !');
            return false;
        }
        return gameState.currentAnswer === game.correctAnswer;
    });
}

// TRUE-FALSE (Vrai/Faux)
function renderTrueFalse(game, container) {
    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-8 text-center">${game.question}</h2>
        </div>
        <div id="true-false-options" class="grid grid-cols-2 gap-6 max-w-2xl mx-auto">
            <button class="true-false-option h-40 flex flex-col items-center justify-center p-6 rounded-3xl border-4 border-green-300 hover:border-green-500 hover:bg-gradient-to-br hover:from-green-500 hover:to-emerald-600 hover:text-white transition-all duration-300 text-xl font-bold text-gray-700 dark:text-gray-300 shadow-xl hover:scale-110 hover:shadow-2xl" data-index="0">
                <div class="text-6xl mb-3">‚úì</div>
                <div class="text-2xl">${game.options[0]}</div>
            </button>
            <button class="true-false-option h-40 flex flex-col items-center justify-center p-6 rounded-3xl border-4 border-red-300 hover:border-red-500 hover:bg-gradient-to-br hover:from-red-500 hover:to-pink-600 hover:text-white transition-all duration-300 text-xl font-bold text-gray-700 dark:text-gray-300 shadow-xl hover:scale-110 hover:shadow-2xl" data-index="1">
                <div class="text-6xl mb-3">‚úó</div>
                <div class="text-2xl">${game.options[1]}</div>
            </button>
        </div>
        ${game.explanation ? `<div class="mt-6 p-4 bg-blue-100 dark:bg-blue-900 dark:bg-opacity-30 rounded-xl text-sm text-gray-700 dark:text-gray-300 text-center opacity-0" id="explanation-text">üí° ${game.explanation}</div>` : ''}
    `;

    document.querySelectorAll('.true-false-option').forEach(btn => {
        btn.addEventListener('click', () => {
            playSound('tick');
            gameState.currentAnswer = parseInt(btn.dataset.index);

            document.querySelectorAll('.true-false-option').forEach(b => {
                b.classList.remove('scale-110', 'shadow-2xl', 'ring-4', 'ring-yellow-400');
            });

            btn.classList.add('scale-110', 'shadow-2xl', 'ring-4', 'ring-yellow-400');

            // NE PAS afficher l'explication ici - elle sera affich√©e apr√®s validation

            document.getElementById('reset-answer-btn').classList.remove('hidden');
        });
    });

    setupValidation(() => {
        if (gameState.currentAnswer === null) {
            showCustomAlert('‚ö†Ô∏è Veuillez s√©lectionner une r√©ponse !');
            return false;
        }

        const isCorrect = gameState.currentAnswer === game.correctAnswer;

        // Afficher l'explication APR√àS validation si elle existe et que la r√©ponse est correcte
        if (isCorrect && game.explanation) {
            setTimeout(() => {
                const explanation = document.getElementById('explanation-text');
                if (explanation) {
                    explanation.style.opacity = '1';
                    explanation.classList.add('bounce-in');
                }
            }, 500);
        }

        return isCorrect;
    });
}

// QUIZ ILLUSTR√â (Quiz avec illustration SVG - L'IMAGE S'AFFICHE APR√àS LA R√âPONSE)
function renderQuizIllustrated(game, container) {
    // Obtenir l'illustration SVG depuis la fonction
    const svgFunction = window[game.illustrationFunction];
    const illustrationHTML = svgFunction ? svgFunction() : '';

    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
        </div>

        <!-- Illustration SVG (cach√©e au d√©part) -->
        <div id="illustration-reveal" class="hidden mb-6 p-4 bg-gradient-to-br from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-700 rounded-2xl shadow-lg bounce-in">
            <div class="text-center mb-3 text-green-600 dark:text-green-400 font-bold text-xl">‚úì Bonne r√©ponse ! Voici l'illustration :</div>
            ${illustrationHTML}
        </div>

        <!-- Question -->
        <div class="mb-6">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">${game.question}</h2>
        </div>

        <div id="quiz-options" class="space-y-4">
            ${game.options.map((option, index) => `
                <button class="quiz-option w-full text-left p-4 md:p-5 rounded-2xl border-3 border-gray-300 dark:border-gray-600 hover:border-primary hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 hover:text-white transition-all duration-300 text-base md:text-lg font-semibold text-gray-700 dark:text-gray-300 shadow-lg" data-index="${index}">
                    <span class="inline-block w-8 h-8 rounded-full bg-primary text-white text-center leading-8 mr-3 font-bold">${String.fromCharCode(65 + index)}</span>
                    ${option}
                </button>
            `).join('')}
        </div>
    `;

    document.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => {
            playSound('tick');
            gameState.currentAnswer = parseInt(btn.dataset.index);

            document.querySelectorAll('.quiz-option').forEach(b => {
                b.classList.remove('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white', 'scale-105', 'shadow-2xl');
                b.classList.add('border-gray-300', 'dark:border-gray-600');
            });

            btn.classList.remove('border-gray-300', 'dark:border-gray-600');
            btn.classList.add('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white', 'scale-105', 'shadow-2xl');

            document.getElementById('reset-answer-btn').classList.remove('hidden');
        });
    });

    setupValidation(() => {
        if (gameState.currentAnswer === null) {
            showCustomAlert('‚ö†Ô∏è Veuillez s√©lectionner une r√©ponse !');
            return false;
        }
        const isCorrect = gameState.currentAnswer === game.correctAnswer;

        // Si bonne r√©ponse, afficher l'illustration
        if (isCorrect) {
            const illustrationDiv = document.getElementById('illustration-reveal');
            if (illustrationDiv) {
                illustrationDiv.classList.remove('hidden');
            }
        }

        return isCorrect;
    });
}

// QUIZ MULTI (reste du code dans le prochain message pour ne pas d√©passer la limite)
function renderQuizMulti(game, container) {
    const selectedAnswers = new Set();

    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-4">${game.question}</h2>
            <p class="text-sm text-orange-600 dark:text-orange-400 font-semibold">‚ö†Ô∏è Plusieurs r√©ponses correctes</p>
        </div>
        <div id="quiz-multi-options" class="space-y-4">
            ${game.options.map((option, index) => `
                <button class="quiz-multi-option w-full text-left p-5 md:p-6 rounded-2xl border-3 border-gray-300 dark:border-gray-600 hover:border-primary transition-all duration-300 text-base md:text-lg font-semibold text-gray-700 dark:text-gray-300 shadow-lg" data-index="${index}">
                    <span class="inline-block w-8 h-8 rounded-lg border-2 border-gray-400 text-center leading-7 mr-3 option-checkbox"></span>
                    ${option}
                </button>
            `).join('')}
        </div>
    `;

    document.querySelectorAll('.quiz-multi-option').forEach(btn => {
        btn.addEventListener('click', () => {
            playSound('tick');
            const index = parseInt(btn.dataset.index);

            if (selectedAnswers.has(index)) {
                selectedAnswers.delete(index);
                btn.classList.remove('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white');
                btn.querySelector('.option-checkbox').textContent = '';
            } else {
                selectedAnswers.add(index);
                btn.classList.add('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white');
                btn.querySelector('.option-checkbox').textContent = '‚úì';
            }

            gameState.currentAnswer = Array.from(selectedAnswers).sort((a, b) => a - b);
            document.getElementById('reset-answer-btn').classList.remove('hidden');
        });
    });

    setupValidation(() => {
        if (!gameState.currentAnswer || gameState.currentAnswer.length === 0) {
            showCustomAlert('‚ö†Ô∏è Veuillez s√©lectionner au moins une r√©ponse !');
            return false;
        }
        return JSON.stringify(gameState.currentAnswer) === JSON.stringify(game.correctAnswers.sort((a, b) => a - b));
    });
}

// APPARIEMENT (suite dans le prochain fichier si n√©cessaire - je vais condenser)
function renderMatching(game, container) {
    const shuffledRight = [...game.pairs.map((p, i) => ({ value: p.right, index: i }))].sort(() => Math.random() - 0.5);
    const matches = {};
    let selectedLeft = null;
    let selectedRight = null;

    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-4">${game.question}</h2>
            <p class="text-sm text-blue-600 dark:text-blue-400 font-semibold">üí° Cliquez gauche puis droite</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-6">
            <div id="left-column" class="space-y-3">
                ${game.pairs.map((pair, index) => `
                    <button class="matching-left-item matching-item w-full p-5 bg-gradient-to-r from-blue-400 to-blue-600 rounded-xl font-semibold text-white border-3 border-blue-300 shadow-lg hover:shadow-2xl transition-all" data-index="${index}">
                        ${pair.left}
                    </button>
                `).join('')}
            </div>
            <div id="right-column" class="space-y-3">
                ${shuffledRight.map((item) => `
                    <button class="matching-right-item matching-item w-full p-5 bg-gradient-to-r from-green-400 to-green-600 rounded-xl font-semibold text-white border-3 border-green-300 shadow-lg hover:shadow-2xl transition-all" data-index="${item.index}">
                        ${item.value}
                    </button>
                `).join('')}
            </div>
        </div>
        <div class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 rounded-xl p-6">
            <div class="font-bold text-gray-800 dark:text-white mb-3">üìù Associations :</div>
            <div id="matches-list" class="text-gray-700 dark:text-gray-300">Aucune</div>
        </div>
    `;

    function updateMatchesDisplay() {
        const matchesList = document.getElementById('matches-list');
        if (Object.keys(matches).length === 0) {
            matchesList.innerHTML = 'Aucune';
        } else {
            matchesList.innerHTML = Object.entries(matches).map(([leftIndex, rightIndex]) => {
                const leftValue = game.pairs[leftIndex].left;
                const rightValue = game.pairs[rightIndex].right;
                return `<div class="flex items-center gap-3 mb-2 p-3 bg-white dark:bg-gray-800 rounded-lg">
                    <span class="flex-1 font-semibold text-blue-600">${leftValue}</span>
                    <span class="text-2xl">‚Üí</span>
                    <span class="flex-1 font-semibold text-green-600">${rightValue}</span>
                    <button class="text-red-500 hover:text-red-700 font-bold" onclick="removeMatch(${leftIndex})">‚úï</button>
                </div>`;
            }).join('');
        }
    }

    window.removeMatch = (leftIndex) => {
        delete matches[leftIndex];
        document.querySelectorAll('.matching-left-item, .matching-right-item').forEach(btn => {
            btn.classList.remove('matched', 'opacity-50');
        });
        updateMatchesDisplay();
        gameState.currentAnswer = matches;
        playSound('tick');
    };

    document.querySelectorAll('.matching-left-item').forEach(btn => {
        btn.addEventListener('click', () => {
            playSound('tick');
            const index = parseInt(btn.dataset.index);
            if (matches[index]) return;

            document.querySelectorAll('.matching-left-item').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedLeft = index;

            if (selectedRight !== null) {
                matches[selectedLeft] = selectedRight;
                btn.classList.add('matched', 'opacity-50');
                document.querySelectorAll('.matching-right-item').forEach(b => {
                    if (parseInt(b.dataset.index) === selectedRight) b.classList.add('matched', 'opacity-50');
                    b.classList.remove('selected');
                });
                updateMatchesDisplay();
                gameState.currentAnswer = matches;
                selectedLeft = null;
                selectedRight = null;
                document.getElementById('reset-answer-btn').classList.remove('hidden');
            }
        });
    });

    document.querySelectorAll('.matching-right-item').forEach(btn => {
        btn.addEventListener('click', () => {
            playSound('tick');
            const index = parseInt(btn.dataset.index);
            if (Object.values(matches).includes(index)) return;

            document.querySelectorAll('.matching-right-item').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedRight = index;

            if (selectedLeft !== null) {
                matches[selectedLeft] = selectedRight;
                btn.classList.add('matched', 'opacity-50');
                document.querySelectorAll('.matching-left-item').forEach(b => {
                    if (parseInt(b.dataset.index) === selectedLeft) b.classList.add('matched', 'opacity-50');
                    b.classList.remove('selected');
                });
                updateMatchesDisplay();
                gameState.currentAnswer = matches;
                selectedLeft = null;
                selectedRight = null;
                document.getElementById('reset-answer-btn').classList.remove('hidden');
            }
        });
    });

    setupValidation(() => {
        if (Object.keys(matches).length < game.pairs.length) {
            showCustomAlert('‚ö†Ô∏è Compl√©tez toutes les associations !');
            return false;
        }
        // V√©rifier que chaque association gauche -> droite correspond bien
        // matches[leftIndex] donne rightIndex, il faut que ce soit le bon
        return game.pairs.every((pair, leftIndex) => {
            const rightIndex = matches[leftIndex];
            if (rightIndex === undefined) return false;
            // V√©rifier que l'√©l√©ment de droite correspond bien √† l'√©l√©ment de gauche
            return game.pairs[leftIndex].right === game.pairs[rightIndex].right;
        });
    });
}

// S√âQUENCE
function renderSequence(game, container) {
    const currentOrder = [...game.items.map((item, i) => i)].sort(() => Math.random() - 0.5);
    let selectedItems = [];

    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-4">${game.question}</h2>
            <p class="text-sm text-blue-600 dark:text-blue-400 font-semibold">üí° Cliquez dans le bon ordre</p>
        </div>
        <div id="sequence-items" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            ${currentOrder.map(index => `
                <button class="sequence-item p-6 bg-gradient-to-r from-indigo-400 to-purple-600 rounded-xl font-semibold text-white shadow-lg hover:shadow-2xl border-3 border-transparent" data-index="${index}">
                    ${game.items[index]}
                </button>
            `).join('')}
        </div>
        <div class="bg-gradient-to-r from-blue-100 to-purple-100 dark:from-blue-900 dark:to-purple-900 rounded-xl p-6">
            <div class="font-bold text-gray-800 dark:text-white mb-3">üìù Votre ordre :</div>
            <div id="sequence-order" class="text-gray-700 dark:text-gray-300">Cliquez...</div>
        </div>
    `;

    function updateSequenceDisplay() {
        const orderDiv = document.getElementById('sequence-order');
        if (selectedItems.length === 0) {
            orderDiv.innerHTML = 'Cliquez...';
        } else {
            orderDiv.innerHTML = selectedItems.map((index, position) =>
                `<div class="inline-block mr-3 mb-2 p-3 bg-white dark:bg-gray-800 rounded-lg shadow">
                    <span class="font-bold text-primary mr-2">${position + 1}.</span>
                    <span class="font-semibold">${game.items[index]}</span>
                </div>`
            ).join('');
        }
    }

    document.querySelectorAll('.sequence-item').forEach(btn => {
        btn.addEventListener('click', () => {
            const index = parseInt(btn.dataset.index);

            if (selectedItems.includes(index)) {
                const pos = selectedItems.indexOf(index);
                selectedItems.splice(pos, 1);
                btn.classList.remove('selected', 'opacity-50', 'border-yellow-400');
                btn.classList.add('border-transparent');
            } else {
                selectedItems.push(index);
                btn.classList.add('selected', 'opacity-50', 'border-yellow-400');
            }

            playSound('tick');
            updateSequenceDisplay();
            gameState.currentAnswer = selectedItems;

            if (selectedItems.length > 0) {
                document.getElementById('reset-answer-btn').classList.remove('hidden');
            }
        });
    });

    setupValidation(() => {
        if (selectedItems.length !== game.items.length) {
            showCustomAlert('‚ö†Ô∏è Ordonnez tous les √©l√©ments !');
            return false;
        }
        return JSON.stringify(selectedItems) === JSON.stringify(game.correctOrder);
    });
}

// PUZZLE
function renderPuzzleText(game, container) {
    const shuffledPieces = [...game.pieces.map((p, i) => ({ text: p, index: i }))].sort(() => Math.random() - 0.5);
    let placedPieces = Array(game.pieces.length).fill(null);

    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-4">${game.question}</h2>
        </div>
        <div class="mb-6">
            <div class="font-semibold text-gray-700 dark:text-gray-300 mb-3">Zone :</div>
            <div id="puzzle-target" class="space-y-3">
                ${game.pieces.map((_, index) => `
                    <div class="puzzle-slot min-h-16 p-4 border-3 border-dashed border-gray-400 rounded-xl flex items-center justify-center text-gray-400 font-semibold bg-gray-50 dark:bg-gray-800" data-slot="${index}">
                        Position ${index + 1}
                    </div>
                `).join('')}
            </div>
        </div>
        <div>
            <div class="font-semibold text-gray-700 dark:text-gray-300 mb-3">Pi√®ces :</div>
            <div id="puzzle-pieces" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                ${shuffledPieces.map((piece) => `
                    <div class="puzzle-piece cursor-pointer" data-piece-index="${piece.index}">
                        ${piece.text}
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    let selectedPiece = null;

    document.querySelectorAll('.puzzle-piece').forEach(piece => {
        piece.addEventListener('click', () => {
            if (piece.classList.contains('correct')) return;
            playSound('tick');
            document.querySelectorAll('.puzzle-piece').forEach(p => p.classList.remove('ring-4', 'ring-yellow-400'));
            piece.classList.add('ring-4', 'ring-yellow-400');
            selectedPiece = parseInt(piece.dataset.pieceIndex);
        });
    });

    document.querySelectorAll('.puzzle-slot').forEach(slot => {
        slot.addEventListener('click', () => {
            if (selectedPiece === null) {
                showCustomAlert('‚ö†Ô∏è S√©lectionnez une pi√®ce !');
                return;
            }

            const slotIndex = parseInt(slot.dataset.slot);

            if (placedPieces[slotIndex] !== null) {
                document.querySelectorAll('.puzzle-piece').forEach(p => {
                    if (parseInt(p.dataset.pieceIndex) === placedPieces[slotIndex]) {
                        p.classList.remove('correct', 'opacity-30');
                    }
                });
            }

            placedPieces[slotIndex] = selectedPiece;
            slot.innerHTML = `<div class="text-white font-semibold">${game.pieces[selectedPiece]}</div>`;
            slot.classList.remove('border-gray-400', 'bg-gray-50');
            slot.classList.add('bg-gradient-to-r', 'from-green-400', 'to-green-600', 'border-green-300');

            document.querySelectorAll('.puzzle-piece').forEach(p => {
                if (parseInt(p.dataset.pieceIndex) === selectedPiece) {
                    p.classList.add('correct', 'opacity-30');
                    p.classList.remove('ring-4', 'ring-yellow-400');
                }
            });

            playSound('success');
            selectedPiece = null;
            gameState.currentAnswer = placedPieces;
            document.getElementById('reset-answer-btn').classList.remove('hidden');
        });
    });

    setupValidation(() => {
        if (placedPieces.includes(null)) {
            showCustomAlert('‚ö†Ô∏è Placez toutes les pi√®ces !');
            return false;
        }
        return placedPieces.every((piece, index) => piece === game.correctOrder[index]);
    });
}

// DESSIN
function renderDraw(game, container) {
    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-4">${game.question}</h2>
        </div>
        <div class="mb-4 flex gap-3 flex-wrap">
            <button id="color-black" class="w-12 h-12 bg-black rounded-full border-4 border-gray-300 hover:scale-110 transition-all"></button>
            <button id="color-red" class="w-12 h-12 bg-red-500 rounded-full border-4 border-gray-300 hover:scale-110 transition-all"></button>
            <button id="color-blue" class="w-12 h-12 bg-blue-500 rounded-full border-4 border-gray-300 hover:scale-110 transition-all"></button>
            <button id="clear-canvas" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">üóëÔ∏è Effacer</button>
        </div>
        <canvas id="draw-canvas" class="draw-canvas w-full" width="800" height="500"></canvas>
    `;

    const canvas = document.getElementById('draw-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let currentColor = '#000000';

    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);
        ctx.lineTo(x, y);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.stroke();
        gameState.currentAnswer = true;
        document.getElementById('reset-answer-btn').classList.remove('hidden');
    }

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);

    // Touch support
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
        const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
        ctx.beginPath();
        ctx.moveTo(x, y);
        isDrawing = true;
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
        const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
        ctx.lineTo(x, y);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.stroke();
    });

    canvas.addEventListener('touchend', () => isDrawing = false);

    document.getElementById('color-black').addEventListener('click', () => { currentColor = '#000000'; playSound('tick'); });
    document.getElementById('color-red').addEventListener('click', () => { currentColor = '#FF0000'; playSound('tick'); });
    document.getElementById('color-blue').addEventListener('click', () => { currentColor = '#0000FF'; playSound('tick'); });
    document.getElementById('clear-canvas').addEventListener('click', () => {
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        gameState.currentAnswer = null;
        playSound('tick');
    });

    setupValidation(() => {
        if (!gameState.currentAnswer) {
            showCustomAlert('‚ö†Ô∏è Dessinez quelque chose !');
            return false;
        }
        return true;
    });
}

// IMAGE PUZZLE (Puzzle d'image √† reconstituer)
function renderImagePuzzle(game, container) {
    // Obtenir l'illustration SVG
    const svgFunction = window[game.illustrationFunction];
    const fullImageHTML = svgFunction ? svgFunction() : '';

    // Cr√©er les pi√®ces du puzzle (grille 3x3 = 9 pi√®ces)
    const gridSize = game.gridSize || 3; // 3x3 par d√©faut
    const totalPieces = gridSize * gridSize;

    // M√©langer les positions
    const positions = Array.from({length: totalPieces}, (_, i) => i);
    const shuffledPositions = positions.sort(() => Math.random() - 0.5);

    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white mb-4 text-center">${game.question}</h2>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-4">üí° Cliquez sur 2 pi√®ces pour les √©changer</p>
        </div>

        <!-- Image de r√©f√©rence (mini) -->
        <div class="mb-6 flex justify-center">
            <button id="toggle-hint" class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-lg font-semibold hover:from-yellow-600 hover:to-orange-600 transition-all shadow-lg">
                üí° Voir l'image compl√®te
            </button>
        </div>

        <div id="hint-container" class="hidden mb-6 p-4 bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-gray-800 dark:to-gray-700 rounded-2xl shadow-lg">
            <div class="max-w-sm mx-auto opacity-60">
                ${fullImageHTML}
            </div>
        </div>

        <!-- Grille de puzzle -->
        <div id="puzzle-grid" class="grid gap-2 max-w-2xl mx-auto mb-4" style="grid-template-columns: repeat(${gridSize}, 1fr);">
            ${shuffledPositions.map((position, index) => `
                <div class="puzzle-tile cursor-pointer border-4 border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden hover:border-primary transition-all duration-200 bg-white dark:bg-gray-800 aspect-square relative"
                     data-current-pos="${index}"
                     data-correct-pos="${position}"
                     style="min-height: 80px;">
                    <div class="absolute inset-0 flex items-center justify-center p-2">
                        <div class="puzzle-piece-content transform scale-[${gridSize}] origin-center" style="transform: translate(${-(position % gridSize) * 100}%, ${-Math.floor(position / gridSize) * 100}%);">
                            ${fullImageHTML}
                        </div>
                    </div>
                    <div class="absolute top-1 right-1 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">${index + 1}</div>
                </div>
            `).join('')}
        </div>

        <div class="text-center">
            <button id="check-puzzle" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold hover:from-green-600 hover:to-emerald-700 transition-all shadow-lg text-lg">
                ‚úì V√©rifier le puzzle
            </button>
        </div>
    `;

    let selectedTile = null;
    const tiles = document.querySelectorAll('.puzzle-tile');

    // Toggle hint
    document.getElementById('toggle-hint').addEventListener('click', () => {
        const hintContainer = document.getElementById('hint-container');
        hintContainer.classList.toggle('hidden');
        playSound('tick');
    });

    // Gestion des clics sur les pi√®ces
    tiles.forEach(tile => {
        tile.addEventListener('click', () => {
            playSound('tick');

            if (selectedTile === null) {
                // Premi√®re s√©lection
                selectedTile = tile;
                tile.classList.add('ring-4', 'ring-yellow-400', 'scale-105');
            } else if (selectedTile === tile) {
                // D√©s√©lection
                tile.classList.remove('ring-4', 'ring-yellow-400', 'scale-105');
                selectedTile = null;
            } else {
                // √âchange des pi√®ces
                const pos1 = selectedTile.dataset.correctPos;
                const pos2 = tile.dataset.correctPos;

                selectedTile.dataset.correctPos = pos2;
                tile.dataset.correctPos = pos1;

                // √âchanger visuellement le contenu
                const content1 = selectedTile.querySelector('.puzzle-piece-content').innerHTML;
                const content2 = tile.querySelector('.puzzle-piece-content').innerHTML;

                selectedTile.querySelector('.puzzle-piece-content').innerHTML = content2;
                tile.querySelector('.puzzle-piece-content').innerHTML = content1;

                // Mise √† jour des styles de transformation
                const gridSize = game.gridSize || 3;
                selectedTile.querySelector('.puzzle-piece-content').style.transform =
                    `translate(${-(parseInt(pos2) % gridSize) * 100}%, ${-Math.floor(parseInt(pos2) / gridSize) * 100}%)`;
                tile.querySelector('.puzzle-piece-content').style.transform =
                    `translate(${-(parseInt(pos1) % gridSize) * 100}%, ${-Math.floor(parseInt(pos1) / gridSize) * 100}%)`;

                selectedTile.classList.remove('ring-4', 'ring-yellow-400', 'scale-105');
                selectedTile = null;
            }
        });
    });

    // V√©rification du puzzle
    document.getElementById('check-puzzle').addEventListener('click', () => {
        playSound('tick');
        let isCorrect = true;

        tiles.forEach(tile => {
            const currentPos = parseInt(tile.dataset.currentPos);
            const correctPos = parseInt(tile.dataset.correctPos);

            if (currentPos !== correctPos) {
                isCorrect = false;
            }
        });

        if (isCorrect) {
            gameState.currentAnswer = true;
            tiles.forEach(tile => {
                tile.classList.add('border-green-500', 'border-4');
            });
            playSound('success');
            setTimeout(() => validateAnswer(true), 500);
        } else {
            showCustomAlert('‚ùå Pas tout √† fait ! Continuez √† √©changer les pi√®ces.');
            playSound('error');
        }
    });

    setupValidation(() => {
        return gameState.currentAnswer === true;
    });
}

// VIDEO QUIZ (avec vid√©o YouTube int√©gr√©e)
function renderVideoQuiz(game, container) {
    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-6">${game.question}</h2>
        </div>
        ${game.videoUrl ? `
            <div class="mb-6">
                <div class="relative aspect-video rounded-xl overflow-hidden shadow-2xl">
                    <iframe class="w-full h-full" src="${game.videoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>
        ` : ''}
        <div id="quiz-options" class="space-y-4">
            ${game.options.map((option, index) => `
                <button class="quiz-option w-full text-left p-5 md:p-6 rounded-2xl border-3 border-gray-300 dark:border-gray-600 hover:border-primary hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 hover:text-white transition-all duration-300 text-base md:text-lg font-semibold text-gray-700 dark:text-gray-300 shadow-lg" data-index="${index}">
                    <span class="inline-block w-8 h-8 rounded-full bg-primary text-white text-center leading-8 mr-3 font-bold">${String.fromCharCode(65 + index)}</span>
                    ${option}
                </button>
            `).join('')}
        </div>
    `;

    document.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => {
            playSound('tick');
            gameState.currentAnswer = parseInt(btn.dataset.index);

            document.querySelectorAll('.quiz-option').forEach(b => {
                b.classList.remove('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white', 'scale-105', 'shadow-2xl');
                b.classList.add('border-gray-300', 'dark:border-gray-600');
            });

            btn.classList.remove('border-gray-300', 'dark:border-gray-600');
            btn.classList.add('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white', 'scale-105', 'shadow-2xl');

            document.getElementById('reset-answer-btn').classList.remove('hidden');
        });
    });

    setupValidation(() => {
        if (gameState.currentAnswer === null) {
            showCustomAlert('‚ö†Ô∏è Veuillez s√©lectionner une r√©ponse !');
            return false;
        }
        return gameState.currentAnswer === game.correctAnswer;
    });
}

// IMAGE QUIZ (avec image)
function renderImageQuiz(game, container) {
    container.innerHTML = `
        <div class="mb-6">
            <div class="inline-block px-4 py-2 bg-gradient-to-r ${boxesData[gameState.currentBoxIndex].color} text-white rounded-full text-sm font-bold mb-3">${game.title}</div>
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-6">${game.question}</h2>
        </div>
        ${game.imageData ? `
            <div class="mb-6 flex justify-center">
                <div class="max-w-2xl rounded-xl overflow-hidden shadow-2xl border-4 border-primary">
                    <img src="${game.imageData}" alt="Question image" class="w-full h-auto">
                </div>
            </div>
        ` : ''}
        <div id="quiz-options" class="space-y-4">
            ${game.options.map((option, index) => `
                <button class="quiz-option w-full text-left p-5 md:p-6 rounded-2xl border-3 border-gray-300 dark:border-gray-600 hover:border-primary hover:bg-gradient-to-r hover:from-primary hover:to-purple-600 hover:text-white transition-all duration-300 text-base md:text-lg font-semibold text-gray-700 dark:text-gray-300 shadow-lg" data-index="${index}">
                    <span class="inline-block w-8 h-8 rounded-full bg-primary text-white text-center leading-8 mr-3 font-bold">${String.fromCharCode(65 + index)}</span>
                    ${option}
                </button>
            `).join('')}
        </div>
    `;

    document.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => {
            playSound('tick');
            gameState.currentAnswer = parseInt(btn.dataset.index);

            document.querySelectorAll('.quiz-option').forEach(b => {
                b.classList.remove('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white', 'scale-105', 'shadow-2xl');
                b.classList.add('border-gray-300', 'dark:border-gray-600');
            });

            btn.classList.remove('border-gray-300', 'dark:border-gray-600');
            btn.classList.add('border-primary', 'bg-gradient-to-r', 'from-primary', 'to-purple-600', 'text-white', 'scale-105', 'shadow-2xl');

            document.getElementById('reset-answer-btn').classList.remove('hidden');
        });
    });

    setupValidation(() => {
        if (gameState.currentAnswer === null) {
            showCustomAlert('‚ö†Ô∏è Veuillez s√©lectionner une r√©ponse !');
            return false;
        }
        return gameState.currentAnswer === game.correctAnswer;
    });
}

// ==================== VALIDATION ====================

function setupValidation(validateFunction) {
    document.getElementById('validate-btn').onclick = () => {
        const isCorrect = validateFunction();
        if (isCorrect !== false) {
            validateAnswer(isCorrect);
        }
    };

    document.getElementById('reset-answer-btn').onclick = () => {
        playSound('tick');
        gameState.currentAnswer = null;
        // Recharger la M√äME question (m√™me variation)
        const box = boxesData[gameState.currentBoxIndex];
        const gameVariations = box.games[gameState.currentGameIndex];

        // Utiliser currentVariationIndex pour charger la M√äME variation
        const game = Array.isArray(gameVariations)
            ? gameVariations[gameState.currentVariationIndex]
            : gameVariations;

        // R√©initialiser le temps et les tentatives pour cette question
        gameState.timeLeft = game.timeLimit;
        gameState.attempts = gameState.maxAttempts;

        // Recharger l'interface de jeu
        const container = document.getElementById('current-game');
        container.className = 'glass-morphism rounded-3xl shadow-2xl p-6 md:p-8 bounce-in';
        document.getElementById('reset-answer-btn').classList.add('hidden');

        // Recharger le m√™me type de jeu
        switch(game.type) {
            case 'quiz': renderQuiz(game, container); break;
            case 'true-false': renderTrueFalse(game, container); break;
            case 'quiz-illustrated': renderQuizIllustrated(game, container); break;
            case 'quiz-multi': renderQuizMulti(game, container); break;
            case 'matching': renderMatching(game, container); break;
            case 'sequence': renderSequence(game, container); break;
            case 'puzzle-text': renderPuzzleText(game, container); break;
            case 'draw': renderDraw(game, container); break;
            case 'image-puzzle': renderImagePuzzle(game, container); break;
            case 'video-quiz': renderVideoQuiz(game, container); break;
            case 'image-quiz': renderImageQuiz(game, container); break;
        }

        updateGameDisplay();
        startTimer();
    };
}

// Fonction helper pour obtenir la bonne r√©ponse format√©e selon le type de jeu
function getCorrectAnswerText(game) {
    if (game.type === 'quiz' || game.type === 'true-false') {
        return `<div class="text-lg"><strong>Bonne r√©ponse :</strong> ${game.options[game.correctAnswer]}</div>`;
    } else if (game.type === 'quiz-multi') {
        const correctOpts = game.correctAnswers.map(i => game.options[i]).join(', ');
        return `<div class="text-lg"><strong>Bonnes r√©ponses :</strong> ${correctOpts}</div>`;
    } else if (game.type === 'sequence' || game.type === 'puzzle-text') {
        const correctSeq = game.correctOrder.map(i => game.items ? game.items[i] : game.pieces[i]).join(' ‚Üí ');
        return `<div class="text-lg"><strong>Ordre correct :</strong><br>${correctSeq}</div>`;
    } else if (game.type === 'matching') {
        const pairs = game.pairs.map(p => `${p.left} ‚Üî ${p.right}`).join('<br>');
        return `<div class="text-lg"><strong>Bonnes associations :</strong><br>${pairs}</div>`;
    } else if (game.type === 'draw') {
        return `<div class="text-lg"><strong>Dessin valid√©</strong></div>`;
    }
    return '';
}

function validateAnswer(isCorrect) {
    stopTimer();

    // R√©cup√©rer le jeu actuel AVANT toute modification
    const box = boxesData[gameState.currentBoxIndex];
    const gameVariations = box.games[gameState.currentGameIndex];
    const currentGame = Array.isArray(gameVariations) ?
        gameVariations[0] : gameVariations; // Prendre le premier pour afficher la r√©ponse

    if (isCorrect) {
        playSound('bravo'); // Son "bravo" au lieu de "success"

        // PROTECTION: S'assurer que currentGame.timeLimit et currentGame.points existent
        const timeLimit = currentGame.timeLimit || 60;
        const basePoints = currentGame.points || 100;

        // Calcul progressif des points
        // 1. Bonus de temps (0-50 points): plus c'est rapide, plus c'est de points
        const timeBonus = Math.floor((gameState.timeLeft / timeLimit) * 50);

        // 2. Bonus d'essais (0-50 points): points en fonction des tentatives restantes
        // 3 essais restants = 50pts, 2 essais = 30pts, 1 essai = 10pts, 0 essai = 0pts
        const attemptsBonus = gameState.attempts === 3 ? 50 :
                             gameState.attempts === 2 ? 30 :
                             gameState.attempts === 1 ? 10 : 0;

        // Total des points
        const points = basePoints + timeBonus + attemptsBonus;

        console.log('üîç CALCUL DES POINTS:', {
            gameType: currentGame.type,
            basePoints: basePoints,
            timeLeft: gameState.timeLeft,
            timeLimit: timeLimit,
            attemptsLeft: gameState.attempts,
            timeBonus: timeBonus,
            attemptsBonus: attemptsBonus,
            totalPoints: points
        });

        gameState.gameScore += points;
        gameState.totalScore += points;
        gameState.stats.gamesWon++;
        gameState.stats.totalTime += (timeLimit - gameState.timeLeft);

        // DEBUG: Afficher le score apr√®s ajout
        console.log('‚úÖ Points ajout√©s:', {
            points: points,
            totalScore: gameState.totalScore,
            boxesUnlocked: gameState.boxesUnlocked
        });

        createConfetti();

        // 1. Afficher d'abord un message simple
        showFeedback(`‚úì Bonne r√©ponse !`, 'success');

        // 2. Attendre 2.5s puis afficher l'explication pendant 5 secondes
        setTimeout(() => {
            if (currentGame.explanation) {
                const correctAnswerHTML = getCorrectAnswerText(currentGame);
                const explanationHTML = `
                    ${correctAnswerHTML}
                    ${currentGame.explanation ? `<div class="mt-4 text-base leading-relaxed">${currentGame.explanation}</div>` : ''}
                `;
                showFeedbackWithAnswer(`üìñ Explication`, explanationHTML, 'success');
            }
        }, 2500);

        // 3. Attendre 7.5s (2.5 + 5) puis afficher le panneau de points simple
        setTimeout(() => {
            showFeedback(`üéâ +${points} points !`, 'success');
        }, 7500);

        // 4. Charger le prochain jeu apr√®s 10 secondes total (2.5 + 5 + 2.5)
        setTimeout(() => {
            gameState.currentGameIndex++;
            loadBoxGame();
        }, 10000);
    } else {
        playSound('wrong'); // Son "wrong" au lieu de "error"
        gameState.attempts--;
        document.getElementById('current-game').classList.add('shake');
        setTimeout(() => document.getElementById('current-game').classList.remove('shake'), 500);

        if (gameState.attempts > 0) {
            showFeedback(`‚úó Incorrect ! ${gameState.attempts} essai(s) restant(s)`, 'error');
            updateGameDisplay();
            gameState.currentAnswer = null;
            startTimer();
        } else {
            // Afficher la bonne r√©ponse apr√®s √©chec
            gameState.stats.gamesLost++;
            const correctAnswerHTML = getCorrectAnswerText(currentGame);
            showFeedbackWithAnswer(`‚úó √âchec ! Jeu suivant...`, correctAnswerHTML, 'error');
            setTimeout(() => {
                gameState.currentGameIndex++;
                loadBoxGame();
            }, 5000); // Plus de temps pour lire la r√©ponse
        }
    }
}

function showFeedback(message, type) {
    const feedback = document.createElement('div');
    feedback.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-10 py-8 rounded-3xl text-white text-2xl md:text-3xl font-bold shadow-2xl z-50 bounce-in ${type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-pink-600'}`;
    feedback.innerHTML = message; // Chang√© de textContent √† innerHTML pour supporter le HTML
    document.body.appendChild(feedback);
    setTimeout(() => feedback.remove(), 2500);
}

function showFeedbackWithAnswer(message, answerHTML, type) {
    const feedback = document.createElement('div');
    feedback.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-10 py-8 rounded-3xl text-white text-xl md:text-2xl font-bold shadow-2xl z-50 bounce-in max-w-2xl ${type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600' : 'bg-gradient-to-r from-red-500 to-pink-600'}`;
    feedback.innerHTML = `
        <div class="mb-4 text-3xl">${message}</div>
        <div class="mt-4 p-4 bg-white bg-opacity-20 rounded-xl text-base text-left">
            ${answerHTML}
        </div>
    `;
    document.body.appendChild(feedback);
    setTimeout(() => feedback.remove(), 5000);
}

function unlockBox() {
    stopTimer();
    const boxIndex = gameState.currentBoxIndex;
    playSound('unlock', boxSoundFrequencies[boxIndex]);
    createConfetti();

    const box = boxesData[boxIndex];
    showFeedback(`üîì ${box.title} d√©verrouill√© !`, 'success');

    gameState.boxesUnlocked++;

    // R√©initialiser le flag de pause lev√©e (pour la prochaine pause)
    gameState.pauseLifted = false;

    // DEBUG: Afficher l'√©tat apr√®s d√©verrouillage
    console.log('üîì Coffre d√©verrouill√©:', {
        boxIndex: boxIndex,
        boxesUnlocked: gameState.boxesUnlocked,
        totalScore: gameState.totalScore
    });

    broadcastUpdate();

    // V√©rifier si on doit mettre en pause apr√®s 2 coffres (√©tapes de 2 coffres)
    const shouldPause = gameState.boxesUnlocked % 2 === 0 && gameState.boxesUnlocked < boxesData.length;

    console.log('üîç V√©rification pause:', {
        boxesUnlocked: gameState.boxesUnlocked,
        modulo: gameState.boxesUnlocked % 2,
        totalBoxes: boxesData.length,
        shouldPause: shouldPause
    });

    // Si on doit se mettre en pause, le faire imm√©diatement apr√®s 1 seconde (pour laisser le temps de voir le message de succ√®s)
    // Sinon, attendre 3 secondes comme d'habitude
    const delay = shouldPause ? 1000 : 3000;

    setTimeout(() => {
        if (gameState.boxesUnlocked >= boxesData.length) {
            console.log('üèÅ Fin du jeu - tous les coffres d√©verrouill√©s');
            endGame();
        } else if (shouldPause) {
            // Mise en pause automatique apr√®s 2 coffres
            const stageNumber = gameState.boxesUnlocked / 2;
            console.log(`‚è∏Ô∏è AFFICHAGE √âCRAN DE PAUSE - √âtape ${stageNumber}`);
            showStagePauseScreen(stageNumber);
        } else {
            console.log('üì¶ Retour √† l\'√©cran des coffres');
            showScreen('boxes-screen');
            renderBoxes();
        }
    }, delay);
}

// V√©rifier si cette √©quipe est la premi√®re √† compl√©ter cette √©tape
function checkAndTriggerStagePause(stageNumber) {
    if (!database) {
        console.error('‚ùå Firebase non disponible, impossible de synchroniser les √©tapes');
        return;
    }

    const stagePath = `sessions/${sessionId}/stages/stage${stageNumber}`;
    console.log(`üìù √âcriture dans Firebase: ${stagePath}`);

    const stageRef = database.ref(stagePath);

    stageRef.transaction((currentData) => {
        console.log('üîÑ Transaction Firebase - donn√©es actuelles:', currentData);

        if (currentData === null) {
            // Personne n'a encore compl√©t√© cette √©tape, on est les premiers !
            const newData = {
                firstTeam: currentTeamName,
                firstTeamTime: Date.now(),
                paused: true
            };
            console.log('‚úçÔ∏è √âcriture des nouvelles donn√©es:', newData);
            return newData;
        }
        // Quelqu'un d'autre a d√©j√† compl√©t√© cette √©tape
        console.log('‚è≠Ô∏è √âtape d√©j√† compl√©t√©e par une autre √©quipe, transaction annul√©e');
        return undefined; // Annuler la transaction
    }, (error, committed, snapshot) => {
        if (error) {
            console.error('‚ùå Erreur lors de la v√©rification de l\'√©tape:', error);
        } else if (committed) {
            // On est les premiers ! Afficher un message sp√©cial
            console.log(`üèÜ Transaction r√©ussie ! Premi√®re √©quipe √† compl√©ter l'√©tape ${stageNumber} !`);
            console.log('üìä Donn√©es √©crites dans Firebase:', snapshot.val());
            showFeedback(`üèÜ Premi√®re √©quipe √† compl√©ter l'√©tape ${stageNumber} !`, 'success');

            // Mettre le jeu en pause localement
            gamePaused = true;
            currentStage = stageNumber;
        } else {
            console.log(`‚è≠Ô∏è Une autre √©quipe a d√©j√† compl√©t√© l'√©tape ${stageNumber}`);
        }
    });
}

// ==================== TIMER ====================

function startTimer() {
    stopTimer();

    gameState.timerInterval = setInterval(() => {
        gameState.timeLeft--;
        updateGameDisplay();

        if (gameState.timeLeft <= 10) {
            playSound('countdown');
            document.getElementById('timer-display').classList.add('timer-critical');
        }

        if (gameState.timeLeft <= 0) {
            stopTimer();
            gameState.attempts--;

            if (gameState.attempts > 0) {
                playSound('wrong');
                showFeedback(`‚è∞ Temps √©coul√© ! ${gameState.attempts} essai(s)`, 'error');
                const box = boxesData[gameState.currentBoxIndex];
                const gameVariations = box.games[gameState.currentGameIndex];
                const game = Array.isArray(gameVariations) ? gameVariations[0] : gameVariations;
                gameState.timeLeft = game.timeLimit;
                gameState.currentAnswer = null;
                updateGameDisplay();
                startTimer();
            } else {
                playSound('error');
                gameState.stats.gamesLost++;
                // Afficher la bonne r√©ponse apr√®s temps √©coul√©
                const box = boxesData[gameState.currentBoxIndex];
                const gameVariations = box.games[gameState.currentGameIndex];
                const game = Array.isArray(gameVariations) ? gameVariations[0] : gameVariations;
                const correctAnswerHTML = getCorrectAnswerText(game);
                showFeedbackWithAnswer('‚è∞ Temps √©coul√© ! Jeu suivant...', correctAnswerHTML, 'error');
                setTimeout(() => {
                    gameState.currentGameIndex++;
                    loadBoxGame();
                }, 5000);
            }
        }
    }, 1000);
}

function stopTimer() {
    if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
    }
    document.getElementById('timer-display').classList.remove('timer-critical');
}

function updateGameDisplay() {
    document.getElementById('game-score-display').textContent = gameState.totalScore;
    document.getElementById('timer-display').textContent = gameState.timeLeft;
    document.getElementById('attempts-display').textContent = '‚ù§Ô∏è'.repeat(gameState.attempts) + 'üñ§'.repeat(gameState.maxAttempts - gameState.attempts);
}

// ==================== √âCRAN DE PAUSE D'√âTAPE ====================

function showStagePauseScreen(stageNumber) {
    stopTimer();
    playSound('complete');

    console.log(`‚è∏Ô∏è Pause automatique apr√®s l'√©tape ${stageNumber} (${gameState.boxesUnlocked} coffres d√©verrouill√©s)`);

    // Afficher l'√©cran de pause
    showScreen('stage-pause-screen');

    // Mettre √† jour les informations de l'√©tape
    document.getElementById('stage-number').textContent = stageNumber;
    document.getElementById('stage-score').textContent = gameState.totalScore || 0;
    document.getElementById('stage-boxes-unlocked').textContent = gameState.boxesUnlocked || 0;
    document.getElementById('stage-boxes-remaining').textContent = (boxesData.length - gameState.boxesUnlocked) || 0;
}

function updateStageRankings(stageNumber) {
    if (!sessionId || !database) return;

    const rankingsList = document.getElementById('stage-rankings-list');
    rankingsList.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Chargement du classement...</div>';

    database.ref('teams').once('value', (snapshot) => {
        const allTeams = snapshot.val() || {};
        const teamsArray = [];

        // Filtrer les √©quipes qui ont compl√©t√© cette √©tape (stageNumber * 2 coffres)
        const requiredBoxes = stageNumber * 2;

        Object.keys(allTeams).forEach(teamKey => {
            const team = allTeams[teamKey];
            if (team.sessionId === sessionId && team.boxesUnlocked >= requiredBoxes) {
                teamsArray.push({
                    name: team.teamName,
                    score: team.totalScore,
                    boxesUnlocked: team.boxesUnlocked,
                    completedStageAt: team.lastUpdate || 0
                });
            }
        });

        // Trier par score d√©croissant
        teamsArray.sort((a, b) => b.score - a.score);

        // Afficher le classement
        if (teamsArray.length === 0) {
            rankingsList.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Aucune √©quipe n\'a encore compl√©t√© cette √©tape.</div>';
            return;
        }

        rankingsList.innerHTML = '';
        teamsArray.forEach((team, index) => {
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
            const rankingItem = document.createElement('div');
            rankingItem.className = `flex justify-between items-center p-4 rounded-lg ${
                index === 0 ? 'bg-yellow-100 dark:bg-yellow-900' :
                index === 1 ? 'bg-gray-100 dark:bg-gray-700' :
                index === 2 ? 'bg-orange-100 dark:bg-orange-900' :
                'bg-gray-50 dark:bg-gray-800'
            }`;
            rankingItem.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${medal}</span>
                    <span class="font-semibold text-gray-800 dark:text-white">${team.name}</span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-lg font-bold text-primary">${team.score} pts</span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">${team.boxesUnlocked}/8 coffres</span>
                </div>
            `;
            rankingsList.appendChild(rankingItem);
        });
    });
}

// ==================== FIN DE JEU ====================

function endGame() {
    stopTimer();
    playSound('complete');
    createConfetti();

    gameState.stats.endTime = Date.now();
    broadcastUpdate();

    showScreen('end-screen');
    document.getElementById('final-score').textContent = gameState.totalScore;

    const avgTime = gameState.stats.gamesWon > 0 ? Math.round(gameState.stats.totalTime / gameState.stats.gamesWon) : 0;

    document.getElementById('final-stats').innerHTML = `
        <div class="glass-morphism p-6 rounded-2xl border-2 border-green-400">
            <div class="text-5xl font-bold text-green-600 dark:text-green-400 mb-2">${gameState.stats.gamesWon}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 font-semibold">Jeux r√©ussis</div>
        </div>
        <div class="glass-morphism p-6 rounded-2xl border-2 border-red-400">
            <div class="text-5xl font-bold text-red-600 dark:text-red-400 mb-2">${gameState.stats.gamesLost}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 font-semibold">Jeux rat√©s</div>
        </div>
        <div class="glass-morphism p-6 rounded-2xl border-2 border-blue-400">
            <div class="text-5xl font-bold text-blue-600 dark:text-blue-400 mb-2">${avgTime}s</div>
            <div class="text-sm text-gray-600 dark:text-gray-400 font-semibold">Temps moyen</div>
        </div>
    `;
}

// ==================== UTILITAIRES ====================

function showCustomAlert(message) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="glass-morphism p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 bounce-in border-2 border-primary">
            <p class="text-gray-700 dark:text-gray-300 mb-6 text-center text-xl font-semibold">${message}</p>
            <button class="w-full px-6 py-4 bg-gradient-to-r from-primary to-purple-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all" onclick="this.closest('.fixed').remove()">OK</button>
        </div>
    `;
    document.body.appendChild(modal);
    playSound('tick');
}

function showConfirmDialog(message, onConfirm) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="glass-morphism p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 bounce-in border-2 border-orange-500">
            <p class="text-gray-700 dark:text-gray-300 mb-6 text-center text-xl font-semibold">${message}</p>
            <div class="flex gap-3">
                <button class="flex-1 px-6 py-4 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all" onclick="this.closest('.fixed').remove()">Annuler</button>
                <button id="confirm-btn" class="flex-1 px-6 py-4 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all">Confirmer</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    playSound('tick');

    // Ajouter l'√©v√©nement de confirmation
    modal.querySelector('#confirm-btn').addEventListener('click', () => {
        modal.remove();
        onConfirm();
    });
}
</script></body></html>
